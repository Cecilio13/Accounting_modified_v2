<?php

namespace App\Http\Controllers;
use App\Clients;
use Illuminate\Support\Facades\Config;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Mail;
use Auth;
use Hash;
use PDF;
use App\User;
use App\Company;
use App\Sales;
use App\Expenses;
use App\Advance;
use App\Customers;
use App\ProductsAndServices;
USE App\SalesTransaction;
use App\Supplier;
use App\JournalEntry;
use App\Formstyle;
use App\Report;
use App\AuditLog;
use App\Voucher;
use DateTime;
use DatePeriod;
use DateInterval;
use App\StInvoice;
use App\StCreditNote;
use App\StSalesReceipt;
use App\ChartofAccount;
use App\Numbering;
use App\CostCenter;
use App\Budgets;
use App\StInvoiceEdit;
use App\SalesTransactionEdit;
use App\StCreditNoteEdit;
use App\UserClientAccess;
class ReportController extends Controller
{
    public function __construct()
    {
        $this->middleware(function ($request, $next) {
            $db_name="accounting_modified";
            if (Auth::check()) {
                if(Auth::user()->clnt_db_id!=""){
                    $client= Clients::find(Auth::user()->clnt_db_id);
                    $db_name="accounting_modified_".$client->clnt_db_name;
                }
                DB::disconnect('mysql');//here connection name, I used mysql for example
                Config::set('database.connections.mysql.database', $db_name);//new database name, you want to connect to.
            }
            DB::disconnect('mysql');//here connection name, I used mysql for example
            Config::set('database.connections.mysql.database', $db_name);//new database name, you want to connect to.
            return $next($request);
        });
    }
    public function favorite_report(Request $request){
        $favorite_report = DB::table('favorite_report')
                    ->where('report_name',$request->report_name)
                    ->get();
        if(count($favorite_report)<1){
            DB::table('favorite_report')->insert(
                ['report_name' => $request->report_name, 'report_status' => $request->status, 'report_link'=>$request->link]
            );
        }else{
            DB::table('favorite_report')
            ->where('report_name',$request->report_name)
            ->update(['report_status' => $request->status]);
        }
        
    }
    public function Movements_in_Equity(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $st_delayed_charges= DB::connection('mysql')->select("SELECT * FROM st_delayed_charges");
        $st_delayed_credit= DB::connection('mysql')->select("SELECT * FROM st_delayed_credits");
        $st_refund_receipts= DB::connection('mysql')->select("SELECT * FROM st_refund_receipts");
        $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();
        $all_cost_center_list= CostCenter::all();
        return view('app.movementinequity', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','st_estimates','st_delayed_charges','st_delayed_credit','st_refund_receipts','st_sales_receipts','st_credit_notes','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function MovementinEquityByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsettingjournalob="WHERE created_at < '".$FROM."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            $sortsettingjournalob="WHERE created_at IS NULL AND";
        }
        if($sortsettingjournalob==""){
            $sortjournalob="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournalob=" je_cost_center='".$CostCenterFilter."'";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortjournalob="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournalob="WHERE created_at < '".$FROM."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
                $sortsettingjournalob="WHERE created_at IS NULL";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntryOpeningBalance= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalob.$sortjournalob." 
                            ORDER BY created_at ASC");
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $cost_center_list=CostCenter::all();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }        
        $et_account_details= DB::table('et_account_details')->get();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Opening Balance</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $TotalOpeningBalance=0;
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntryOpeningBalance as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                        foreach ($JournalEntryOpeningBalance as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $TotalOpeningBalance+=($CustomerTotal-$CustomerTotal2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalOpeningBalance+($CustomerTotal-$CustomerTotal2),2).'</td>';
                $tablecontent.='</tr>';
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                    
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    //OO2
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                    
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Opening Balance</td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                    $TotalOpeningBalance=0;
                    $CustomerTotal=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                            foreach ($JournalEntryOpeningBalance as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal+=$JE->je_credit;
                                    }else{
                                        $CustomerTotal-=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $CustomerTotal2=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                            foreach ($JournalEntryOpeningBalance as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal2-=$JE->je_credit;
                                    }else{
                                        $CustomerTotal2+=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                    $TotalOpeningBalance+=($CustomerTotal-$CustomerTotal2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Earnings</td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                    $CustomerTotal=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal+=$JE->je_credit;
                                    }else{
                                        $CustomerTotal-=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $CustomerTotal2=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal2-=$JE->je_credit;
                                    }else{
                                        $CustomerTotal2+=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    
                    $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalOpeningBalance+($CustomerTotal-$CustomerTotal2),2).'</td>';
                    $tablecontent.='</tr>';
                    //OO2END
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //DD3
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Opening Balance</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $TotalOpeningBalance=0;
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntryOpeningBalance as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                        foreach ($JournalEntryOpeningBalance as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $TotalOpeningBalance+=($CustomerTotal-$CustomerTotal2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
               
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                
                $tablecontent.='<td colspan="2" class="dottedborder" style="vertical-align:middle;font-size:11px;">Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Other Company Expenses" || $coa->coa_account_type=='Salaries and Wages' || $coa->coa_account_type=='Other Compensation' || $coa->coa_account_type=='Personnel Benefit Contributions' || $coa->coa_account_type=='Transportation and Training Expenses' || $coa->coa_account_type=='Utility Expenses' || $coa->coa_account_type=='Corporate Security' ||  $coa->coa_account_type=='Communication and Printing Expenses' || $coa->coa_account_type=='Taxes, Duties and Premiums' || $coa->coa_account_type=='Representation and Commision Expenses' || $coa->coa_account_type=='Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses' || $coa->coa_account_type=='Repairs and Maintenance' || $coa->coa_account_type=='Professional Services' || $coa->coa_account_type=='Doubtful Accounts and Depreciation' ||  $coa->coa_account_type=='Gain and Losses' || $coa->coa_account_type=='Financial Expenses' ||  $coa->coa_account_type=='Supplies Expenses' || $coa->coa_account_type=='Awards and Rewards' ||  $coa->coa_account_type=='Rent/Lease Expenses'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalOpeningBalance+($CustomerTotal-$CustomerTotal2),2).'</td>';
                $tablecontent.='</tr>';
            //DD3END
            
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th colspan="3" width="60%"></th>'.
                '<th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function VAT_List(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $st_delayed_charges= DB::connection('mysql')->select("SELECT * FROM st_delayed_charges");
        $st_delayed_credit= DB::connection('mysql')->select("SELECT * FROM st_delayed_credits");
        $st_refund_receipts= DB::connection('mysql')->select("SELECT * FROM st_refund_receipts");
        $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.vat_list', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','st_estimates','st_delayed_charges','st_delayed_credit','st_refund_receipts','st_sales_receipts','st_credit_notes','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function VAT_List_By_Date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $st_delayed_charges= DB::connection('mysql')->select("SELECT * FROM st_delayed_charges");
        $st_delayed_credit= DB::connection('mysql')->select("SELECT * FROM st_delayed_credits");
        $st_refund_receipts= DB::connection('mysql')->select("SELECT * FROM st_refund_receipts");
        $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->whereBetween('et_date', [$FROM, $TO])
            ->get();
        $cost_center_list=CostCenter::all();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $tablecontent="";
        
        $totaltaxall=0;
        $withheldtotal=0;
        $netamounttotal=0;
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach ($SalesTransaction as $st){
                    if($st->st_type=="Sales Receipts Null and Void"){
                            foreach ($st_sales_receipts as $sr){
                                if($sr->st_s_no==$st->st_no){
                    $tablecontent.='<tr>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_no;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_type;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                    $tablecontent.='</td>';        
                    
                    $product_name="";
                    foreach ($products_and_services as $prod){
                        if($sr->st_s_product==$prod->product_id){
                            $product_name=$prod->product_name;
                        }
                    }
                    
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_s_desc;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_s_qty;
                    $tablecontent.='</td>'; 
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_s_rate,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_s_total,2);
                    $tablecontent.='</td>';
                    $withhold=0;
                    foreach ($customers as $cus){
                        foreach ($SalesTransaction as $ss){
                            if($cus->customer_id==$ss->st_customer_id){
                                $withhold=$cus->withhold_tax;
                            }
                        }
                    }
                    $taxxxx=$sr->st_s_total*0.12;
                    $totaltaxall+=$taxxxx;
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($taxxxx,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_s_total-$taxxxx,2);
                    $tablecontent.='</td>';
                    $Gross=$sr->st_s_total-$taxxxx;
                    $withoud=$sr->st_s_total*($withhold/100);
                    $withheldtotal+=$Gross;
                    $netamounttotal+=$Gross-$withoud;
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($Gross-$withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                                }
                            }
                        
        
                    }
                    else if($st->st_type=="Invoice"){
                        foreach ($st_invoice as $sr){
                            if($sr->st_i_no==$st->st_no){
                    $tablecontent.='<tr>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_no;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_type;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                    $tablecontent.='</td>';        
                    
                    $product_name="";
                    foreach ($products_and_services as $prod){
                        if($sr->st_i_product==$prod->product_id){
                            $product_name=$prod->product_name;
                        }
                    }
                    
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_i_desc;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_i_qty;
                    $tablecontent.='</td>'; 
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_i_rate,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_i_total,2);
                    $tablecontent.='</td>';
                    $withhold=0;
                    foreach ($customers as $cus){
                        foreach ($SalesTransaction as $ss){
                            if($cus->customer_id==$ss->st_customer_id){
                                $withhold=$cus->withhold_tax;
                            }
                        }
                    }
                    $taxxxx=$sr->st_i_total*0.12;
                    $totaltaxall+=$taxxxx;
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($taxxxx,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_i_total-$taxxxx,2);
                    $tablecontent.='</td>';
                    $Gross=$sr->st_i_total-$taxxxx;
                    $withoud=$sr->st_i_total*($withhold/100);
                    $withheldtotal+=$Gross;
                    $netamounttotal+=$Gross-$withoud;
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($Gross-$withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                                }
                            }
                    }
                    else if($st->st_type=="Credit Note"){
                        foreach ($st_credit_notes as $sr){
                            if($sr->st_cn_no==$st->st_no){
                    $tablecontent.='<tr>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_no;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$st->st_type;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                    $tablecontent.='</td>';        
                    
                    $product_name="";
                    foreach ($products_and_services as $prod){
                        if($sr->st_cn_product==$prod->product_id){
                            $product_name=$prod->product_name;
                        }
                    }
                    
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_cn_desc;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$sr->st_cn_qty;
                    $tablecontent.='</td>'; 
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_cn_rate,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($sr->st_cn_total,2);
                    $tablecontent.='</td>';
                    $withhold=0;
                    foreach ($customers as $cus){
                        foreach ($SalesTransaction as $ss){
                            if($cus->customer_id==$ss->st_customer_id){
                                $withhold=$cus->withhold_tax;
                            }
                        }
                    }
                    $taxxxx=$sr->st_cn_total*0.12;
                    $totaltaxall-=$taxxxx; 
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format("-".$taxxxx,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format("-".$sr->st_cn_total-$taxxxx,2);
                    $tablecontent.='</td>';
                    $Gross=$sr->st_cn_total-$taxxxx;
                    $withoud=$sr->st_cn_total*($withhold/100);
                    $withheldtotal-=$Gross;
                    $netamounttotal-=$Gross-$withoud;
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format("-".$withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format("-".$Gross-$withoud,2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                                }
                            }
                    }
        
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }else{
                        $sortjournal=" je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                                $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($SalesTransaction as $st){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$st->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                    $go=1;
                                    }
                                    
                                }
                                
                            }
                            if($go==1){

                                if($st->st_type=="Sales Receipts Null and Void"){
                                        foreach ($st_sales_receipts as $sr){
                                            if($sr->st_s_no==$st->st_no){
                                        $tablecontent.='<tr>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_no;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_type;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                                        $tablecontent.='</td>';        
                                        
                                        $product_name="";
                                        foreach ($products_and_services as $prod){
                                            if($sr->st_s_product==$prod->product_id){
                                                $product_name=$prod->product_name;
                                            }
                                        }
                                        
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_s_desc;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_s_qty;
                                        $tablecontent.='</td>'; 
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_s_rate,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_s_total,2);
                                        $tablecontent.='</td>';
                                        $withhold=0;
                                        foreach ($customers as $cus){
                                            foreach ($SalesTransaction as $ss){
                                                if($cus->customer_id==$ss->st_customer_id){
                                                    $withhold=$cus->withhold_tax;
                                                }
                                            }
                                        }
                                        $taxxxx=$sr->st_s_total*0.12;
                                        $totaltaxall+=$taxxxx;
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($taxxxx,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_s_total-$taxxxx,2);
                                        $tablecontent.='</td>';
                                        $Gross=$sr->st_s_total-$taxxxx;
                                        $withoud=$sr->st_s_total*($withhold/100);
                                        $withheldtotal+=$Gross;
                                        $netamounttotal+=$Gross-$withoud;
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($Gross-$withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='</tr>';
                                                    }
                                                }
                                            
                            
                                }
                                else if($st->st_type=="Invoice"){
                                            foreach ($st_invoice as $sr){
                                                if($sr->st_i_no==$st->st_no){
                                        $tablecontent.='<tr>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_no;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_type;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                                        $tablecontent.='</td>';        
                                        
                                        $product_name="";
                                        foreach ($products_and_services as $prod){
                                            if($sr->st_i_product==$prod->product_id){
                                                $product_name=$prod->product_name;
                                            }
                                        }
                                        
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_i_desc;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_i_qty;
                                        $tablecontent.='</td>'; 
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_i_rate,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_i_total,2);
                                        $tablecontent.='</td>';
                                        $withhold=0;
                                        foreach ($customers as $cus){
                                            foreach ($SalesTransaction as $ss){
                                                if($cus->customer_id==$ss->st_customer_id){
                                                    $withhold=$cus->withhold_tax;
                                                }
                                            }
                                        }
                                        $taxxxx=$sr->st_i_total*0.12;
                                        $totaltaxall+=$taxxxx;
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($taxxxx,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_i_total-$taxxxx,2);
                                        $tablecontent.='</td>';
                                        $Gross=$sr->st_i_total-$taxxxx;
                                        $withoud=$sr->st_i_total*($withhold/100);
                                        $withheldtotal+=$Gross;
                                        $netamounttotal+=$Gross-$withoud;
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($Gross-$withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='</tr>';
                                                    }
                                                }
                                }
                                else if($st->st_type=="Credit Note"){
                                            foreach ($st_credit_notes as $sr){
                                                if($sr->st_cn_no==$st->st_no){
                                        $tablecontent.='<tr>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_no;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$st->st_type;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                                        $tablecontent.='</td>';        
                                        
                                        $product_name="";
                                        foreach ($products_and_services as $prod){
                                            if($sr->st_cn_product==$prod->product_id){
                                                $product_name=$prod->product_name;
                                            }
                                        }
                                        
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_cn_desc;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$sr->st_cn_qty;
                                        $tablecontent.='</td>'; 
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_cn_rate,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($sr->st_cn_total,2);
                                        $tablecontent.='</td>';
                                        $withhold=0;
                                        foreach ($customers as $cus){
                                            foreach ($SalesTransaction as $ss){
                                                if($cus->customer_id==$ss->st_customer_id){
                                                    $withhold=$cus->withhold_tax;
                                                }
                                            }
                                        }
                                        $taxxxx=$sr->st_cn_total*0.12;
                                        $totaltaxall-=$taxxxx; 
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format("-".$taxxxx,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format("-".$sr->st_cn_total-$taxxxx,2);
                                        $tablecontent.='</td>';
                                        $Gross=$sr->st_cn_total-$taxxxx;
                                        $withoud=$sr->st_cn_total*($withhold/100);
                                        $withheldtotal-=$Gross;
                                        $netamounttotal-=$Gross-$withoud;
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format("-".$withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format("-".$Gross-$withoud,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='</tr>';
                                                    }
                                                }
                                }
                            }
                        }
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach ($SalesTransaction as $st){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$st->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
                if($go==1){

                    if($st->st_type=="Sales Receipts Null and Void"){
                            foreach ($st_sales_receipts as $sr){
                                if($sr->st_s_no==$st->st_no){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                            $tablecontent.='</td>';        
                            
                            $product_name="";
                            foreach ($products_and_services as $prod){
                                if($sr->st_s_product==$prod->product_id){
                                    $product_name=$prod->product_name;
                                }
                            }
                            
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_s_desc;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_s_qty;
                            $tablecontent.='</td>'; 
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_s_rate,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_s_total,2);
                            $tablecontent.='</td>';
                            $withhold=0;
                            foreach ($customers as $cus){
                                foreach ($SalesTransaction as $ss){
                                    if($cus->customer_id==$ss->st_customer_id){
                                        $withhold=$cus->withhold_tax;
                                    }
                                }
                            }
                            $taxxxx=$sr->st_s_total*0.12;
                            $totaltaxall+=$taxxxx;
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($taxxxx,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_s_total-$taxxxx,2);
                            $tablecontent.='</td>';
                            $Gross=$sr->st_s_total-$taxxxx;
                            $withoud=$sr->st_s_total*($withhold/100);
                            $withheldtotal+=$Gross;
                            $netamounttotal+=$Gross-$withoud;
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($Gross-$withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                                        }
                                    }
                                
                
                    }
                    else if($st->st_type=="Invoice"){
                                foreach ($st_invoice as $sr){
                                    if($sr->st_i_no==$st->st_no){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                            $tablecontent.='</td>';        
                            
                            $product_name="";
                            foreach ($products_and_services as $prod){
                                if($sr->st_i_product==$prod->product_id){
                                    $product_name=$prod->product_name;
                                }
                            }
                            
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_i_desc;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_i_qty;
                            $tablecontent.='</td>'; 
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_i_rate,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_i_total,2);
                            $tablecontent.='</td>';
                            $withhold=0;
                            foreach ($customers as $cus){
                                foreach ($SalesTransaction as $ss){
                                    if($cus->customer_id==$ss->st_customer_id){
                                        $withhold=$cus->withhold_tax;
                                    }
                                }
                            }
                            $taxxxx=$sr->st_i_total*0.12;
                            $totaltaxall+=$taxxxx;
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($taxxxx,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_i_total-$taxxxx,2);
                            $tablecontent.='</td>';
                            $Gross=$sr->st_i_total-$taxxxx;
                            $withoud=$sr->st_i_total*($withhold/100);
                            $withheldtotal+=$Gross;
                            $netamounttotal+=$Gross-$withoud;
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($Gross-$withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                                        }
                                    }
                    }
                    else if($st->st_type=="Credit Note"){
                                foreach ($st_credit_notes as $sr){
                                    if($sr->st_cn_no==$st->st_no){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$st->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=date('m-d-Y',strtotime($st->st_date));
                            $tablecontent.='</td>';        
                            
                            $product_name="";
                            foreach ($products_and_services as $prod){
                                if($sr->st_cn_product==$prod->product_id){
                                    $product_name=$prod->product_name;
                                }
                            }
                            
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_cn_desc;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$sr->st_cn_qty;
                            $tablecontent.='</td>'; 
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_cn_rate,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($sr->st_cn_total,2);
                            $tablecontent.='</td>';
                            $withhold=0;
                            foreach ($customers as $cus){
                                foreach ($SalesTransaction as $ss){
                                    if($cus->customer_id==$ss->st_customer_id){
                                        $withhold=$cus->withhold_tax;
                                    }
                                }
                            }
                            $taxxxx=$sr->st_cn_total*0.12;
                            $totaltaxall-=$taxxxx; 
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format("-".$taxxxx,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format("-".$sr->st_cn_total-$taxxxx,2);
                            $tablecontent.='</td>';
                            $Gross=$sr->st_cn_total-$taxxxx;
                            $withoud=$sr->st_cn_total*($withhold/100);
                            $withheldtotal-=$Gross;
                            $netamounttotal-=$Gross-$withoud;
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format("-".$withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format("-".$Gross-$withoud,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                                        }
                                    }
                    }
                }
            }
        }

        
        $tablecontent.='<tr>';
        $tablecontent.='<td colspan="12" style="border-bottom:2px dotted #ccc;"></td>';
        $tablecontent.='</tr>';

        $tablecontent.='<tr>';
        $tablecontent.='<td colspan="5" style="vertical-align:middle;"></td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;font-weight:bold;">Total VAT</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;">'.number_format($totaltaxall,2).'</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;font-weight:bold;">Total Withhoding</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;">'.number_format($withheldtotal,2).'</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;font-weight:bold;">Total Net</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;">'.number_format($netamounttotal,2).'</td>';
        $tablecontent.='</tr>';

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>#</th><th>Type</th><th>Date</th><th>Description</th><th>Qty</th><th>Rate</th>
                <th>Amount</th><th>Less:Tax</th><th>Total</th><th>Withhold Tax</th><th>Net Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function sales_transaction_list(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $st_delayed_charges= DB::connection('mysql')->select("SELECT * FROM st_delayed_charges");
        $st_delayed_credit= DB::connection('mysql')->select("SELECT * FROM st_delayed_credits");
        $st_refund_receipts= DB::connection('mysql')->select("SELECT * FROM st_refund_receipts");
        $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.salestransactionlist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','st_estimates','st_delayed_charges','st_delayed_credit','st_refund_receipts','st_sales_receipts','st_credit_notes','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));


    }
    public function sales_transaction_list_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $st_delayed_charges= DB::connection('mysql')->select("SELECT * FROM st_delayed_charges");
        $st_delayed_credit= DB::connection('mysql')->select("SELECT * FROM st_delayed_credits");
        $st_refund_receipts= DB::connection('mysql')->select("SELECT * FROM st_refund_receipts");
        $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->whereBetween('et_date', [$FROM, $TO])
            ->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach ($SalesTransaction as $ST){
                    if($ST->remark!="Cancelled"){
                        $tablecontent.='<tr>';  
                        $tablecontent.='<td style="vertical-align:middle;">';  
                        $tablecontent.=$ST->st_date!=""?date('m-d-Y',strtotime($ST->st_date)) : '';  
                        $tablecontent.='</td>'; 
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        $tablecontent.=$ST->st_type;  
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        $tablecontent.=$ST->st_no; 
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        $tablecontent.=$ST->display_name!=""? $ST->display_name : $ST->f_name." ".$ST->l_name; 
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($ST->st_due_date!=""){
                            $date1=date_create(date('Y-m-d'));
                            $date2=date_create($ST->st_due_date);
                            $diff=date_diff($date1,$date2);
                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($ST->st_status=="Open" || $ST->st_status=="Partially paid" )){
                                $tablecontent.='<span title="overdue" style="color:red;">'; 
                                $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                                $tablecontent.='</span>'; 
                            }else{
                                $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                            }
                        } 
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        $tablecontent.=number_format($ST->st_balance,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        if($ST->st_type == "Invoice"){
                            $invoice_total=0;
                            foreach ($st_invoice as $invoice){
                                if($ST->st_no==$invoice->st_i_no){
                                    $invoice_total=$invoice_total+$invoice->st_i_total;
            
                                }
            
                            }
                            $tablecontent.=number_format($invoice_total,2);
                        }
                        else if($ST->st_type == "Estimate"){
                            $estimate_total=0;
                            foreach ($st_estimates as $estim){
                                if($ST->st_no==$estim->st_e_no){
                                    $estimate_total=$estimate_total+$estim->st_e_total;
            
                                }
            
                            }
                            $tablecontent.=number_format($estimate_total,2);
            
                        }
                         else if($ST->st_type == "Sales Receipt"){
                            $sales_receipt_total=0;
                            foreach ($st_sales_receipts as $sr){
                                if($ST->st_no==$sr->st_s_no){
                                    $sales_receipt_total=$sales_receipt_total+$sr->st_s_total;
                                }
            
                            }
                            $tablecontent.=number_format($ST->st_amount_paid,2);
                        }
                        else if($ST->st_type == "Refund Receipt"){
                            $refund_receipt_total=0;
                            foreach ($st_refund_receipts as $rr){
                                if($ST->st_no==$rr->st_r_no){
                                    $refund_receipt_total=$refund_receipt_total+$rr->st_r_total;
                                }
                            }
                            $tablecontent.=number_format($refund_receipt_total,2);
                        }
                        else if($ST->st_type == "Charge"){
                            $delayed_charge_total=0;
                            foreach ($st_delayed_charges as $cd){
                                if($ST->st_no==$cd->st_dc_no){
                                    $delayed_charge_total=$delayed_charge_total+$cd->st_dc_total;
                                }
                            }
                            $tablecontent.=number_format($delayed_charge_total,2);
                        }
                        else if($ST->st_type == "Credit Note"){
                            $credit_note_total=0;
                            foreach ($st_credit_notes as $cn){
                                if($ST->st_no==$cn->st_cn_no){
                                    $credit_note_total=$credit_note_total+$cn->st_cn_total;
                                }
                            }
                            $tablecontent.=number_format($credit_note_total,2);
                        }
                        else{
                            $tablecontent.=number_format($ST->st_amount_paid,2);
            
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'; 
                        $tablecontent.=$ST->st_status;
                        $tablecontent.='</td>';
                        $tablecontent.=''; 
                    }
                     
        
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' ";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' ";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' ";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note'  )
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0 ){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        
                        $tablecontent.=$ccl->cc_name;
                        
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
		
                    }
                    
                    
                    foreach ($SalesTransaction as $ST){
                        if($ST->remark!="Cancelled"){
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $tablecontent.='<tr>';  
                                        $tablecontent.='<td style="vertical-align:middle;">';  
                                        $tablecontent.=$ST->st_date!=""?date('m-d-Y',strtotime($ST->st_date)) : '';  
                                        $tablecontent.='</td>'; 
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        $tablecontent.=$ST->st_type;  
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        $tablecontent.=$ST->st_no; 
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        $tablecontent.=$ST->display_name!=""? $ST->display_name : $ST->f_name." ".$ST->l_name; 
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        if($ST->st_due_date!=""){
                                            $date1=date_create(date('Y-m-d'));
                                            $date2=date_create($ST->st_due_date);
                                            $diff=date_diff($date1,$date2);
                                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($ST->st_status=="Open" || $ST->st_status=="Partially paid" )){
                                                $tablecontent.='<span title="overdue" style="color:red;">'; 
                                                $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                                                $tablecontent.='</span>'; 
                                            }else{
                                                $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                                            }
                                        } 
                                        
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        $tablecontent.=number_format($ST->st_balance,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        if($ST->st_type == "Invoice"){
                                            $invoice_total=0;
                                            foreach ($st_invoice as $invoice){
                                                if($ST->st_no==$invoice->st_i_no){
                                                    $invoice_total=$invoice_total+$invoice->st_i_total;
                            
                                                }
                            
                                            }
                                            $tablecontent.=number_format($invoice_total,2);
                                        }
                                        else if($ST->st_type == "Estimate"){
                                            $estimate_total=0;
                                            foreach ($st_estimates as $estim){
                                                if($ST->st_no==$estim->st_e_no){
                                                    $estimate_total=$estimate_total+$estim->st_e_total;
                            
                                                }
                            
                                            }
                                            $tablecontent.=number_format($estimate_total,2);
                            
                                        }
                                         else if($ST->st_type == "Sales Receipt"){
                                            $sales_receipt_total=0;
                                            foreach ($st_sales_receipts as $sr){
                                                if($ST->st_no==$sr->st_s_no){
                                                    $sales_receipt_total=$sales_receipt_total+$sr->st_s_total;
                                                }
                            
                                            }
                                            $tablecontent.=number_format($ST->st_amount_paid,2);
                                        }
                                        else if($ST->st_type == "Refund Receipt"){
                                            $refund_receipt_total=0;
                                            foreach ($st_refund_receipts as $rr){
                                                if($ST->st_no==$rr->st_r_no){
                                                    $refund_receipt_total=$refund_receipt_total+$rr->st_r_total;
                                                }
                                            }
                                            $tablecontent.=number_format($refund_receipt_total,2);
                                        }
                                        else if($ST->st_type == "Charge"){
                                            $delayed_charge_total=0;
                                            foreach ($st_delayed_charges as $cd){
                                                if($ST->st_no==$cd->st_dc_no){
                                                    $delayed_charge_total=$delayed_charge_total+$cd->st_dc_total;
                                                }
                                            }
                                            $tablecontent.=number_format($delayed_charge_total,2);
                                        }
                                        else if($ST->st_type == "Credit Note"){
                                            $credit_note_total=0;
                                            foreach ($st_credit_notes as $cn){
                                                if($ST->st_no==$cn->st_cn_no){
                                                    $credit_note_total=$credit_note_total+$cn->st_cn_total;
                                                }
                                            }
                                            $tablecontent.=number_format($credit_note_total,2);
                                        }
                                        else{
                                            $tablecontent.=number_format($ST->st_amount_paid,2);
                            
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'; 
                                        $tablecontent.=$ST->st_status;
                                        $tablecontent.='</td>';
                                        $tablecontent.=''; 
                                    }
                                    
                                }
                                
                            }
                            
                        }
                         
            
                    }
                }
            }
        }else{
            //sales transaction by individual cost center
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            
            foreach ($SalesTransaction as $ST){
                if($ST->remark!="Cancelled"){
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $tablecontent.='<tr>';  
                                $tablecontent.='<td style="vertical-align:middle;">';  
                                $tablecontent.=$ST->st_date!=""?date('m-d-Y',strtotime($ST->st_date)) : '';  
                                $tablecontent.='</td>'; 
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                $tablecontent.=$ST->st_type;  
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                $tablecontent.=$ST->st_no; 
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                $tablecontent.=$ST->display_name!=""? $ST->display_name : $ST->f_name." ".$ST->l_name; 
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($ST->st_due_date!=""){
                                    $date1=date_create(date('Y-m-d'));
                                    $date2=date_create($ST->st_due_date);
                                    $diff=date_diff($date1,$date2);
                                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($ST->st_status=="Open" || $ST->st_status=="Partially paid" )){
                                        $tablecontent.='<span title="overdue" style="color:red;">'; 
                                        $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                                        $tablecontent.='</span>'; 
                                    }else{
                                        $tablecontent.=$ST->st_due_date!=""? date('m-d-Y',strtotime($ST->st_due_date)) : ""; 
                                    }
                                } 
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                $tablecontent.=number_format($ST->st_balance,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                if($ST->st_type == "Invoice"){
                                    $invoice_total=0;
                                    foreach ($st_invoice as $invoice){
                                        if($ST->st_no==$invoice->st_i_no){
                                            $invoice_total=$invoice_total+$invoice->st_i_total;
                    
                                        }
                    
                                    }
                                    $tablecontent.=number_format($invoice_total,2);
                                }
                                else if($ST->st_type == "Estimate"){
                                    $estimate_total=0;
                                    foreach ($st_estimates as $estim){
                                        if($ST->st_no==$estim->st_e_no){
                                            $estimate_total=$estimate_total+$estim->st_e_total;
                    
                                        }
                    
                                    }
                                    $tablecontent.=number_format($estimate_total,2);
                    
                                }
                                 else if($ST->st_type == "Sales Receipt"){
                                    $sales_receipt_total=0;
                                    foreach ($st_sales_receipts as $sr){
                                        if($ST->st_no==$sr->st_s_no){
                                            $sales_receipt_total=$sales_receipt_total+$sr->st_s_total;
                                        }
                    
                                    }
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else if($ST->st_type == "Refund Receipt"){
                                    $refund_receipt_total=0;
                                    foreach ($st_refund_receipts as $rr){
                                        if($ST->st_no==$rr->st_r_no){
                                            $refund_receipt_total=$refund_receipt_total+$rr->st_r_total;
                                        }
                                    }
                                    $tablecontent.=number_format($refund_receipt_total,2);
                                }
                                else if($ST->st_type == "Charge"){
                                    $delayed_charge_total=0;
                                    foreach ($st_delayed_charges as $cd){
                                        if($ST->st_no==$cd->st_dc_no){
                                            $delayed_charge_total=$delayed_charge_total+$cd->st_dc_total;
                                        }
                                    }
                                    $tablecontent.=number_format($delayed_charge_total,2);
                                }
                                else if($ST->st_type == "Credit Note"){
                                    $credit_note_total=0;
                                    foreach ($st_credit_notes as $cn){
                                        if($ST->st_no==$cn->st_cn_no){
                                            $credit_note_total=$credit_note_total+$cn->st_cn_total;
                                        }
                                    }
                                    $tablecontent.=number_format($credit_note_total,2);
                                }
                                else{
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                    
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'; 
                                $tablecontent.=$ST->st_status;
                                $tablecontent.='</td>';
                                $tablecontent.=''; 
                            }
                            
                        }
                        
                    }
                    
                }
                 
    
            }
        }
        


        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Due Date</th><th>Balance</th>
                <th>Total</th><th>Status</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function expense_transaction_list(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.expensetransactionlist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));

    }
    public function expense_transaction_list_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsettingex="WHERE et_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            $sortsettingex="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingex="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
        ".$sortjournal." 
        ORDER BY created_at ASC");
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->whereBetween('et_date', [$FROM, $TO])
            ->get();
        $expense_transactions= DB::connection('mysql')->select("SELECT * FROM expense_transactions
                            JOIN customers ON expense_transactions.et_customer=customers.customer_id
                            JOIN et_account_details ON expense_transactions.et_no=et_account_details.et_ad_no
                            ".$sortsettingex." 
                            ORDER BY et_no ASC");
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();
        $tablecontent="";
        $PaymentFor="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($expense_transactions as $et){
                    if($et->remark!="Cancelled"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=date('m-d-Y',strtotime($et->et_date));
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">'.$et->et_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$et->et_no;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$et->f_name." ".$et->l_name;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        if($et->et_due_date!=""){
                            $date1=date_create(date('Y-m-d'));
                            $date2=date_create($et->et_due_date);
                            $diff=date_diff($date1,$date2);
                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et->et_bil_status!="Paid"){
                                $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "")."</span>";
                            }else{
                                $tablecontent.=$et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "";
                            }
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        foreach ($COA as $coa){
                            if($et->et_ad_product==$coa->id){
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$coa->coa_name;
                        $tablecontent.='</a>';
            
                            }
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$et->et_memo;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;"> ';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.='PHP '.number_format($et->et_ad_total,2);
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>'; 
                    }
                    
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Expense' OR je_transaction_type='Cheque' OR je_transaction_type='Credit card credit')";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Expense' OR je_transaction_type='Cheque' OR je_transaction_type='Credit card credit')";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Expense' OR je_transaction_type='Cheque' OR je_transaction_type='Credit card credit')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
		
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                    }
                    
                    foreach($expense_transactions as $et){
                
                        if($et->remark!="Cancelled"){
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                        $tablecontent.='<tr>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.=date('m-d-Y',strtotime($et->et_date));
                                        $tablecontent.='</a>';
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'.$et->et_type.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.=$et->et_no;
                                        $tablecontent.='</a>';
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.=$et->f_name." ".$et->l_name;
                                        $tablecontent.='</a>';
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        if($et->et_due_date!=""){
                                            $date1=date_create(date('Y-m-d'));
                                            $date2=date_create($et->et_due_date);
                                            $diff=date_diff($date1,$date2);
                                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et->et_bil_status!="Paid"){
                                                $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "")."</span>";
                                            }else{
                                                $tablecontent.=$et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "";
                                            }
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        foreach ($COA as $coa){
                                            if($et->et_ad_product==$coa->id){
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.=$coa->coa_name;
                                        $tablecontent.='</a>';
                            
                                            }
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.=$et->et_memo;
                                        $tablecontent.='</a>';
                                        $tablecontent.='</td>';
                                        
                                        $tablecontent.='<td style="vertical-align:middle;"> ';
                                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                        $tablecontent.='PHP '.number_format($et->et_ad_total,2);
                                        $tablecontent.='</a>';
                                        $tablecontent.='</td>';
                                        $tablecontent.='</tr>'; 
                                    }
                                    
                                }
                                
                            }
                            
                        }
                        
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            
            foreach($expense_transactions as $et){
                
                if($et->remark!="Cancelled"){
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=date('m-d-Y',strtotime($et->et_date));
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">'.$et->et_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$et->et_no;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$et->f_name." ".$et->l_name;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                if($et->et_due_date!=""){
                                    $date1=date_create(date('Y-m-d'));
                                    $date2=date_create($et->et_due_date);
                                    $diff=date_diff($date1,$date2);
                                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et->et_bil_status!="Paid"){
                                        $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "")."</span>";
                                    }else{
                                        $tablecontent.=$et->et_due_date!=""? date('m-d-Y',strtotime($et->et_due_date)) : "";
                                    }
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                foreach ($COA as $coa){
                                    if($et->et_ad_product==$coa->id){
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$coa->coa_name;
                                $tablecontent.='</a>';
                    
                                    }
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$et->et_memo;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                
                                $tablecontent.='<td style="vertical-align:middle;"> ';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$et->et_no.'\',\''.$et->et_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.='PHP '.number_format($et->et_ad_total,2);
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>'; 
                            }
                            
                        }
                        
                    }
                    
                }
                
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .' <th>Date</th>
                <th>Transaction Type</th>
                <th>No.</th>
                <th>Name</th>
                <th>Due Date</th>
                <th>Account</th>
                <th>Memo</th>
                <th>Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ledgerforcoadesc_sub(Request $request){
        if($request->has('desc')){
           
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $chartofaccountbyaccounttype = DB::table('chart_of_accounts')
                ->select('coa_account_type')
                ->groupBy('coa_account_type')
                ->get();
        $chartofaccountbydetailtype = DB::table('chart_of_accounts')
                ->select('*')
                ->where('coa_active','1')
                ->groupBy('coa_detail_type')
                ->get();
        $chartofaccounts= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts");
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $ex_tran = DB::table('expense_transactions')->get();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $selected=$request->desc;
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ledgerforcoadesc_sub', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','ex_tran','selected','COA','chartofaccountbyaccounttype','chartofaccountbydetailtype','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
     
        }else{
            return redirect()->back();
        }
        
    }
    public function ledger_desc_sub_by_date(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }

        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        //JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $chartofaccountbyaccounttype = DB::table('chart_of_accounts')
                ->select('coa_account_type')
                ->groupBy('coa_account_type')
                ->get();
        $chartofaccountbydetailtype = DB::table('chart_of_accounts')
                ->select('*')
                ->where('coa_active','1')
                ->groupBy('coa_detail_type')
                ->get();
        $chartofaccounts= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts");
        
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')
                ->whereBetween('updated_at', [$FROM, $TO])
                ->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $selected=$request->desc;
        $tablecontent="";
        $PaymentFor="";
        $totaldescamount=0;
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach ($chartofaccountbydetailtype as $detail){
                    if($detail->id==$selected){
                        $totaldescamount=0;
                foreach ($JournalEntry as $je){
                    if($detail->id==$je->je_account){
                        if($je->je_transaction_type!="Journal Entry"){
                            if($je->remark!="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$je->other_no;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        $tablecontent.='</a>';
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$customer_mnam;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$TIN;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=number_format($je->je_debit,2);
                            $tablecontent.='</a>';
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            $tablecontent.='</a>';
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
        
                            }
                            else if($je->remark=="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->other_no;
                        
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$customer_mnam;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$TIN;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                            
                            $tablecontent.=number_format($je->je_debit,2);
                          
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                           
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->other_no;
                        
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$customer_mnam;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$TIN;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.='<div class="tooltip-custom">View Note';
                            $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                            $tablecontent.='</div>';
                        }
                        
                        
                        
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount-=$je->je_debit;
                            }
                            
                            
                            $tablecontent.=number_format(-$je->je_debit,2);
                          
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount+=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format($je->je_credit,2);
                           
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                            }
        
                        }else{
                            if($je->remark!="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->je_no;
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->je_name;
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                           
                            $tablecontent.=number_format($je->je_debit,2);
                           
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';        
                            }
                            else if($je->remark=="Cancelled"){
        
        
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->je_no;
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->je_name;
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.='<div class="tooltip-custom">View Note';
                            $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                            $tablecontent.='</div>';
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                           
                            $tablecontent.=number_format($je->je_debit,2);
                           
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                            }
        
                        }
        
                        
                    }
        
                }
                
               
        
                    }
        
                }
            }
            else if($CostCenterFilter=="By Cost Center"){

                foreach($all_cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                            if($sortsettingjournal==""){
                                $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                            }else{
                                $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                            }
                            $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $g=0;
                        foreach ($JournalEntry as $je){
                        if($je->je_account==$selected){
                            $g=1;
                        }
                        }
                        if($g==1){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td colspan="7" >';
                            
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td colspan="7" style="text-align:center;font-weight:bold;">';
                            
                                    $tablecontent.=$ccl->cc_name." ".count($JournalEntry);
                            
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td colspan="7" >';
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                        
                    }
                    
                    //by cost center start
                    foreach ($chartofaccountbydetailtype as $detail){
                        if($detail->id==$selected){
                            
                            
                    foreach ($JournalEntry as $je){

                        if($je->je_cost_center==$ccl->cc_no){
                            if($detail->id==$je->je_account){
                                if($je->je_transaction_type!="Journal Entry"){
                                    if($je->remark!="Cancelled"){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td colspan="1" style="text-align:left;">';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$je->other_no;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                
                                $expense_customer="";
                                $customer_mnam="";
                                $accountname="";
                                $treandate="";
                                foreach ($expense_transactions as $et){
                                    if($je->other_no==$et->et_no){
                                        $expense_customer=$et->et_customer;
                                        $treandate=$et->et_date;
                                    }
                                }
                                if($expense_customer==""){
                                    foreach ($SS as $ss){
                                        if($je->other_no==$ss->st_no){
                                            $expense_customer=$ss->st_customer_id;
                                            $treandate=$ss->st_date;
                                        }
                                    }
                                }
                                $TIN="";
                                foreach ($customers as $cus){
                                    if($expense_customer==$cus->customer_id){
                                        $result=$cus->tin_no;
                                        $chunks = str_split($result, 3);
                                        //Convert array to string.  Each element separated by the given separator.
                                        $TIN = implode('-', $chunks);
                                        if($cus->display_name!=""){
                                            $customer_mnam=$cus->display_name;
                                        }else{
                                            $customer_mnam=$cus->f_name." ".$l_name;
                                        }
                                    }
                                    
                                }
                                $tablecontent.='<td colspan="1">';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                                $tablecontent.='</a>';
                                $tablecontent.='<td colspan="1">';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$customer_mnam;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                $tablecontent.=$TIN;
                                $tablecontent.='</a>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                                if($je->je_debit!=""){
                                    if($je->remark==""){
                                        $totaldescamount+=$je->je_debit;
                                    }
                                    
                                    $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                    $tablecontent.=number_format($je->je_debit,2);
                                    $tablecontent.='</a>';
                                }
                                elseif($je->je_credit!=""){
                                    if($je->remark==""){
                                    $totaldescamount-=$je->je_credit;
                                    }
                                    $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                                    $tablecontent.=number_format("-".$je->je_credit,2);
                                    $tablecontent.='</a>';
                                }
    
                                
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
    
                                    }
                                    else if($je->remark=="Cancelled"){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td colspan="1" style="text-align:left;">';
                                
                                $tablecontent.=$je->other_no;
                                
                                $tablecontent.='</td>';
                                
                                $expense_customer="";
                                $customer_mnam="";
                                $accountname="";
                                $treandate="";
                                foreach ($expense_transactions as $et){
                                    if($je->other_no==$et->et_no){
                                        $expense_customer=$et->et_customer;
                                        $treandate=$et->et_date;
                                    }
                                }
                                if($expense_customer==""){
                                    foreach ($SS as $ss){
                                        if($je->other_no==$ss->st_no){
                                            $expense_customer=$ss->st_customer_id;
                                            $treandate=$ss->st_date;
                                        }
                                    }
                                }
                                $TIN="";
                                foreach ($customers as $cus){
                                    if($expense_customer==$cus->customer_id){
                                        $result=$cus->tin_no;
                                        $chunks = str_split($result, 3);
                                        //Convert array to string.  Each element separated by the given separator.
                                        $TIN = implode('-', $chunks);
                                        if($cus->display_name!=""){
                                            $customer_mnam=$cus->display_name;
                                        }else{
                                            $customer_mnam=$cus->f_name." ".$l_name;
                                        }
                                    }
                                    
                                }
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$customer_mnam;
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$TIN;
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
    
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                                if($je->je_debit!=""){
                                    if($je->remark==""){
                                        $totaldescamount+=$je->je_debit;
                                    }
                                    
                                    
                                    $tablecontent.=number_format($je->je_debit,2);
                                
                                }
                                elseif($je->je_credit!=""){
                                    if($je->remark==""){
                                    $totaldescamount-=$je->je_credit;
                                    }
                                    
                                    $tablecontent.=number_format("-".$je->je_credit,2);
                                
                                }
    
                                
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td colspan="1" style="text-align:left;">';
                                
                                $tablecontent.=$je->other_no;
                                
                                $tablecontent.='</td>';
                                
                                $expense_customer="";
                                $customer_mnam="";
                                $accountname="";
                                $treandate="";
                                foreach ($expense_transactions as $et){
                                    if($je->other_no==$et->et_no){
                                        $expense_customer=$et->et_customer;
                                        $treandate=$et->et_date;
                                    }
                                }
                                if($expense_customer==""){
                                    foreach ($SS as $ss){
                                        if($je->other_no==$ss->st_no){
                                            $expense_customer=$ss->st_customer_id;
                                            $treandate=$ss->st_date;
                                        }
                                    }
                                }
                                $TIN="";
                                foreach ($customers as $cus){
                                    if($expense_customer==$cus->customer_id){
                                        $result=$cus->tin_no;
                                        $chunks = str_split($result, 3);
                                        //Convert array to string.  Each element separated by the given separator.
                                        $TIN = implode('-', $chunks);
                                        if($cus->display_name!=""){
                                            $customer_mnam=$cus->display_name;
                                        }else{
                                            $customer_mnam=$cus->f_name." ".$l_name;
                                        }
                                    }
                                    
                                }
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$customer_mnam;
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$TIN;
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                if($je->remark!=""){
                                    $tablecontent.=$je->remark;
                                }
                                
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                if($je->remark!=""){
                                    $tablecontent.='<div class="tooltip-custom">View Note';
                                    $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                                    $tablecontent.='</div>';
                                }
                                
                                
                                
                            
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                                if($je->je_debit!=""){
                                    if($je->remark==""){
                                        $totaldescamount-=$je->je_debit;
                                    }
                                    
                                    
                                    $tablecontent.=number_format(-$je->je_debit,2);
                                
                                }
                                elseif($je->je_credit!=""){
                                    if($je->remark==""){
                                    $totaldescamount+=$je->je_credit;
                                    }
                                    
                                    $tablecontent.=number_format($je->je_credit,2);
                                
                                }
    
                                
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                    }
    
                                }else{
                                    if($je->remark!="Cancelled"){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td colspan="1" style="text-align:left;">';
                                
                                $tablecontent.=$je->je_no;
                                
                                $tablecontent.='</td>';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$je->je_name;
                            
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                
                                $tablecontent.='<td colspan="1">';
                                if($je->remark!=""){
                                    $tablecontent.=$je->remark;
                                }
                                
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                                if($je->je_debit!=""){
                                    if($je->remark==""){
                                        $totaldescamount+=$je->je_debit;
                                    }
                                    
                                
                                    $tablecontent.=number_format($je->je_debit,2);
                                
                                }
                                elseif($je->je_credit!=""){
                                    if($je->remark==""){
                                    $totaldescamount-=$je->je_credit;
                                    }
                                    
                                    $tablecontent.=number_format("-".$je->je_credit,2);
                                    
                                }
    
                                
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';        
                                    }
                                    else if($je->remark=="Cancelled"){
    
    
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td colspan="1" style="text-align:left;">';
                                
                                $tablecontent.=$je->je_no;
                                
                                $tablecontent.='</td>';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                                
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.=$je->je_name;
                            
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                
                                $tablecontent.='</td>';
                                
                                $tablecontent.='<td colspan="1">';
                                if($je->remark!=""){
                                    $tablecontent.=$je->remark;
                                }
                                
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td colspan="1">';
                                if($je->remark!=""){
                                    $tablecontent.='<div class="tooltip-custom">View Note';
                                    $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                                    $tablecontent.='</div>';
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                                if($je->je_debit!=""){
                                    if($je->remark==""){
                                        $totaldescamount+=$je->je_debit;
                                    }
                                    
                                
                                    $tablecontent.=number_format($je->je_debit,2);
                                
                                }
                                elseif($je->je_credit!=""){
                                    if($je->remark==""){
                                    $totaldescamount-=$je->je_credit;
                                    }
                                    
                                    $tablecontent.=number_format("-".$je->je_credit,2);
                                    
                                }
    
                                
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                    }
    
                                }
    
                                
                            }
    
                        }
                        
                    }



                        }

                    }


                    //by cost center end
                }
                
            }
        }else{
                //by individual cost center start
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td colspan="7" >';
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td colspan="7" style="text-align:center;font-weight:bold;">';
                foreach($all_cost_center_list as $ccl){
                    if($ccl->cc_no==$CostCenterFilter){
                        $tablecontent.=$ccl->cc_name;
                    }

                }
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td colspan="7" >';
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                foreach ($chartofaccountbydetailtype as $detail){
                    if($detail->id==$selected){
                        $totaldescamount=0;
                foreach ($JournalEntry as $je){
                    if($detail->id==$je->je_account){
                        if($je->je_transaction_type!="Journal Entry"){
                            if($je->remark!="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$je->other_no;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        $tablecontent.='</a>';
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$customer_mnam;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$TIN;
                        $tablecontent.='</a>';
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=number_format($je->je_debit,2);
                            $tablecontent.='</a>';
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$je->other_no.'\',\''.$je->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            $tablecontent.='</a>';
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
        
                            }
                            else if($je->remark=="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->other_no;
                        
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$customer_mnam;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$TIN;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                            
                            $tablecontent.=number_format($je->je_debit,2);
                          
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                           
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->other_no;
                        
                        $tablecontent.='</td>';
                        
                        $expense_customer="";
                        $customer_mnam="";
                        $accountname="";
                        $treandate="";
                        foreach ($expense_transactions as $et){
                            if($je->other_no==$et->et_no){
                                $expense_customer=$et->et_customer;
                                $treandate=$et->et_date;
                            }
                        }
                        if($expense_customer==""){
                            foreach ($SS as $ss){
                                if($je->other_no==$ss->st_no){
                                    $expense_customer=$ss->st_customer_id;
                                    $treandate=$ss->st_date;
                                }
                            }
                        }
                        $TIN="";
                        foreach ($customers as $cus){
                            if($expense_customer==$cus->customer_id){
                                $result=$cus->tin_no;
                                $chunks = str_split($result, 3);
                                //Convert array to string.  Each element separated by the given separator.
                                $TIN = implode('-', $chunks);
                                if($cus->display_name!=""){
                                    $customer_mnam=$cus->display_name;
                                }else{
                                    $customer_mnam=$cus->f_name." ".$l_name;
                                }
                            }
                            
                        }
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$treandate!=""? date('m-d-Y',strtotime($treandate)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$customer_mnam;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$TIN;
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.='<div class="tooltip-custom">View Note';
                            $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                            $tablecontent.='</div>';
                        }
                        
                        
                        
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount-=$je->je_debit;
                            }
                            
                            
                            $tablecontent.=number_format(-$je->je_debit,2);
                          
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount+=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format($je->je_credit,2);
                           
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                            }
        
                        }else{
                            if($je->remark!="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->je_no;
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->je_name;
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                           
                            $tablecontent.=number_format($je->je_debit,2);
                           
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';        
                            }
                            else if($je->remark=="Cancelled"){
        
        
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="1" style="text-align:left;">';
                        
                        $tablecontent.=$je->je_no;
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->created_at!=""? date('m-d-Y',strtotime($je->created_at)) : '';
                        
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.=$je->je_name;
                       
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.=$je->remark;
                        }
                        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="1">';
                        if($je->remark!=""){
                            $tablecontent.='<div class="tooltip-custom">View Note';
                            $tablecontent.='<span class="tooltiptext">'.$je->cancellation_reason.'</span>';
                            $tablecontent.='</div>';
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">';
                        if($je->je_debit!=""){
                            if($je->remark==""){
                                $totaldescamount+=$je->je_debit;
                            }
                            
                           
                            $tablecontent.=number_format($je->je_debit,2);
                           
                        }
                        elseif($je->je_credit!=""){
                            if($je->remark==""){
                            $totaldescamount-=$je->je_credit;
                            }
                            
                            $tablecontent.=number_format("-".$je->je_credit,2);
                            
                        }
        
                        
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                            }
        
                        }
        
                        
                    }
        
                }
                
               
        
                    }
        
                }

                //by individual cost center end
        }
        
        $tablecontent.='<tr>';
        $tablecontent.='<td colspan="6" style="text-align:right;font-weight:bold;">Total</td>';  
        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;">'.number_format($totaldescamount,2).'</td>';  
        $tablecontent.='</tr>';
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>#</th><th>Date</th><th>Name</th><th>TIN No.</th><th>Remark</th><th>Note</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function Ledger_for_COA_Desc(Request $request){
        $sortsetting="";
        
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }


        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $chartofaccountbyaccounttype = DB::table('chart_of_accounts')
                ->select('coa_account_type')
                ->groupBy('coa_account_type')
                ->get();
        $chartofaccountbydetailtype = DB::table('chart_of_accounts')
                ->select('*')
                ->where('coa_active','1')
                ->groupBy('coa_detail_type')
                ->get();
        $chartofaccounts= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts");
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ledgerforcoadesc', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','chartofaccountbyaccounttype','chartofaccountbydetailtype','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function ledger_for_desc_by_date(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }

        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }


        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $chartofaccountbyaccounttype = DB::table('chart_of_accounts')
                ->select('coa_account_type')
                ->groupBy('coa_account_type')
                ->get();
        $chartofaccountbydetailtype = DB::table('chart_of_accounts')
                ->select('*')
                ->where('coa_active','1')
                ->groupBy('coa_detail_type')
                ->get();
        $chartofaccounts= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts");
       
        $VoucherCount=Voucher::count() + 1;
        
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')
                ->whereBetween('updated_at', [$FROM, $TO])
                ->get();
        $et_it = DB::table('et_item_details')
                ->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $ssasdsad="";
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach ($chartofaccountbyaccounttype as $item){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    
                    $tablecontent.='<td colspan="1">';
                    if($item->coa_account_type=="Cash"){
                        $tablecontent.='100';
                    }
                    elseif($item->coa_account_type=="Receivable Accounts")
                    {
                        $tablecontent.='200';
                    }
                    elseif($item->coa_account_type=="Inventories"){
                        $tablecontent.='300';
                    }
                    elseif($item->coa_account_type=="Prepayments"){
                        $tablecontent.='400';
                    }
                    elseif($item->coa_account_type=="Land, Building and Improvements"){
                        $tablecontent.='500';
                    }
                    elseif($item->coa_account_type=="Equipment and Improvements"){
                        $tablecontent.='520';
                    }
                    elseif($item->coa_account_type=="Improvements"){
                        $tablecontent.='550';
                    }
                    elseif($item->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='600';
                    }
                    elseif($item->coa_account_type=="Website Development Cost(Planning and Design)"){
                        $tablecontent.='650';
                    }
                    elseif($item->coa_account_type=="Payable Accounts"){
                        $tablecontent.='700';
                    }
                    elseif($item->coa_account_type=="Other Payables"){
                        $tablecontent.='720';
                    }
                    elseif($item->coa_account_type=="Equity"){
                        $tablecontent.='800';}
                    elseif($item->coa_account_type=="Revenues"){
                        $tablecontent.='900';}
                    elseif($item->coa_account_type=="Purchases, Freight In, and Subcontractor Expense"){
                        $tablecontent.='1000';}
                    elseif($item->coa_account_type=="Salaries and Wages"){
                        $tablecontent.='1100';}
                    elseif($item->coa_account_type=="Other Compensation"){
                        $tablecontent.='1200';}
                    elseif($item->coa_account_type=="Personnel Benefit Contributions"){
                        $tablecontent.='1300';}
                    elseif($item->coa_account_type=="Other Personnel Benefits"){
                        $tablecontent.='1400';}
                    elseif($item->coa_account_type=="Supplies Expenses"){
                        $tablecontent.='1500';}
                    elseif($item->coa_account_type=="Transportation and Training Expenses"){
                        $tablecontent.='1600';}
                    elseif($item->coa_account_type=="Utility Expenses"){
                        $tablecontent.='1700';}
                    elseif($item->coa_account_type=="Corporate Security"){
                        $tablecontent.='1800';}
                    elseif($item->coa_account_type=="Communication and Printing Expenses"){
                        $tablecontent.='1900';}
                    elseif($item->coa_account_type=="Taxes, Duties and Premiums"){
                        $tablecontent.='2000';}
                    elseif($item->coa_account_type=="Representation and Commision Expenses"){
                        $tablecontent.='2100';}
                    elseif($item->coa_account_type=="Awards and Rewards"){
                        $tablecontent.='2200';}
                    elseif($item->coa_account_type=="Rent/Lease Expenses"){
                        $tablecontent.='2300';}
                    elseif($item->coa_account_type==" Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses"){
                        $tablecontent.='2400';}
                    elseif($item->coa_account_type=="Repairs and Maintenance"){
                        $tablecontent.='2500';}
                    elseif($item->coa_account_type=="Professional Services"){
                        $tablecontent.='2600';}
                    elseif($item->coa_account_type=="Doubtful Accounts and Depreciation"){
                        $tablecontent.='2700';}
                    elseif($item->coa_account_type=="Gain and Losses"){
                        $tablecontent.='2800';}
                    elseif($item->coa_account_type=="Financial Expenses"){
                        $tablecontent.='2900';}
                    elseif($item->coa_account_type=="Other Company Expenses"){
                        $tablecontent.='3000';}
                    elseif($item->coa_account_type=="Intermidiate Accounts"){
                        $tablecontent.='3100';}
                    $tablecontent.='</td>';
                    $tablecontent.='<td colspan="3" style="font-weight:bold;">'.$item->coa_account_type.='</td>';
                       
                    $tablecontent.='</tr>';
                    $totaldescamounttotal=0;
                    foreach ($chartofaccountbydetailtype as $detail){
                        
        
                        if(strcmp($detail->coa_account_type, $item->coa_account_type)==-5){
                        
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';        
                        
                        $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->coa_code.'</a></td>';        
                        $tablecontent.='<td colspan="1" style="text-align:left;padding-left:5%;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc='.$detail->id.'">'.$detail->coa_detail_type.'</a></td>';        
                        $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->normal_balance.'</a></td>'; 
                        $totaldescamount=0;
                        foreach ($JournalEntry as $je){
                            if($je->remark==""){
                            if($detail->id==$je->je_account){
                                if($je->je_debit!=""){
                                    $totaldescamount+=$je->je_debit;
                                }
                                elseif($je->je_credit!=""){
                                    $totaldescamount-=$je->je_credit;
                                }
                            }
                            }
        
                        }
                        
                        $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.number_format($totaldescamount,2).'</a></td>';        
                        $tablecontent.='</tr>';
                        $totaldescamounttotal+=$totaldescamount;               
                            }
                          
        
                    }
                    
        
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">Total : </td>';
                    $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">'.number_format($totaldescamounttotal,2).'</td>';
                    $tablecontent.='</tr>';
        
                }
            }
            else if($CostCenterFilter=="By Cost Center"){
                foreach($all_cost_center_list as $ccl){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
                    
                        $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $chartofaccountbyaccounttype = DB::table('chart_of_accounts')
                                                ->select('coa_account_type')
                                                ->groupBy('coa_account_type')
                                                ->get();
                    foreach ($chartofaccountbyaccounttype as $item){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                        
                        $tablecontent.='<td colspan="1">';
                        if($item->coa_account_type=="Cash"){
                            $tablecontent.='100';
                        }
                        elseif($item->coa_account_type=="Receivable Accounts")
                        {
                            $tablecontent.='200';
                        }
                        elseif($item->coa_account_type=="Inventories"){
                            $tablecontent.='300';
                        }
                        elseif($item->coa_account_type=="Prepayments"){
                            $tablecontent.='400';
                        }
                        elseif($item->coa_account_type=="Land, Building and Improvements"){
                            $tablecontent.='500';
                        }
                        elseif($item->coa_account_type=="Equipment and Improvements"){
                            $tablecontent.='520';
                        }
                        elseif($item->coa_account_type=="Improvements"){
                            $tablecontent.='550';
                        }
                        elseif($item->coa_account_type=="Asset Contra Accounts"){
                            $tablecontent.='600';
                        }
                        elseif($item->coa_account_type=="Website Development Cost(Planning and Design)"){
                            $tablecontent.='650';
                        }
                        elseif($item->coa_account_type=="Payable Accounts"){
                            $tablecontent.='700';
                        }
                        elseif($item->coa_account_type=="Other Payables"){
                            $tablecontent.='720';
                        }
                        elseif($item->coa_account_type=="Equity"){
                            $tablecontent.='800';}
                        elseif($item->coa_account_type=="Revenues"){
                            $tablecontent.='900';}
                        elseif($item->coa_account_type=="Purchases, Freight In, and Subcontractor Expense"){
                            $tablecontent.='1000';}
                        elseif($item->coa_account_type=="Salaries and Wages"){
                            $tablecontent.='1100';}
                        elseif($item->coa_account_type=="Other Compensation"){
                            $tablecontent.='1200';}
                        elseif($item->coa_account_type=="Personnel Benefit Contributions"){
                            $tablecontent.='1300';}
                        elseif($item->coa_account_type=="Other Personnel Benefits"){
                            $tablecontent.='1400';}
                        elseif($item->coa_account_type=="Supplies Expenses"){
                            $tablecontent.='1500';}
                        elseif($item->coa_account_type=="Transportation and Training Expenses"){
                            $tablecontent.='1600';}
                        elseif($item->coa_account_type=="Utility Expenses"){
                            $tablecontent.='1700';}
                        elseif($item->coa_account_type=="Corporate Security"){
                            $tablecontent.='1800';}
                        elseif($item->coa_account_type=="Communication and Printing Expenses"){
                            $tablecontent.='1900';}
                        elseif($item->coa_account_type=="Taxes, Duties and Premiums"){
                            $tablecontent.='2000';}
                        elseif($item->coa_account_type=="Representation and Commision Expenses"){
                            $tablecontent.='2100';}
                        elseif($item->coa_account_type=="Awards and Rewards"){
                            $tablecontent.='2200';}
                        elseif($item->coa_account_type=="Rent/Lease Expenses"){
                            $tablecontent.='2300';}
                        elseif($item->coa_account_type==" Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses"){
                            $tablecontent.='2400';}
                        elseif($item->coa_account_type=="Repairs and Maintenance"){
                            $tablecontent.='2500';}
                        elseif($item->coa_account_type=="Professional Services"){
                            $tablecontent.='2600';}
                        elseif($item->coa_account_type=="Doubtful Accounts and Depreciation"){
                            $tablecontent.='2700';}
                        elseif($item->coa_account_type=="Gain and Losses"){
                            $tablecontent.='2800';}
                        elseif($item->coa_account_type=="Financial Expenses"){
                            $tablecontent.='2900';}
                        elseif($item->coa_account_type=="Other Company Expenses"){
                            $tablecontent.='3000';}
                        elseif($item->coa_account_type=="Intermidiate Accounts"){
                            $tablecontent.='3100';}
                        $tablecontent.='</td>';
                        $tablecontent.='<td colspan="3" style="font-weight:bold;">'.$item->coa_account_type.='</td>';
                           
                        $tablecontent.='</tr>';
                        $totaldescamounttotal=0;
                        foreach ($chartofaccountbydetailtype as $detail){
                            
            
                            if(strcmp($detail->coa_account_type, $item->coa_account_type)==-5){
                            
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';        
                            
                            $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->coa_code.'</a></td>';        
                            $tablecontent.='<td colspan="1" style="text-align:left;padding-left:5%;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc='.$detail->id.'">'.$detail->coa_detail_type.'</a></td>';        
                            $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->normal_balance.'</a></td>'; 
                            $totaldescamount=0;
                            foreach ($JournalEntry as $je){
                                if($ccl->cc_no==$je->je_cost_center){
                                        if($je->remark==""){
                                        if($detail->id==$je->je_account){
                                            if($je->je_debit!=""){
                                                $totaldescamount+=$je->je_debit;
                                            }
                                            elseif($je->je_credit!=""){
                                                $totaldescamount-=$je->je_credit;
                                            }
                                        }
                                        }
                                }
                                
            
                            }
                            
                            $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.number_format($totaldescamount,2).'</a></td>';        
                            $tablecontent.='</tr>';
                            $totaldescamounttotal+=$totaldescamount;               
                                }
                              
            
                        }
                        
            
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">Total : </td>';
                        $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">'.number_format($totaldescamounttotal,2).'</td>';
                        $tablecontent.='</tr>';
            
                    }
                }
            }

        }else{
            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
            $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
            foreach($all_cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
           
            $tablecontent.='</td>';
            $tablecontent.='</tr>';
            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                    $tablecontent.='<td colspan="4" style="text-align:center;font-weight:bold;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
            foreach ($chartofaccountbyaccounttype as $item){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';   
                
                $tablecontent.='<td colspan="1">';
                if($item->coa_account_type=="Cash"){
                    $tablecontent.='100';
                }
                elseif($item->coa_account_type=="Receivable Accounts")
                {
                    $tablecontent.='200';
                }
                elseif($item->coa_account_type=="Inventories"){
                    $tablecontent.='300';
                }
                elseif($item->coa_account_type=="Prepayments"){
                    $tablecontent.='400';
                }
                elseif($item->coa_account_type=="Land, Building and Improvements"){
                    $tablecontent.='500';
                }
                elseif($item->coa_account_type=="Equipment and Improvements"){
                    $tablecontent.='520';
                }
                elseif($item->coa_account_type=="Improvements"){
                    $tablecontent.='550';
                }
                elseif($item->coa_account_type=="Asset Contra Accounts"){
                    $tablecontent.='600';
                }
                elseif($item->coa_account_type=="Website Development Cost(Planning and Design)"){
                    $tablecontent.='650';
                }
                elseif($item->coa_account_type=="Payable Accounts"){
                    $tablecontent.='700';
                }
                elseif($item->coa_account_type=="Other Payables"){
                    $tablecontent.='720';
                }
                elseif($item->coa_account_type=="Equity"){
                    $tablecontent.='800';}
                elseif($item->coa_account_type=="Revenues"){
                    $tablecontent.='900';}
                elseif($item->coa_account_type=="Purchases, Freight In, and Subcontractor Expense"){
                    $tablecontent.='1000';}
                elseif($item->coa_account_type=="Salaries and Wages"){
                    $tablecontent.='1100';}
                elseif($item->coa_account_type=="Other Compensation"){
                    $tablecontent.='1200';}
                elseif($item->coa_account_type=="Personnel Benefit Contributions"){
                    $tablecontent.='1300';}
                elseif($item->coa_account_type=="Other Personnel Benefits"){
                    $tablecontent.='1400';}
                elseif($item->coa_account_type=="Supplies Expenses"){
                    $tablecontent.='1500';}
                elseif($item->coa_account_type=="Transportation and Training Expenses"){
                    $tablecontent.='1600';}
                elseif($item->coa_account_type=="Utility Expenses"){
                    $tablecontent.='1700';}
                elseif($item->coa_account_type=="Corporate Security"){
                    $tablecontent.='1800';}
                elseif($item->coa_account_type=="Communication and Printing Expenses"){
                    $tablecontent.='1900';}
                elseif($item->coa_account_type=="Taxes, Duties and Premiums"){
                    $tablecontent.='2000';}
                elseif($item->coa_account_type=="Representation and Commision Expenses"){
                    $tablecontent.='2100';}
                elseif($item->coa_account_type=="Awards and Rewards"){
                    $tablecontent.='2200';}
                elseif($item->coa_account_type=="Rent/Lease Expenses"){
                    $tablecontent.='2300';}
                elseif($item->coa_account_type==" Food, Notary and Extraordinary and Miscellaneous Expenses,Other Expenses"){
                    $tablecontent.='2400';}
                elseif($item->coa_account_type=="Repairs and Maintenance"){
                    $tablecontent.='2500';}
                elseif($item->coa_account_type=="Professional Services"){
                    $tablecontent.='2600';}
                elseif($item->coa_account_type=="Doubtful Accounts and Depreciation"){
                    $tablecontent.='2700';}
                elseif($item->coa_account_type=="Gain and Losses"){
                    $tablecontent.='2800';}
                elseif($item->coa_account_type=="Financial Expenses"){
                    $tablecontent.='2900';}
                elseif($item->coa_account_type=="Other Company Expenses"){
                    $tablecontent.='3000';}
                elseif($item->coa_account_type=="Intermidiate Accounts"){
                    $tablecontent.='3100';}
                $tablecontent.='</td>';
                $tablecontent.='<td colspan="3" style="font-weight:bold;">'.$item->coa_account_type.='</td>';
                   
                $tablecontent.='</tr>';
                $totaldescamounttotal=0;
                foreach ($chartofaccountbydetailtype as $detail){
                    
    
                    if(strcmp($detail->coa_account_type, $item->coa_account_type)==-5){
                    
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';        
                    
                    $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->coa_code.'</a></td>';        
                    $tablecontent.='<td colspan="1" style="text-align:left;padding-left:5%;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc='.$detail->id.'">'.$detail->coa_detail_type.'</a></td>';        
                    $tablecontent.='<td colspan="1"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.$detail->normal_balance.'</a></td>'; 
                    $totaldescamount=0;
                    foreach ($JournalEntry as $je){
                        if($je->remark==""){
                        if($detail->id==$je->je_account){
                            if($je->je_debit!=""){
                                $totaldescamount+=$je->je_debit;
                            }
                            elseif($je->je_credit!=""){
                                $totaldescamount-=$je->je_credit;
                            }
                        }
                        }
    
                    }
                    
                    $tablecontent.='<td style="text-align:right;vertical-align:middle;font-weight:bold;"><a class="ASubButton" href="ledgerforcoadesc_sub?desc={{$detail->id}}">'.number_format($totaldescamount,2).'</a></td>';        
                    $tablecontent.='</tr>';
                    $totaldescamounttotal+=$totaldescamount;               
                        }
                      
    
                }
                
    
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">Total : </td>';
                $tablecontent.='<td colspan="3" style="font-weight:bold;text-align:right;">'.number_format($totaldescamounttotal,2).'</td>';
                $tablecontent.='</tr>';
    
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="20%">Code</th><th width="30%">Account Type</th><th width="20%">Normal Balance</th>'
                .'<th style="text-align:right;" width="20%">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function Budget_Summary_By_Date(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingex="WHERE et_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingex="";
                $sortsettingjournal="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        $ETran = DB::connection('mysql')->select("SELECT * FROM expense_transactions
                ".$sortsettingex);
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }        
        $et_account_details= DB::table('et_account_details')->get();
        $COA= ChartofAccount::all();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         
        $all_cost_center_list= CostCenter::all();
        $budgets= Budgets::all();
        $tablecontent="";
        if($CostCenterFilter=="All"){
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'ASC')->get();    
        }else{
            $cost_center_list= DB::connection('mysql')->select("SELECT * FROM cost_center WHERE 
            cc_no='".$CostCenterFilter."' 
            ORDER BY cc_type_code ASC"); 
            
        }
        foreach($cost_center_list as $ccl){
            $budgets= Budgets::where('budget_cost_center',$ccl->cc_no)->get();   
            $tablecontent.='<tr>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$ccl->cc_name_code;
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$ccl->cc_name;
            $tablecontent.='</td>';
            if($ccl->cc_use_quotation=="Yes"){
                for($c=0;$c<12;$c++){
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.='</td>';
                }
                $tablecontent.='<td style="vertical-align:middle;">';
                $totalexpense=0;
                foreach ($ETran as $et){
                    if ($et->remark!="Cancelled"){
                        foreach ($JournalEntry as $JE){
                            
                            if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                
                                if ($et->et_no==$JE->other_no){
                                    
                                    if ($JE->je_credit!=""){
                                        if ($JE->je_transaction_type=="Supplier Credit"){
                                            $totalexpense+=$JE->je_credit;
                                        }else{
                                            $totalexpense+=$JE->je_credit;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($totalexpense,2);
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $totalbudget=0;
                foreach ($budgets as $budget){
                    if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_type=="Bid of Quotation"){
                    $totalbudget=$budget->budget_month;
                    }
                }
                $tablecontent.=number_format($totalbudget,2);
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=number_format($totalexpense-$totalbudget,2);
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                if($totalbudget!=0){
                    $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                }else{
                    $tablecontent.="N/A";
                }
                
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
            }else{
                if($CostCenterFilter=="All"){
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-01-01'));
                        $datetime3 = date_create(date('Y-01-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m1!=""){
                                $totalbudget+=$budget->m1;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-02-01'));
                        $datetime3 = date_create(date('Y-02-29'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m2!=""){
                                $totalbudget+=$budget->m2;
                            }
                            
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-03-01'));
                        $datetime3 = date_create(date('Y-03-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m3!=""){
                                $totalbudget+=$budget->m3;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-04-01'));
                        $datetime3 = date_create(date('Y-04-30'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m4!=""){
                                $totalbudget+=$budget->m4;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-05-01'));
                        $datetime3 = date_create(date('Y-05-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m5!=""){
                                $totalbudget+=$budget->m5;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';


                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-06-01'));
                        $datetime3 = date_create(date('Y-06-30'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m6!=""){
                                $totalbudget+=$budget->m6;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-07-01'));
                        $datetime3 = date_create(date('Y-07-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m7!=""){
                                $totalbudget+=$budget->m7;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-08-01'));
                        $datetime3 = date_create(date('Y-08-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m8!=""){
                                $totalbudget+=$budget->m8;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';


                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-09-01'));
                        $datetime3 = date_create(date('Y-09-30'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m9!=""){
                                $totalbudget+=$budget->m9;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-10-01'));
                        $datetime3 = date_create(date('Y-10-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m10!=""){
                                $totalbudget+=$budget->m10;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-11-01'));
                        $datetime3 = date_create(date('Y-11-30'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m11!=""){
                                $totalbudget+=$budget->m11;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalexpense=0;
                    foreach ($ETran as $et){
                        $datetime1 = date_create($et->et_date);
                        $datetime2 = date_create(date('Y-12-01'));
                        $datetime3 = date_create(date('Y-12-31'));
                        $interval = date_diff($datetime1, $datetime2);
                        $until = date_diff($datetime1, $datetime3);
                        //echo $interval->format('%R%a days');
                        //$tablecontent.=$et->et_date."<br>";
                        //$tablecontent.=date('Y-01-01')."<br>";
                        //$tablecontent.=$interval->format('%R start')."<br>";
                        //$tablecontent.=$until->format('%R end')."<br>";
                        if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                            foreach ($JournalEntry as $JE){
                                
                                if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                    
                                    if ($et->et_no==$JE->other_no){
                                        
                                        if ($JE->je_credit!=""){
                                            if ($JE->je_transaction_type=="Supplier Credit"){
                                                $totalexpense+=$JE->je_credit;
                                            }else{
                                                $totalexpense+=$JE->je_credit;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($totalexpense,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $totalbudget=0;
                    if($FROM==""){
                        $year=date('Y');
                    }else{
                        $year=date('Y',strtotime($FROM));
                    }
                    foreach ($budgets as $budget){
                        if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                            if($budget->m12!=""){
                                $totalbudget+=$budget->m12;
                            }
                        }
                    }
                    $tablecontent.=number_format($totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($totalexpense-$totalbudget,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($totalbudget!=0){
                        $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                    }else{
                        $tablecontent.="N/A";
                    }
                    
                    $tablecontent.='</td>';

                    $tablecontent.='<td style="vertical-align:middle;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    
                    $tablecontent.='<td style="vertical-align:middle;">';
                    
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';  
                }else{
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
           
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
           
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';


            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            
            $tablecontent.='</td>';


            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
           
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';

            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='<td style="vertical-align:middle;">';
            
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
           
            $tablecontent.='</td>';
            $tablecontent.='</tr>'; 
            foreach($COA as $coa){
                foreach ($budgets as $budget){
                if($coa->coa_code==$budget->budget_chart_of_accounts && $budget->budget_cost_center==$ccl->cc_no && $budget->budget_type=='Monthly'){
                    if($budget->m1!="" || $budget->m2!="" || $budget->m3!="" || $budget->m4!="" || $budget->m5!="" || $budget->m6!="" || $budget->m7!="" || $budget->m8!="" || $budget->m9!="" ||$budget->m10!="" || $budget->m11!="" || $budget->m12!=""){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right">';
                        $tablecontent.=$coa->coa_name;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-01-01'));
                            $datetime3 = date_create(date('Y-01-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m1!=""){
                                    $totalbudget+=$budget->m1;
                                }
                            }
                       
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-02-01'));
                            $datetime3 = date_create(date('Y-02-29'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m2!=""){
                                    $totalbudget+=$budget->m2;
                                }
                                
                            }
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-03-01'));
                            $datetime3 = date_create(date('Y-03-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m3!=""){
                                    $totalbudget+=$budget->m3;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-04-01'));
                            $datetime3 = date_create(date('Y-04-30'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m4!=""){
                                    $totalbudget+=$budget->m4;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-05-01'));
                            $datetime3 = date_create(date('Y-05-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m5!=""){
                                    $totalbudget+=$budget->m5;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-06-01'));
                            $datetime3 = date_create(date('Y-06-30'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m6!=""){
                                    $totalbudget+=$budget->m6;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-07-01'));
                            $datetime3 = date_create(date('Y-07-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m7!=""){
                                    $totalbudget+=$budget->m7;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-08-01'));
                            $datetime3 = date_create(date('Y-08-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m8!=""){
                                    $totalbudget+=$budget->m8;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-09-01'));
                            $datetime3 = date_create(date('Y-09-30'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m9!=""){
                                    $totalbudget+=$budget->m9;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-10-01'));
                            $datetime3 = date_create(date('Y-10-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m10!=""){
                                    $totalbudget+=$budget->m10;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-11-01'));
                            $datetime3 = date_create(date('Y-11-30'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m11!=""){
                                    $totalbudget+=$budget->m11;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalexpense=0;
                        foreach ($ETran as $et){
                            $datetime1 = date_create($et->et_date);
                            $datetime2 = date_create(date('Y-12-01'));
                            $datetime3 = date_create(date('Y-12-31'));
                            $interval = date_diff($datetime1, $datetime2);
                            $until = date_diff($datetime1, $datetime3);
                            //echo $interval->format('%R%a days');
                            //$tablecontent.=$et->et_date."<br>";
                            //$tablecontent.=date('Y-01-01')."<br>";
                            //$tablecontent.=$interval->format('%R start')."<br>";
                            //$tablecontent.=$until->format('%R end')."<br>";
                            if ($et->remark!="Cancelled" && $interval->format('%R')=="-" && $until->format('%R')=="+"){
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->remark!="Cancelled" && $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($et->et_no==$JE->other_no){
                                            
                                            if ($JE->je_credit!=""){
                                                if ($JE->je_transaction_type=="Supplier Credit"){
                                                    $totalexpense+=$JE->je_credit;
                                                }else{
                                                    $totalexpense+=$JE->je_credit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        $tablecontent.=number_format($totalexpense,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $totalbudget=0;
                        if($FROM==""){
                            $year=date('Y');
                        }else{
                            $year=date('Y',strtotime($FROM));
                        }
                        
                            if ($budget->budget_cost_center==$ccl->cc_no && $budget->budget_year==$year && $budget->budget_type=='Monthly'){
                                if($budget->m12!=""){
                                    $totalbudget+=$budget->m12;
                                }
                            }
                        
                        $tablecontent.=number_format($totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalexpense-$totalbudget,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($totalbudget!=0){
                            $tablecontent.=number_format((($totalexpense-$totalbudget)/$totalbudget)*100,1)."%";
                        }else{
                            $tablecontent.="N/A";
                        }
                        
                        $tablecontent.='</td>';
            
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                       
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                }
                //budget per coa
             

                //budget er coa end
            }      
                } 
            
            }
            
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;background-color:white;">'
                .'<thead><tr>'
                .'<th width="10%">Code</th><th width="30%">Cost Center</th>'
                .'<th width="20%">January Actual</th><th width="20%">January Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">February Actual</th><th width="20%">February Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">March Actual</th><th width="20%">March Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">April Actual</th><th width="20%">April Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">May Actual</th><th width="20%">May Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">June Actual</th><th width="20%">June Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">July Actual</th><th width="20%">July Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">August Actual</th><th width="20%">August Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">September Actual</th><th width="20%">September Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">October Actual</th><th width="20%">October Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">November Actual</th><th width="20%">November Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">December Actual</th><th width="20%">December Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'<th width="20%">YTD Actual</th><th width="20%">YTD Budget</th><th width="20%">Var PHP</th><th width="10%">Var %</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function GetCostCenterBudget(Request $request){
        $Budget = Budgets::where('budget_year',$request->Year)->get();
        return $Budget;
    }
    public function SaveBudget(Request $request){
        
        foreach($request->cost_center_budget as $ccb){
           if($ccb['budget_no']!=""){
            $Budget =Budgets::find($ccb['budget_no']);
           }else{
            $Budget = new Budgets;
            $Budget->budget_no=Budgets::count()+1;
           }
           $Budget->budget_year=$request->BudgetYear;
           $Budget->budget_cost_center=$ccb['cc_no'];
           $Budget->budget_amount=$ccb['budget_amount'];
           $Budget->save();
        }
        
    }
    public function BudgetSummaryReport(Request $request){
        $sortsetting="";
        if($request->sort){
            $sortsetting=$request->sort;
        }else{
            
        }
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::all();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        // $Employees= DB::connection('mysql2')->select("SELECT * FROM employee_info
        // JOIN employee_job_detail ON employee_job_detail.emp_id=employee_info.employee_id ORDER BY fname ASC");
        // $Employee_Email= DB::connection('mysql2')->select("SELECT * FROM employee_email_address");
        // $Employee_contact= DB::connection('mysql2')->select("SELECT * FROM employee_alternate_contact");
        date_default_timezone_set('Asia/Manila');
        $Report = Report::all();
        // Then call the date functions
        $date = date('l, d F Y h:i a \G\T\MO');
        
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.budget_summary_report', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
         
    }
    public function Employee_Contact_List(Request $request){
        $sortsetting="";
        if($request->sort){
            $sortsetting=$request->sort;
        }else{
            
        }
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::all();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        $Employees= DB::connection('mysql2')->select("SELECT * FROM employee_info
        JOIN employee_job_detail ON employee_job_detail.emp_id=employee_info.employee_id ORDER BY fname ASC");
        $Employee_Email= DB::connection('mysql2')->select("SELECT * FROM employee_email_address");
        $Employee_contact= DB::connection('mysql2')->select("SELECT * FROM employee_alternate_contact");
        date_default_timezone_set('Asia/Manila');
        $Report = Report::all();
        // Then call the date functions
        $date = date('l, d F Y h:i a \G\T\MO');
        
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.employeecontact', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','Report','date','Employee_contact','Employee_Email','Employees','jounalcount','customers', 'products_and_services','JournalEntry'));
        
    }
    public function Customer_Contact_List(Request $request){
        $sortsetting="";
        if($request->sort){
            $sortsetting=$request->sort;
        }else{
            
        }
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::all();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.customercontact', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function SalesbyCustomer(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.salesbycustomer', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function SalesbyProduct(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $STProduct= DB::table('st_invoice')
                        ->select('st_i_product')
                        ->groupBy('st_i_product')
                        ->get();
        $SCredit= DB::table('st_credit_notes')
                        ->select('st_cn_product')
                        ->groupBy('st_cn_product')
                        ->get();
        $combinedarray=array();
        foreach($SCredit as $ST){
            
                    $combinedarray[]=$ST->st_cn_product;
            
        }
        
        foreach($STProduct as $ST){
            
                    $combinedarray[]=$ST->st_i_product;
            
        }
        
        $nodup=array_unique($combinedarray);
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $STARRAY=array();
        $emptyArray = array();
        foreach($st_invoice as $as){
            
                    $STARRAY['st_i_rate']  = $as->st_i_rate ;
                    $STARRAY['st_i_product']  = $as->st_i_product ;
                    array_push($emptyArray, $STARRAY);
            
        }
        foreach($st_credit_notes as $as){
            
                    $STARRAY['st_i_rate']  = "-".$as->st_cn_rate ;
                    $STARRAY['st_i_product']  = $as->st_cn_product ;
                    array_push($emptyArray, $STARRAY);
            
        }
        //$input=$emptyArray;
        $input = array_map("unserialize", array_unique(array_map("serialize", $emptyArray)));
        //return $input;
        
        
        
        
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.salesbyproduct', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','input','nodup','SCredit','st_credit_notes','STProduct','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function Journal_Summary(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.journal_summary', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function sub_ledger(Request $request){
        $cao_id=$request->chart_of_accounts;
        $customer_id=$request->id;
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.sub_ledger', compact('customer_id','cao_id','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function sub_ledger_by_customer(Request $request){
        $CCCOOOOAAA= ChartofAccount::where('coa_active','1')->get();
        $a = 'Account Receivable';
        $b = 'Accounts Receivable';
        $coa_id="";
        foreach($CCCOOOOAAA as $coa){
            if (strpos($coa->coa_name, $a) !== false || strpos($coa->coa_name, $b) !== false) {
                $coa_id=$coa->id;
            }
        }
        //return $coa_id;
        $cao_id=$coa_id;
        $customer_id=$request->id;
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ledger_by_customer', compact('customer_id','cao_id','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function sub_ledger_by_supplier(Request $request){
        $CCCOOOOAAA= ChartofAccount::where('coa_active','1')->get();
        $a = 'Account Payable';
        $b = 'Accounts Payable';
        $coa_id="";
        foreach($CCCOOOOAAA as $coa){
            if (strpos($coa->coa_name, $a) !== false || strpos($coa->coa_name, $b) !== false) {
                $coa_id=$coa->id;
            }
        }
        //return $coa_id;
        $cao_id=$coa_id;
        $customer_id=$request->id;
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ledger_by_supplier', compact('customer_id','cao_id','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function sub_ledger_by_employee(Request $request){
        $CCCOOOOAAA= ChartofAccount::where('coa_active','1')->get();
        $a = 'Due from Employees';
        $b = 'Due from Employee';
        $coa_id="";
        foreach($CCCOOOOAAA as $coa){
            if (strpos($coa->coa_name, $a) !== false || strpos($coa->coa_name, $b) !== false) {
                $coa_id=$coa->id;
            }
        }
        //return $coa_id;
        $cao_id=$coa_id;
        $customer_id=$request->id;
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ledger_by_employee', compact('customer_id','cao_id','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function General_Ledger(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Payment"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Payment"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.general_ledger', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','expense_transactions','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Trial_Balance(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        foreach($expense_transactions as $et){
            
            
                $ExpensesTotal=$ExpensesTotal+$et->et_ad_total;
                $Cash=$Cash+$et->et_ad_total;
            if($et->et_account=="Cash and equivalents"){
                
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Invoice"){
                $AccountRecievable=$AccountRecievable+$SS->st_balance;
                $Sales=$Sales+$SS->st_balance;
            }
            if($SS->st_type=="Credit Note"){
                $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                $Sales=$Sales+$SS->st_amount_paid;
            }
            if($SS->st_type=="Sales Receipt"){
                $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                //$Sales=$Sales-$SS->st_amount_paid;
            }
            
        }
        foreach($SalesTransaction as $SS){
            if($SS->st_type=="Sales Receipt"){
                $Cash=$Cash-$SS->st_amount_paid;
            }
        }
        foreach($JournalEntry as $J){
            if($J->je_credit!=""){
                $Cash=$Cash+$J->je_credit;
            }
            if($J->je_debit!=""){
                $Cash=$Cash-$J->je_debit;
            }
            
            
        }
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.trial_balance', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','ExpensesTotal','Sales','Cash','AccountRecievable','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function RecentTransactions(Request $request){
        $sortsetting="";
        $FROM = date('Y-m-d', strtotime('-4 days'));
        $TO = date('Y-m-d');
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.RecentTransactionList', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function ProfitAndLostComparison(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ProfitAndLosscomparison', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function ProfitandLossasPercentageTotal(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ProfitAndLossaspercenttotal', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function BalanceSheetByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsettingjournalpast="WHERE created_at <'".$FROM."'  AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            $sortsettingjournalpast="WHERE created_at =''  AND";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        $sortjournalpast=" je_cost_center='".$CostCenterFilter."'";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortjournalpast="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournalpast="WHERE created_at <'".$FROM."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
                $sortsettingjournalpast="WHERE created_at =''";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $sortsettingjournalssss=" WHERE je_cost_center='".$CostCenterFilter."' ";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortsettingjournalssss="";
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        
        $JournalEntryformpast=DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpast.$sortjournalpast ." 
                            ORDER BY created_at ASC");
        
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $cost_center_list=CostCenter::all();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
        $coa_sub_account_type=ChartofAccount::groupBy('coa_sub_account')->orderBy('coa_detail_type','ASC')->get();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }        
        $et_account_details= DB::table('et_account_details')->get();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">';
                $tablecontent.=' Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalIncomeTotal=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $TotalFixedAsset=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ( $Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        
                        
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ( $Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalLiabilities=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalRE=0;
                // foreach ($COA as $coa){
                    
                //     if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotalRE+=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotalRE-=$JE->je_debit;
                //                 }
                //             }
                //         }
                        
                //     }
                    
                // }
                $CustomerTotal2RE=0;
                $RetainedEarningsSubs=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarningsSubs+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotalRE-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotalRE-=$coa->coa_balance;
                    // }
                   
                    // if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                    //             if ($JE->je_credit!=""){
                    //                 $CustomerTotal2RE-=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal2RE+=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                    // if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                    //     foreach ($JournalEntryformpast as $JE){
                    //         //$tablecontent.=$JE->je_no."\n";
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                    //             if ($JE->je_credit!=""){
                    //                 $RetainedEarningsSubs-=$JE->je_credit;
                    //                 //$tablecontent.=$RetainedEarningsSubs." c";
                    //             }else{
                    //                 $RetainedEarningsSubs+=$JE->je_debit;
                    //                 //$tablecontent.=$RetainedEarningsSubs." d";
                    //             }
                                
                    //         }
                    //     }
                        
                    // }
                }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotalRE-$CustomerTotal2RE),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotalRE-$CustomerTotal2RE);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                       
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                        
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalEquityOthers=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='</tr>';
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $sortsettingjournalssss=" WHERE je_cost_center='".$ccl->cc_no."' ";
                    if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
                        $sortsettingjournalssss="";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                        ".$sortsettingjournal.$sortjournal." 
                                        ORDER BY created_at ASC");
                    
                    $JournalEntryformpast=DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpast.$sortjournalpast." 
                            ORDER BY created_at ASC");
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                    
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    //OO2
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    $TotalIncomeTotal=0;
                    foreach ($coa_sub_account_type as $coa){
                        if ($coa->coa_sub_account=="Bank"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                            $tablecontent.='</tr>';
                            foreach ($COA as $Coa){
                                if ($Coa->coa_sub_account=="Bank"){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $coa_name_total+=$Coa->coa_balance;
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';
                                }
                            }
                            $TotalIncomeTotal+=$IncomeTotal;
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='</tr>';
                            
                        }
                    }
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    
                    foreach ($coa_sub_account_type as $coa){
                        if ($coa->coa_sub_account=="Cash"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                            $tablecontent.='</tr>';
                            foreach ($COA as $Coa){
                                if ($Coa->coa_sub_account=="Cash"){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $coa_name_total+=$Coa->coa_balance;
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';
                                }
                            }
                            $TotalIncomeTotal+=$IncomeTotal;
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='</tr>';
                            
                        }
                    }
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    
                    foreach ($coa_sub_account_type as $coa){
                        if ($coa->coa_sub_account=="Receivable Accounts"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                            $tablecontent.='</tr>';
                            foreach ($COA as $Coa){
                                if ($Coa->coa_sub_account=="Receivable Accounts"){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $coa_name_total+=$Coa->coa_balance;
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';
                                }
                            }
                            $TotalIncomeTotal+=$IncomeTotal;
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='</tr>';
                            
                        }
                    }
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    
                    foreach ($coa_sub_account_type as $coa){
                        if ($coa->coa_sub_account=="Inventories"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                            $tablecontent.='</tr>';
                            foreach ($COA as $Coa){
                                if ($Coa->coa_sub_account=="Inventories"){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $coa_name_total+=$Coa->coa_balance;
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';
                                }
                            }
                            $TotalIncomeTotal+=$IncomeTotal;
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='</tr>';
                            
                        }
                    }
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    
                    foreach ($coa_sub_account_type as $coa){
                        if ($coa->coa_sub_account=="Prepayments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                            $tablecontent.='</tr>';
                            foreach ($COA as $Coa){
                                if ($Coa->coa_sub_account=="Prepayments"){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $coa_name_total+=$Coa->coa_balance;
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';
                                }
                            }
                            $TotalIncomeTotal+=$IncomeTotal;
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='</tr>';
                            
                        }
                    }
                    $tablecontent.='<tr>';
                   
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='</tr>';
    
                    $IncomeTotal=0;
                    $TotalFixedAsset=0;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style=""></td>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                    $tablecontent.='</tr>';
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                                $IncomeTotal-=$coa_name_total;
                            }else{
                                $IncomeTotal+=$coa_name_total;
                            }
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                    }
                    $TotalFixedAsset+=$IncomeTotal;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='</tr>';
    
                    $IncomeTotal=0;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style=""></td>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                    $tablecontent.='</tr>';
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                    }
                    $TotalFixedAsset+=$IncomeTotal;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:3px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    $TotalLiabilities=0;
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                    }
                    $TotalLiabilities+=$IncomeTotal;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="border-bottom:2px dotted #ccc"></td>';
                    $tablecontent.='</tr>';
    
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                    }
                    $TotalLiabilities+=$IncomeTotal;
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                    $tablecontent.='</tr>';
                    
                    $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                    $tablecontent.='</tr>';
                    
                    $tablecontent.='<tr>';
                    $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                    $CustomerTotalRE=0;
                    $data=Advance::first();
                    if(!empty($data)){
                        $CustomerTotalRE+=$data->advance_beginning_balance;
                    }
                    foreach ($COA as $coa){
                        //experimental retained earning
                        // if ($coa->coa_sub_account=="Bank"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        // if ($coa->coa_sub_account=="Cash on Hand"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        // if ($coa->coa_sub_account=="Receivable Accounts"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        // if ($coa->coa_sub_account=="Inventories"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        
                        // if ($coa->coa_sub_account=="Prepayments"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        
                        // }
                        // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                        //     $CustomerTotalRE+=$coa->coa_balance;
                        // }
                        
                        // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                        //     $CustomerTotalRE-=$coa->coa_balance;
                        // }
                        // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                        //     $CustomerTotalRE-=$coa->coa_balance;
                        // }
                        // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        //     foreach ($JournalEntryformpast as $JE){
                        //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                        //             if ($JE->je_credit!=""){
                        //                 $CustomerTotalRE+=$JE->je_credit;
                        //             }else{
                        //                 $CustomerTotalRE-=$JE->je_debit;
                        //             }
                        //         }
                        //     }
                        // }
                    }
                    $CustomerTotal2RE=0;
                    // foreach ($COA as $coa){
                        
                    //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                    //         foreach ($JournalEntryformpast as $JE){
                    //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                    //                 if ($JE->je_credit!=""){
                    //                     $CustomerTotal2RE-=$JE->je_credit;
                    //                 }else{
                    //                     $CustomerTotal2RE+=$JE->je_debit;
                    //                 }
                    //             }
                    //         }
                    //     }
                    // }
                    $tablecontent.=number_format($CustomerTotalRE-$CustomerTotal2RE,2);
                    $RetainedEarnings=$CustomerTotalRE-$CustomerTotal2RE;
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                    $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                    $CustomerTotal=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal+=$JE->je_credit;
                                    }else{
                                        $CustomerTotal-=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $CustomerTotal2=0;
                    foreach ($COA as $coa){
                        if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $CustomerTotal2-=$JE->je_credit;
                                    }else{
                                        $CustomerTotal2+=$JE->je_debit;
                                    }
                                }
                            }
                        }
                    }
                    $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    $IncomeTotal=0;
                    $TotalEquityOthers=0;
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                            if($Coa->coa_name=="Prior Period Adjustments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total-=$Coa->coa_balance;
                                $IncomeTotal-=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }else{
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                             
                        }
                    }
                    $TotalEquityOthers-=$IncomeTotal;
                    $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                    $tablecontent.='</tr>';
                    //OO2END
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //OO3
            $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalIncomeTotal=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $TotalFixedAsset=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalLiabilities=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" ||  $Coa->coa_account_type=="Payable Accounts" ){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
               
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalRE=0;
                $data=Advance::first();
                    if(!empty($data)){
                        $CustomerTotalRE+=$data->advance_beginning_balance;
                    }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotalRE+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotalRE-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotalRE-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                    //             if ($JE->je_credit!=""){
                    //                 $CustomerTotalRE+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotalRE-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                
                $CustomerTotal2RE=0;
                $RetainedEarningsSubs=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2RE-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2RE+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpast as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubs-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubs+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotalRE-$CustomerTotal2RE),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotalRE-$CustomerTotal2RE);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalEquityOthers=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='</tr>';
            //OO3END
            
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th colspan="3" width="60%"></th>'.
                '<th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function BalanceSheetComparisonByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $PeriodComparison=$request->PeriodComparison;
        if($PeriodComparison=="Last Month"){
            $FROMpv=strtotime($request->FROM.' -1 month');
            $TOpv=strtotime($request->FROM.' -1 month');
        }else{
            $FROMpv=strtotime($request->FROM.' -1 year');
            $TOpv=strtotime($request->TO.' -1 year');
        }
        
        $DateRange="Total";
        $DateRangepy="Total(PY)";
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsettingjournalpv="WHERE created_at BETWEEN '".$FROMpv."' AND '".$TOpv."' AND";
        $sortsettingjournalpast="WHERE created_at < '".$FROM."' AND";
        $sortsettingjournalpastpv="WHERE created_at < '".$FROMpv."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingpv="";
            $sortsettingjournalpv="";
            $sortsettingjournalpast="WHERE created_at = '' AND";
            $sortsettingjournalpastpv="WHERE created_at = '' AND";
        }else{
            if($PeriodComparison=="Last Month"){
                $FROMpv=strtotime($request->FROM.' -1 month');
                $TOpv=strtotime($request->FROM.' -1 month');
            }else{
                $FROMpv=strtotime($request->FROM.' -1 year');
                $TOpv=strtotime($request->TO.' -1 year');
            }
            $FROMpv=date('Y-m-d', $FROMpv);
            $TOpv=date('Y-m-d', $TOpv);
            $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingpv="WHERE st_date BETWEEN '".$FROMpv."' AND '".$TOpv."'";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
            $sortsettingjournalpv="WHERE created_at BETWEEN '".$FROMpv."' AND '".$TOpv."' AND";
            $sortsettingjournalpast="WHERE created_at < '".$FROM."' AND";
            $sortsettingjournalpastpv="WHERE created_at < '".$FROMpv."' AND";
            $DateRange=date('m-d-Y',strtotime($FROM))."<br>to<br>".date('m-d-Y',strtotime($TO));
            $DateRangepy=date('m-d-Y',strtotime($FROMpv))."<br>to<br>".date('m-d-Y',strtotime($TOpv));
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal="  je_cost_center='".$CostCenterFilter."'";
        }
        if($sortsettingjournalpv==""){
            $sortjournalpv="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournalpv="  je_cost_center='".$CostCenterFilter."'";
        }
        $sortjournalpast="  je_cost_center='".$CostCenterFilter."'";
        $sortjournalpvpast="  je_cost_center='".$CostCenterFilter."'";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortjournalpv="";
            $sortjournalpast="";
            $sortjournalpvpast="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournalpv="WHERE created_at BETWEEN '".$FROMpv."' AND '".$TOpv."'";
            $sortsettingjournalpast="WHERE created_at < '".$FROM."'";
            $sortsettingjournalpastpv="WHERE created_at < '".$FROMpv."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingpv="";
                $sortsettingjournal="";
                $sortsettingjournalpv="";
                $sortsettingjournalpast="WHERE created_at = ''";
                $sortsettingjournalpastpv="WHERE created_at = ''";
            }
        }

        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $SalesTransactionpv= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsettingpv." 
                            ORDER BY st_no ASC");                     
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $JournalEntryformpast= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpast.$sortjournalpast." 
                            ORDER BY created_at ASC");
        $JournalEntrypv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpv.$sortjournalpv." 
                            ORDER BY created_at ASC");
        $JournalEntryformpastpv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpastpv.$sortjournalpvpast." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $cost_center_list=CostCenter::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        $expense_transactionspv= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROMpv, $TOpv])
                ->get();
        if($filtertemplate=="All"){
            $expense_transactionspv= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();  
            $JournalEntrypv = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();     
        }
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $coa_sub_account_type=ChartofAccount::groupBy('coa_sub_account')->orderBy('coa_detail_type','ASC')->get();
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get(); 
        $et_account_details= DB::table('et_account_details')->get();
        $tablecontent="";
        

        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                //CC1
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalIncomeTotal=0;
                $TotalIncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalFixedAsset=0;
                $TotalFixedAssetpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotalpv-=$coa_name_totalpv;
                        }else{
                            $IncomeTotalpv+=$coa_name_totalpv;
                        }
                        
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv+$TotalFixedAssetpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalLiabilities=0;
                $TotalLiabilitiespv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotalpv+$TotalFixedAssetpv)-$TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $RetainedEarningspv=0;
                $RetainedEarningsSubs=0;
                $RetainedEarningsSubspv=0;
                
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarningsSubs+=$data->advance_beginning_balance;
                    $RetainedEarningsSubspv+=$data->advance_beginning_balance;
                    
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                    //             if ($JE->je_credit!=""){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpast as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubs-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubs+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2),2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotalpv+=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotalpv-=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $CustomerTotal2pv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2pv-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2pv+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpastpv as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubspv-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubspv+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubspv+($CustomerTotalpv-$CustomerTotal2pv),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2);
                $RetainedEarningspv=$RetainedEarningsSubspv+($CustomerTotalpv-$CustomerTotal2pv);
                $tablecontent.='</td>';

                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotalpv+=$JE->je_credit;
                                }else{
                                    $CustomerTotalpv-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2pv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2pv-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2pv+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotalpv-$CustomerTotal2pv,2);
                $tablecontent.='</td>';

                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalEquityOthers=0;
                $TotalEquityOtherspv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv-=$Coa->coa_balance;
                            $IncomeTotalpv-=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv+=$Coa->coa_balance;
                            $IncomeTotalpv+=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                         
                    }    
                    
                }
                $TotalEquityOthers+=$IncomeTotal;
                $TotalEquityOtherspv+=$IncomeTotalpv;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarningspv+($CustomerTotalpv-$CustomerTotal2pv)+$TotalEquityOtherspv,2).'</td>';
                $tablecontent.='</tr>';
                //CC1END
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                    $sortjournalpv=" je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    if($sortsettingjournalpv==""){
                        $sortjournalpv="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournalpv="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    $JournalEntrypv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournalpv.$sortjournalpv." 
                    ORDER BY created_at ASC");
                    $JournalEntryformpast= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournalpast.$sortjournalpast." 
                    ORDER BY created_at ASC");
                    $JournalEntryformpastpv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournalpastpv.$sortjournalpvpast." 
                    ORDER BY created_at ASC");
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                    
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";  
                    //CC2
                    $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalIncomeTotal=0;
                $TotalIncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalFixedAsset=0;
                $TotalFixedAssetpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv+$TotalFixedAssetpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalLiabilities=0;
                $TotalLiabilitiespv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotalpv+$TotalFixedAssetpv)-$TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $RetainedEarningspv=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarnings+=$data->advance_beginning_balance;
                    $RetainedEarningspv+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                    //             if ($JE->je_credit!=""){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarnings,2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotalpv+=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotalpv-=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $CustomerTotal2pv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2pv-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2pv+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningspv,2);
                $RetainedEarnings=$CustomerTotal-$CustomerTotal2;
                $RetainedEarningspv=$CustomerTotalpv-$CustomerTotal2pv;
                $tablecontent.='</td>';

                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }   
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $CustomerTotalpv+=$JE->je_credit;
                                }else{
                                    $CustomerTotalpv-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2pv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2pv-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2pv+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotalpv-$CustomerTotal2pv,2);
                $tablecontent.='</td>';

                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalEquityOthers=0;
                $TotalEquityOtherspv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv-=$Coa->coa_balance;
                            $IncomeTotalpv-=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv+=$Coa->coa_balance;
                            $IncomeTotalpv+=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $TotalEquityOtherspv+=$IncomeTotalpv;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarningspv+($CustomerTotalpv-$CustomerTotal2pv)+$TotalEquityOtherspv,2).'</td>';
                $tablecontent.='</tr>';
                
                    //CC2END
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //CC3
            $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalIncomeTotal=0;
                $TotalIncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv-=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_totalpv+=$Coa->coa_balance;
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $TotalIncomeTotalpv+=$IncomeTotalpv;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalFixedAsset=0;
                $TotalFixedAssetpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotalpv-=$coa_name_totalpv;
                        }else{
                            $IncomeTotalpv+=$coa_name_totalpv;
                        }
                        
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="4" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv-=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $TotalFixedAssetpv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotalpv+$TotalFixedAssetpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalLiabilities=0;
                $TotalLiabilitiespv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_totalpv=0;
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $coa_name_totalpv+=$JE->je_credit;
                                }else{
                                    $coa_name_totalpv-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_totalpv+=$Coa->coa_balance;
                        $IncomeTotalpv+=$coa_name_totalpv;
                        $tablecontent.=number_format($coa_name_totalpv,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $TotalLiabilitiespv+=$IncomeTotalpv;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotalpv,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotalpv+$TotalFixedAssetpv)-$TotalLiabilitiespv,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $RetainedEarningsSubs=0;
                $RetainedEarningsSubspv=0;
                $RetainedEarningspv=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarningsSubs+=$data->advance_beginning_balance;
                    $RetainedEarningsSubspv+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                    //             if ($JE->je_credit!=""){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpast as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubs-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubs+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2),2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotalpv+=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotalpv-=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $CustomerTotal2pv=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpastpv as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                //                 if ($JE->je_credit!=""){
                //                     $CustomerTotal2pv-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2pv+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpastpv as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubspv-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubspv+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubspv+($CustomerTotalpv-$CustomerTotal2pv),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2);
                $RetainedEarningspv=$RetainedEarningsSubs+($CustomerTotalpv-$CustomerTotal2pv);
                $tablecontent.='</td>';

                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotalpv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotalpv+=$JE->je_credit;
                                }else{
                                    $CustomerTotalpv-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2pv=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntrypv as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!=""){
                                    $CustomerTotal2pv-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2pv+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotalpv-$CustomerTotal2pv,2);
                $tablecontent.='</td>';

                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $TotalEquityOthers=0;
                $TotalEquityOtherspv=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv-=$Coa->coa_balance;
                            $IncomeTotalpv-=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv-=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_totalpv+=$Coa->coa_balance;
                            $IncomeTotalpv+=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $TotalEquityOtherspv+=$IncomeTotalpv;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarningspv+($CustomerTotalpv-$CustomerTotal2pv)+$TotalEquityOtherspv,2).'</td>';
                $tablecontent.='</tr>';
            
            //CC3END
        }

        

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th colspan="3" width="60%"></th>'.
                '<th style="text-align:right;">'.$DateRange.'</th><th style="text-align:right;">'.$DateRangepy.'</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function AccountsPayableDetail(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $st_invoice = DB::table('st_invoice')->get();
        return view('app.AccountsPayableDetail', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function BalanceSheetDetailByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsettingjournalpast="WHERE created_at < '".$FROM."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            $sortsettingjournalpast="WHERE created_at = '' AND ";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal="  je_cost_center='".$CostCenterFilter."'";
        }
        $sortjournalpast=" je_cost_center='".$CostCenterFilter."'";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortjournalpast="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournalpast="WHERE created_at < '".$FROM."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
                $sortsettingjournalpast="WHERE created_at = ''";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntryformpast= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpast.$sortjournalpast." 
                            ORDER BY created_at ASC");
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
        $coa_sub_account_type=ChartofAccount::groupBy('coa_sub_account')->orderBy('coa_detail_type','ASC')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        $cost_center_list=CostCenter::all();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }        
        $et_account_details= DB::table('et_account_details')->get();
        $tablecontent="";
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                //LL1
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalIncomeTotal=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $TotalFixedAsset=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalLiabilities=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $RetainedEarningsSubs=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarnings+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                    //             if ($JE->je_credit!="" ){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                //                 if ($JE->je_credit!="" ){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpast as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubs-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubs+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalEquityOthers=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }
                         
                    }
                    
                }
                $TotalEquityOthers+=$IncomeTotal;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='</tr>';
                //LL1END
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    $JournalEntryformpast=DB::connection('mysql')->select("SELECT * FROM journal_entries 
                    ".$sortsettingjournalpast.$sortjournalpast."
                    ORDER BY created_at ASC");
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        
                        $tablecontent.=$ccl->cc_name;
                        
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    //LL2
                    $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalIncomeTotal=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFccl->cc_noilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $TotalFixedAsset=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalLiabilities=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarnings+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                    //             if ($JE->je_credit!="" ){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                //                 if ($JE->je_credit!="" ){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $RetainedEarnings=$CustomerTotal-$CustomerTotal2;
                $tablecontent.='</td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalEquityOthers=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='</tr>';
                    
                    //LL2END
                }
                
                
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //LL3
            $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Assets</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Assets</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalIncomeTotal=0;
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Bank"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Bank"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Cash on Hand"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Cash on Hand"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Receivable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Receivable Accounts"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Inventories"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Inventories"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($coa_sub_account_type as $coa){
                    if ($coa->coa_sub_account=="Prepayments"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">'.$coa->coa_sub_account.'</td>';
                        $tablecontent.='</tr>';
                        foreach ($COA as $Coa){
                            if ($Coa->coa_sub_account=="Prepayments"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $coa_name_total-=$JE->je_credit;
                                        }else{
                                            $coa_name_total+=$JE->je_debit;
                                        }
                                    }
                                }
                                $coa_name_total+=$Coa->coa_balance;
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!="" ){
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format(-$JE->je_credit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>';  
                                        }else{
                                            $tablecontent.='<tr>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                            $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                            
                                            $tablecontent.=number_format($JE->je_debit,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.='</tr>'; 
                                        }
                                    }
                                }
                            }
                        }
                        $TotalIncomeTotal+=$IncomeTotal;
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total '.$coa->coa_sub_account.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='</tr>';
                        
                    }
                }
                $tablecontent.='<tr>';
               
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $TotalFixedAsset=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Fixed Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Fixed Assets" || $Coa->coa_account_type=="Fixed Asset" || $Coa->coa_account_type=="Land, Building and Improvements" || $Coa->coa_account_type=="Equipment and Improvements" || $Coa->coa_account_type=="Asset Contra Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        if (strpos($Coa->coa_name, 'Accumulated Depreciation') !== false) {
                            $IncomeTotal-=$coa_name_total;
                        }else{
                            $IncomeTotal+=$coa_name_total;
                        }
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Fixed Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';

                $IncomeTotal=0;
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:1px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style=""></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Non-Current Assets</td>';
                $tablecontent.='</tr>';
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Non Current Assets" || $Coa->coa_account_type=="Non Current Asset" || $Coa->coa_account_type=="Improvements"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total-=$JE->je_credit;
                                }else{
                                    $coa_name_total+=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalFixedAsset+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Non-Current Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalIncomeTotal+$TotalFixedAsset,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:3px dotted #ccc"></td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Liabilities</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:11px;">Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalLiabilities=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Current Liabilities" || $Coa->coa_account_type=="Current Liability" || $Coa->coa_account_type=="Payable Accounts"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="border-bottom:2px dotted #ccc"></td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:11px;">Other Current Liabilities</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Other Current Liabilities" || $Coa->coa_account_type=="Other Current Liability" || $Coa->coa_account_type=="Other Payables" || $Coa->coa_account_type=="Non-Current Liabilities"){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                        $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                        $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                        $coa_name_total=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        $coa_name_total+=$Coa->coa_balance;
                        $IncomeTotal+=$coa_name_total;
                        $tablecontent.=number_format($coa_name_total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format($JE->je_credit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>';  
                                }else{
                                    $tablecontent.='<tr>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.$JE->je_transaction_type.'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;">'.($JE->je_transaction_type!="Journal Entry"? $JE->other_no : $JE->je_no).'</td>';
                                    $tablecontent.='<td class="dottedborderinner" style="vertical-align:middle;font-size:11px;text-align:right;">';
                                    
                                    $tablecontent.=number_format(-$JE->je_debit,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                    }
                }
                $TotalLiabilities+=$IncomeTotal;
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-size:11px;"></td>';
                $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Other Current Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($IncomeTotal,2).'</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Liabilities</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Assets</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format(($TotalIncomeTotal+$TotalFixedAsset)-$TotalLiabilities,2).'</td>';
                $tablecontent.='</tr>';
                
                $tablecontent.='<tr>';
                $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;">Equity</td>';
                $tablecontent.='</tr>';
                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Retained Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                $RetainedEarnings=0;
                $RetainedEarningsSubs=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarnings+=$data->advance_beginning_balance;
                }
                foreach ($COA as $coa){
                    //experimental retained earning
                    // if ($coa->coa_sub_account=="Bank"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Cash on Hand"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Receivable Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ($coa->coa_sub_account=="Inventories"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_sub_account=="Prepayments"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    
                    // }
                    // if ( $coa->coa_account_type=="Fixed Assets" || $coa->coa_account_type=="Fixed Asset" || $coa->coa_account_type=="Land, Building and Improvements" || $coa->coa_account_type=="Equipment and Improvements" || $coa->coa_account_type=="Asset Contra Accounts"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    // if ( $coa->coa_account_type=="Non Current Assets" || $coa->coa_account_type=="Non Current Asset" || $coa->coa_account_type=="Improvements"){
                    //     $CustomerTotal+=$coa->coa_balance;
                    // }
                    
                    // if ($coa->coa_account_type=="Current Liabilities" || $coa->coa_account_type=="Current Liability" || $coa->coa_account_type=="Payable Accounts"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Other Current Liabilities" || $coa->coa_account_type=="Other Current Liability" || $coa->coa_account_type=="Other Payables"){
                    //     $CustomerTotal-=$coa->coa_balance;
                    // }
                    // if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                    //     foreach ($JournalEntryformpast as $JE){
                    //         if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                    //             if ($JE->je_credit!="" ){
                    //                 $CustomerTotal+=$JE->je_credit;
                    //             }else{
                    //                 $CustomerTotal-=$JE->je_debit;
                    //             }
                    //         }
                    //     }
                    // }
                }
                $CustomerTotal2=0;
                // foreach ($COA as $coa){
                //     if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                //         foreach ($JournalEntryformpast as $JE){
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                //                 if ($JE->je_credit!="" ){
                //                     $CustomerTotal2-=$JE->je_credit;
                //                 }else{
                //                     $CustomerTotal2+=$JE->je_debit;
                //                 }
                //             }
                //         }
                //     }
                //     if ($coa->coa_account_type=="Equity" && ($coa->coa_detail_type=="Retained Earnings" || $coa->coa_detail_type=="Retained Earning")){
                        
                //         foreach ($JournalEntryformpast as $JE){
                //             //$tablecontent.=$JE->je_no."\n";
                //             if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                
                //                 if ($JE->je_credit!=""){
                //                     $RetainedEarningsSubs-=$JE->je_credit;
                //                     //$tablecontent.=$RetainedEarningsSubs." c";
                //                 }else{
                //                     $RetainedEarningsSubs+=$JE->je_debit;
                //                     //$tablecontent.=$RetainedEarningsSubs." d";
                //                 }
                                
                //             }
                //         }
                //     }
                // }
                $tablecontent.=number_format($RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2),2);
                $RetainedEarnings=$RetainedEarningsSubs+($CustomerTotal-$CustomerTotal2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';

                $tablecontent.='<tr>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">Current Year Earnings</td>';
                $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                $CustomerTotal=0;
                foreach ($COA as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" || $coa->coa_account_type=='Cost of Sales'){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal+=$JE->je_credit;
                                }else{
                                    $CustomerTotal-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $CustomerTotal2=0;
                foreach ($COA as $coa){
                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" ){
                                    $CustomerTotal2-=$JE->je_credit;
                                }else{
                                    $CustomerTotal2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                $IncomeTotal=0;
                $TotalEquityOthers=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Equity" && ($Coa->coa_detail_type!="Retained Earnings" && $Coa->coa_detail_type!="Retained Earning")){
                        if($Coa->coa_name=="Prior Period Adjustments"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total-=$Coa->coa_balance;
                            $IncomeTotal-=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }else{
                            $tablecontent.='<tr>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td width="10px" style="vertical-align:middle;font-weight:bold;font-size:11px;"></td>';
                            $tablecontent.='<td colspan="4" class="dottedborder" style="vertical-align:middle;font-size:11px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td class="dottedborder" style="vertical-align:middle;font-size:11px;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!="" ){
                                        $coa_name_total-=$JE->je_credit;
                                    }else{
                                        $coa_name_total+=$JE->je_debit;
                                    }
                                }
                            }
                            $coa_name_total+=$Coa->coa_balance;
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>'; 
                        }
                         
                    }
                }
                $TotalEquityOthers+=$IncomeTotal;
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;">';
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;font-size:11px;text-align:right;font-weight:bold;">'.number_format($RetainedEarnings+($CustomerTotal-$CustomerTotal2)+$TotalEquityOthers,2).'</td>';
                $tablecontent.='</tr>';
            
            //LL3END
           
        }

        

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th colspan="3"></th><th >Date</th><th>Transaction Type</th><th>No</th>'.
                '<th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ProfitAndLossByCustomer(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $combinedarray=array();
        foreach($STCustomer as $ST){
            foreach($ET_Customer as $SC){
                
                    $combinedarray[]=$SC->et_customer;
                
            }
        }
        foreach($ET_Customer as $SC){
            foreach($STCustomer as $ST){
            
                if($SC->et_customer!=$ST->st_customer_id){
                    $combinedarray[]=$ST->st_customer_id;
                    
                }
            }
        
        }
        $nodup=array_unique($combinedarray);
        $output=array_unique($combinedarray);
        $STARRAY=array();
        $emptyArray = array();

        foreach($nodup as $id){
            
            foreach ($SalesTransaction as $ST) {
                
                if($id==$ST->st_customer_id){
                    $STARRAY['type']  = "Sales" ;
                    $STARRAY['st_no']  = $ST->st_no ;
                    $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                    $STARRAY['st_type']  = $ST->st_type ;
                    $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                    $STARRAY['et_no']  = "None" ;
                    $STARRAY['et_customer']  = "None";
                    $STARRAY['et_type']  = "None";
                    $STARRAY['remark']  = $ST->remark;
                    array_push($emptyArray, $STARRAY);
                    
                }
            }
            foreach ($expense_transactionssss as $ET) {
                if($id==$ET->et_customer){
                    $STARRAY['st_no']  = $ET->et_no ;
                    $STARRAY['st_customer_id']  = $ET->et_customer;
                    $STARRAY['st_type']  =$ET->et_type;
                    $STARRAY['st_amount_paid']  = "0";
                    $STARRAY['type']  = "Expense" ;
                    $STARRAY['et_no']  = $ET->et_no ;
                    $STARRAY['et_customer']  = $ET->et_customer ;
                    $STARRAY['et_type']  = $ET->et_type ;
                    $STARRAY['remark']  = $ET->remark;
                    array_push($emptyArray, $STARRAY);
                }
            }
            
            // foreach($st_credit_notes as $SC){
                
            //     if($SC->st_cn_product!=$as->st_i_product){
            //         $STARRAY['st_i_rate']  = $as->st_i_rate ;
            //         $STARRAY['st_i_product']  = $as->st_i_product ;
            //         array_push($emptyArray, $STARRAY);
            //     }
            // }
            
        }
        // $emptyArray=array_unique($STARRAY['st_customer_id']);
        //return $emptyArray;
        // foreach ($emptyArray as $e) {
        //     echo $e['st_no']." ".$e['type']."<br>";
        // }
        //return "";
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ProfitAndLossByCustomer', compact('expense_transactionssss','output','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','emptyArray','nodup','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function ProfitandlossByCustomerByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();
        $ETran = DB::table('expense_transactions')->get();      
        $et_account_details= DB::table('et_account_details')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $combinedarray=array();
        foreach($STCustomer as $ST){
            foreach($ET_Customer as $SC){
                
                    $combinedarray[]=$SC->et_customer;
                    
                
            }
        }
        foreach($ET_Customer as $SC){
            foreach($STCustomer as $ST){
            
                if($SC->et_customer!=$ST->st_customer_id){
                    $combinedarray[]=$ST->st_customer_id;
                    
                }
            }
        
        }
        $nodup=array_unique($combinedarray);
        $output=array_unique($combinedarray);
        $STARRAY=array();
        $emptyArray = array();

        foreach($nodup as $id){
            
            foreach ($SalesTransaction as $ST) {
                
                if($id==$ST->st_customer_id){
                    $STARRAY['type']  = "Sales" ;
                    $STARRAY['st_no']  = $ST->st_no ;
                    $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                    $STARRAY['st_type']  = $ST->st_type ;
                    $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                    $STARRAY['et_no']  = "None" ;
                    $STARRAY['et_customer']  = "None";
                    $STARRAY['et_type']  = "None";
                    $STARRAY['remark']  = $ST->remark;
                    array_push($emptyArray, $STARRAY);
                    
                }
            }
            foreach ($expense_transactions as $ET) {
                if($id==$ET->et_customer){
                    $STARRAY['st_no']  = "None" ;
                    $STARRAY['st_customer_id']  = "None";
                    $STARRAY['st_type']  ="None";
                    $STARRAY['st_amount_paid']  = "0";
                    $STARRAY['type']  = "Expense" ;
                    $STARRAY['et_no']  = $ET->et_no ;
                    $STARRAY['et_customer']  = $ET->et_customer ;
                    $STARRAY['et_type']  = $ET->et_type ;
                    $STARRAY['remark']  = $ET->remark;
                    array_push($emptyArray, $STARRAY);
                }
            }
            
            // foreach($st_credit_notes as $SC){
                
            //     if($SC->st_cn_product!=$as->st_i_product){
            //         $STARRAY['st_i_rate']  = $as->st_i_rate ;
            //         $STARRAY['st_i_product']  = $as->st_i_product ;
            //         array_push($emptyArray, $STARRAY);
            //     }
            // }
            
        }
        

        $tablecontent="";

        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
                if($CostCenterFilter=="All"){
                    //PALBC1
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    $IncomeTotal=0;
                    $GrossProfit=0;
                    foreach ($coa_account_type as $coa){
                        if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            
                            $tablecontent.="</tr>";
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!="" ){
                                                $coa_name_total+=$JE->je_credit;
                                            }else{
                                                $coa_name_total-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
            
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$coa->id && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            
                        }
                    }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2);    
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            $GrossProfit+=$IncomeTotal;
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    $IncomeTotal=0;
                    foreach ($coa_account_type as $coa){
                        if ($coa->coa_account_type=="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            
                            $tablecontent.="</tr>";
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Cost of Sales"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!="" ){
                                                $coa_name_total+=$JE->je_credit;
                                            }else{
                                                $coa_name_total-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
            
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            
                        }
                    }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2); 
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            $GrossProfit+=$IncomeTotal;
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Revenues"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2); 
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                            $tablecontent.="</tr>";
                            //expense
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                            $tablecontent.="</tr>";
                            
                            $TotalOperatingExpense=0;
                            foreach ($coa_account_type as $coa){
                                $IncomeTotal=0;
                                if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                    
                                    $tablecontent.="</tr>"; 
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type==$coa->coa_account_type){
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                            foreach ($output as $ST){
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $CustomerTotal=0;
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($CustomerTotal,2);
                                                $tablecontent.='</td>';
                                            }
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_name_total=0;
                                            foreach ($JournalEntry as $JE){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!="" ){
                                                        $coa_name_total-=$JE->je_credit;
                                                    }else{
                                                        $coa_name_total+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            $IncomeTotal+=$coa_name_total;
                                            $tablecontent.=number_format($coa_name_total,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.="</tr>"; 
                                        }
                                    }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($COA as $Coa){
                                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                } 
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2); 
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>"; 
                                }
                                $TotalOperatingExpense+=$IncomeTotal;
                            }
                            
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                            
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($COA as $Coa){
                                            if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!=""){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!=""){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                } 
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                            $tablecontent.="</tr>"; 
                            $tablecontent.="<tr style='display:none;'>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $CustomerTotal2=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal2-=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal2+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal2-=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal2+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);       
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                            $tablecontent.="</tr>";
                    //PALBC1END
                }
                else if($CostCenterFilter=="By Cost Center"){
                    foreach($all_cost_center_list as $ccl){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        
                            $tablecontent.=$ccl->cc_name;
                        
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                                $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                                if($sortsettingjournal==""){
                                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                                }else{
                                    $sortjournal="AND  je_cost_center='".$ccl->cc_no."'";
                                }
                                $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                ".$sortsettingjournal.$sortjournal." 
                                ORDER BY created_at ASC");
                                $tablecontent.="<tr>";
                        //C2
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        $IncomeTotal=0;
                        $GrossProfit=0;
                        foreach ($coa_account_type as $coa){
                            if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>";
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        foreach ($output as $ST){
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $CustomerTotal=0;
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2);
                                            $tablecontent.='</td>';
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!="" ){
                                                    $coa_name_total+=$JE->je_credit;
                                                }else{
                                                    $coa_name_total-=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$coa->id && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>";
                                
                            }
                        }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            } 
                                        }
                                    }
                                    $tablecontent.=number_format($CustomerTotal,2);    
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>";
                                $GrossProfit+=$IncomeTotal;
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        $IncomeTotal=0;
                        foreach ($coa_account_type as $coa){
                            if ($coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>";
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        foreach ($output as $ST){
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $CustomerTotal=0;
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2);
                                            $tablecontent.='</td>';
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!="" ){
                                                    $coa_name_total+=$JE->je_credit;
                                                }else{
                                                    $coa_name_total-=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>";
                                
                            }
                        }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Cost of Sales"){
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            } 
                                        }
                                    }
                                    $tablecontent.=number_format($CustomerTotal,2); 
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>";
                                $GrossProfit+=$IncomeTotal;
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                $tablecontent.="</tr>";
                                $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Revenues"){
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!="" ){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            } 
                                        }
                                    }
                                    $tablecontent.=number_format($CustomerTotal,2); 
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                                $tablecontent.="</tr>";
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                                $tablecontent.="</tr>";
                                //expense
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>";
                                
                                $TotalOperatingExpense=0;
                                foreach ($coa_account_type as $coa){
                                    $IncomeTotal=0;
                                    if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                        
                                        $tablecontent.="</tr>"; 
                                        foreach ($COA as $Coa){
                                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                                $tablecontent.="<tr>";
                                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                                foreach ($output as $ST){
                                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                    $CustomerTotal=0;
                                                    foreach ($SS as $ss){
                                                        if ($ss->st_customer_id==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                    if ($JE->je_credit!="" ){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    foreach ($ETran as $ss){
                                                        if ($ss->et_customer==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                    if ($JE->je_credit!="" ){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    $tablecontent.=number_format($CustomerTotal,2);
                                                    $tablecontent.='</td>';
                                                }
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $coa_name_total=0;
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!="" ){
                                                            $coa_name_total-=$JE->je_credit;
                                                        }else{
                                                            $coa_name_total+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                                $IncomeTotal+=$coa_name_total;
                                                $tablecontent.=number_format($coa_name_total,2);
                                                $tablecontent.='</td>';
                                                $tablecontent.="</tr>"; 
                                            }
                                        }
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                        foreach ($output as $ST){
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $CustomerTotal=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                                    foreach ($SS as $ss){
                                                        if ($ss->st_customer_id==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                    if ($JE->je_credit!="" ){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    foreach ($ETran as $ss){
                                                        if ($ss->et_customer==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                    if ($JE->je_credit!="" ){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    } 
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2); 
                                            $tablecontent.='</td>';
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                    $TotalOperatingExpense+=$IncomeTotal;
                                }
                                
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                $tablecontent.="</tr>";
                                
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                                    foreach ($SS as $ss){
                                                        if ($ss->st_customer_id==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                    foreach ($ETran as $ss){
                                                        if ($ss->et_customer==$ST){
                                                            foreach ($JournalEntry as $JE){
                                                                if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $CustomerTotal-=$JE->je_credit;
                                                                    }else{
                                                                        $CustomerTotal+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    } 
                                                }
                                            }
                                            $tablecontent.=number_format($CustomerTotal,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                                $tablecontent.="</tr>"; 
                                $tablecontent.="<tr style='display:none;'>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                                $tablecontent.="</tr>";
                                $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $CustomerTotal=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!=""){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!=""){
                                                                $CustomerTotal+=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            } 
                                        }
                                    }
                                    $CustomerTotal2=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                            foreach ($SS as $ss){
                                                if ($ss->st_customer_id==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                            if ($JE->je_credit!=""){
                                                                $CustomerTotal2-=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal2+=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            foreach ($ETran as $ss){
                                                if ($ss->et_customer==$ST){
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                            if ($JE->je_credit!=""){
                                                                $CustomerTotal2-=$JE->je_credit;
                                                            }else{
                                                                $CustomerTotal2+=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                            } 
                                        }
                                    }
                                    $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);       
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                                $tablecontent.="</tr>"; 
                            //C2End
                            
                        }
                }
            }else{
                //start by customer by individual cost center
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                foreach($all_cost_center_list as $ccl){
                    if($ccl->cc_no==$CostCenterFilter){
                        $tablecontent.=$ccl->cc_name;
                    }
                }
                $tablecontent.='</td>';
                $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    $IncomeTotal=0;
                    $GrossProfit=0;
                    foreach ($coa_account_type as $coa){
                        if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            
                            $tablecontent.="</tr>";
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!="" ){
                                                $coa_name_total+=$JE->je_credit;
                                            }else{
                                                $coa_name_total-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
            
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$coa->id && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            
                        }
                    }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2);    
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            $GrossProfit+=$IncomeTotal;
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    $IncomeTotal=0;
                    foreach ($coa_account_type as $coa){
                        if ($coa->coa_account_type=="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            
                            $tablecontent.="</tr>";
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Cost of Sales"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!="" ){
                                                $coa_name_total+=$JE->je_credit;
                                            }else{
                                                $coa_name_total-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
            
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            
                        }
                    }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2); 
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>";
                            $GrossProfit+=$IncomeTotal;
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Revenues"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!="" ){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal,2); 
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                            $tablecontent.="</tr>";
                            //expense
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                            $tablecontent.="</tr>";
                            
                            $TotalOperatingExpense=0;
                            foreach ($coa_account_type as $coa){
                                $IncomeTotal=0;
                                if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                    
                                    $tablecontent.="</tr>"; 
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type==$coa->coa_account_type){
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                            foreach ($output as $ST){
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $CustomerTotal=0;
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($CustomerTotal,2);
                                                $tablecontent.='</td>';
                                            }
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_name_total=0;
                                            foreach ($JournalEntry as $JE){
                                                if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!="" ){
                                                        $coa_name_total-=$JE->je_credit;
                                                    }else{
                                                        $coa_name_total+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            $IncomeTotal+=$coa_name_total;
                                            $tablecontent.=number_format($coa_name_total,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.="</tr>"; 
                                        }
                                    }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $CustomerTotal=0;
                                        foreach ($COA as $Coa){
                                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!="" ){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                } 
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2); 
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>"; 
                                }
                                $TotalOperatingExpense+=$IncomeTotal;
                            }
                            
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                            $tablecontent.="</tr>";
                            
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                        foreach ($COA as $Coa){
                                            if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                                foreach ($SS as $ss){
                                                    if ($ss->st_customer_id==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                                if ($JE->je_credit!=""){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                foreach ($ETran as $ss){
                                                    if ($ss->et_customer==$ST){
                                                        foreach ($JournalEntry as $JE){
                                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                                if ($JE->je_credit!=""){
                                                                    $CustomerTotal-=$JE->je_credit;
                                                                }else{
                                                                    $CustomerTotal+=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                } 
                                            }
                                        }
                                        $tablecontent.=number_format($CustomerTotal,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                            $tablecontent.="</tr>"; 
                            $tablecontent.="<tr style='display:none;'>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $CustomerTotal=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal+=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $CustomerTotal2=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                        foreach ($SS as $ss){
                                            if ($ss->st_customer_id==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->st_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal2-=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal2+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        foreach ($ETran as $ss){
                                            if ($ss->et_customer==$ST){
                                                foreach ($JournalEntry as $JE){
                                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'&& $JE->other_no==$ss->et_no){
                                                        if ($JE->je_credit!=""){
                                                            $CustomerTotal2-=$JE->je_credit;
                                                        }else{
                                                            $CustomerTotal2+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        } 
                                    }
                                }
                                $tablecontent.=number_format($CustomerTotal-$CustomerTotal2,2);       
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                            $tablecontent.="</tr>";
                //end by customer by individual cost center
            }


            




            $addth="";
            
                foreach ($customers as $cus){
                    foreach ($nodup as $ST){
                    if ($ST==$cus->customer_id){
                        if ($cus->display_name!=""){
                            $addth.="<th>".$cus->display_name."</th>";
                        }else{
                            $addth.="<th>".$cus->f_name." ".$cus->l_name."</th>";
                        }
                    }
                }     
            }
            $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                    .'<thead><tr>'
                    .'<th></th>'.
                    $addth.
                    '<th style="text-align:right;">Total</th>'
                    .'</tr></thead>'
                    .'<tbody>'.
                    $tablecontent
                    .'</tbody>'
                    .'</table>';
            return $table;
        }
        public function StatementofChangesinEquity(Request $request){
            $sortsetting="";
            if($request->date_from){
                $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
            }else{
                
            }
            $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.statementofchangesinequity', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        
        }
        public function StatementofchangeinequityByDate(Request $request){
            $sortsetting="";
            $FROM=$request->FROM;
            $TO=$request->TO;
            $filtertemplate=$request->filtertemplate;
            $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                
            }
            
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->orderBy('display_name', 'ASC')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->whereBetween('et_date', [$FROM, $TO])
                    ->get();
            $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
            if($filtertemplate=="All"){
                
                $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->get();
                $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
                $STCustomer= DB::table('sales_transaction')
                    ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                    ->select('st_customer_id')
                    ->groupBy('st_customer_id')
                    ->orderBy('display_name', 'ASC')
                    ->get();    
            }        
            $et_account_details= DB::table('et_account_details')->get();
            $tablecontent="";
            $Dividenddisbursed=0;
            $Equityinearningsofsubsidiaries=0;
            $Othercomprehensiveincome=0;
            $RetainedEarnings=0;
            $Sharecapital=0;
            $totalequity=0;
            foreach ($expense_transactions as $et){
                foreach ($et_account_details as $ead){
                    if ($ead->et_ad_no==$et->et_no){
                        if($ead->et_ad_product=="Dividend disbursed"){
                            $Dividenddisbursed+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Equity in earnings of subsidiaries"){
                            $Equityinearningsofsubsidiaries+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Other comprehensive income"){
                            $Othercomprehensiveincome+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Retained Earnings"){
                            $RetainedEarnings+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Share capital"){
                            $Sharecapital+=$ead->et_ad_total;
                        }
                    }
                }
            }
            $totalequity=$Dividenddisbursed+$Equityinearningsofsubsidiaries+$Othercomprehensiveincome+$RetainedEarnings+$Sharecapital;

            if($totalequity!=0){
                if($Dividenddisbursed!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">Dividend disbursed</td>';
                    $tablecontent.='<td style="vertical-align:middle;">-'.number_format($Dividenddisbursed,2).'</td>';
                    $tablecontent.="</tr>";
                }
                if($Equityinearningsofsubsidiaries!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">Equity in earnings of subsidiaries</td>';
                    $tablecontent.='<td style="vertical-align:middle;">-'.number_format($Equityinearningsofsubsidiaries,2).'</td>';
                    $tablecontent.="</tr>";
                }
                if($Othercomprehensiveincome!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">Other comprehensive income</td>';
                    $tablecontent.='<td style="vertical-align:middle;">-'.number_format($Othercomprehensiveincome,2).'</td>';
                    $tablecontent.="</tr>";
                }
                if($RetainedEarnings!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                    $tablecontent.='<td style="vertical-align:middle;">-'.number_format($RetainedEarnings,2).'</td>';
                    $tablecontent.="</tr>";
                }
                if($Sharecapital!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">Share capital</td>';
                    $tablecontent.='<td style="vertical-align:middle;">-'.number_format($Sharecapital,2).'</td>';
                    $tablecontent.="</tr>";
                }
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;">Total Equity</td>';
                $tablecontent.='<td style="vertical-align:middle;">-'.number_format($totalequity,2).'</td>';
                $tablecontent.="</tr>";
            }
            
            

            $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                    .'<thead><tr>'
                    .'<th width="60%"></th>'.
                    '<th style="text-align:right;">Total</th>'
                    .'</tr></thead>'
                    .'<tbody>'.
                    $tablecontent
                    .'</tbody>'
                    .'</table>';
            return $table;
        }
        public function BalanceSheetDetail(Request $request){
            $sortsetting="";
            if($request->date_from){
                $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
            }else{
                
            }
            $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions = DB::table('expense_transactions')
                ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.balancesheetdetail', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        
        }
        public function BalanceSheetComparison(Request $request){
            $sortsetting="";
            if($request->date_from){
                $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
            }else{
                
            }
            $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions = DB::table('expense_transactions')
                ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.balancesheetcomparison', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        }
        public function BalanceSheet(Request $request){
            $sortsetting="";
            if($request->date_from){
                $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
            }else{
                
            }
            $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions = DB::table('expense_transactions')
                ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.balancesheet', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        }
        public function StatementofCashFlows(Request $request){
            $sortsetting="";
            if($request->date_from){
                $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
            }else{
                
            }
            $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.statementofcashflow', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        }
        public function StatementofCashFlowByDate(Request $request){
            $sortsetting="";
            $FROM=$request->FROM;
            $TO=$request->TO;
            $filtertemplate=$request->filtertemplate;
            $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                
            }
            
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->orderBy('display_name', 'ASC')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->whereBetween('et_date', [$FROM, $TO])
                    ->get();
            $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
            if($filtertemplate=="All"){
                
                $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->get();
                $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
                $STCustomer= DB::table('sales_transaction')
                    ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                    ->select('st_customer_id')
                    ->groupBy('st_customer_id')
                    ->orderBy('display_name', 'ASC')
                    ->get();    
            }        
            $et_account_details= DB::table('et_account_details')->get();
            $tablecontent="";

            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;">Cash flows from operating activities</td>';
            $tablecontent.='<td style="vertical-align:middle;"></td>';
            $tablecontent.="</tr>";
            $incometotal=0;
            $invoicetotal=0;
            $creditnotetotal=0;
            foreach($SalesTransaction as $ST){
                if($ST->st_type=="Invoice"){
                    foreach($st_invoice as $st){
                        if($ST->st_no==$st->st_i_no){
                            $incometotal+=$st->st_i_total;
                        }
                    }
                }
                else if($ST->st_type=="Credit Note"){
                    $incometotal+=$ST->st_amount_paid;
                }
            }
            $expensestotal=0;
            foreach($expense_transactions as $et){
                foreach($et_account_details as $acc){
                    if($acc->et_ad_no==$et->et_no){
                        $expensestotal+=$acc->et_ad_total;
                    }
                }
            }
            $AccountRecievable=0;
            foreach($SalesTransaction as $SS){
                if($SS->st_type=="Invoice"){
                    $AccountRecievable=$AccountRecievable+$SS->st_balance;
                }
                if($SS->st_type=="Credit Note"){
                    $AccountRecievable=$AccountRecievable+$SS->st_amount_paid;
                }
                if($SS->st_type=="Payment"){
                    $AccountRecievable=$AccountRecievable-$SS->st_amount_paid;
                }
            }
            $Inventory=0;
            $Allowanceforbaddebt=0;
            $Availableforsaleassets=0;
            $InventoryAsset=0;
            $Prepaidexpenses=0;
            $UncategorisedAsset=0;
            $totalnoncash=0;

            $PPE=0;
            $AHOS=0;
            $totalinvest=0;
            foreach ($expense_transactions as $et){
                foreach ($et_account_details as $ead){
                    if ($ead->et_ad_no==$et->et_no){
                        if($ead->et_ad_product=="Inventory"){
                            $Inventory+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Allowance for bad debt"){
                            $Allowanceforbaddebt+=$ead->et_ad_total;
                        }
                        elseif($ead->et_ad_product=="Available for sale assets (short-term)"){
                            $Availableforsaleassets+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Inventory Asset"){
                            $InventoryAsset+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Prepaid expenses"){
                            $Prepaidexpenses+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Uncategorised Asset"){
                            $UncategorisedAsset+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Property, plant and equipment"){
                            $PPE+=$ead->et_ad_total;
                        }
                        else if($ead->et_ad_product=="Assets held for sale"){
                            $AHOS+=$ead->et_ad_total;
                        }
                    }
                }
            }
            $totalnoncash=$AccountRecievable+$Inventory+$Allowanceforbaddebt+$Availableforsaleassets+$InventoryAsset+$Prepaidexpenses+$UncategorisedAsset;
            $totalinvest=$PPE+$AHOS;

            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;padding-left:20px;font-weight:bold">Profit for the Period</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">Php'.number_format($incometotal-$expensestotal,2).'</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;padding-left:20px;font-weight:bold">Adjustments for non-cash income and expenses:</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">Php -'.number_format($totalnoncash,2).'</td>';
            $tablecontent.="</tr>";
            if($AccountRecievable!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Account Receivable (A/R)</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($AccountRecievable,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($Inventory!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Inventory</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($Inventory,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($Allowanceforbaddebt!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Allowance for bad debt</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($Allowanceforbaddebt,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($Availableforsaleassets!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Available for sale assets (short-term)</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($Availableforsaleassets,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($InventoryAsset!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Inventory Asset</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($InventoryAsset,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($Prepaidexpenses!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Prepaid expenses</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($Prepaidexpenses,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            if($UncategorisedAsset!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Uncategorised Asset</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($UncategorisedAsset,2).'</td>';
                $tablecontent.="</tr>"; 
            }
            $tablecontent.="<tr style='border-top:2px solid #ccc;'>";
            $tablecontent.='<td style="vertical-align:middle;padding-left:20px;font-weight:bold;">Net cash from operating activities</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">Php '.number_format(($incometotal-$expensestotal)-$totalnoncash,2).'</td>';
            $tablecontent.="</tr>";
            if($totalinvest!=0){
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;">Cash flows from investing activities</td>';
                $tablecontent.='<td style="vertical-align:middle;"></td>';
                $tablecontent.="</tr>";
                if($PPE!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Property, plant and equipment</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($PPE,2).'</td>';
                    $tablecontent.="</tr>"; 
                }
                if($AHOS!=0){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;padding-left:30px;">Assets held for sale</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($AHOS,2).'</td>';
                    $tablecontent.="</tr>";  
                }
                $tablecontent.="<tr style='border-top:2px solid #ccc;'>";
                $tablecontent.='<td style="vertical-align:middle;padding-left:20px;font-weight:bold;">Net cash from investing activities</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">Php '.$totalinvest!=0? " Php -".number_format($totalinvest,2) : 'Php 0.00'.'</td>';
                $tablecontent.="</tr>";
            }
            $tablecontent.="<tr style='border-top:2px solid #ccc;'>";
            $tablecontent.='<td style="vertical-align:middle;padding-left:20px;font-weight:bold;">NET INCREASE (DECREASE) IN CASH AND CASH EQUIVALENTS</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">Php '.number_format((($incometotal-$expensestotal)-$totalnoncash)-$totalinvest,2).'</td>';
            $tablecontent.="</tr>";

            $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                    .'<thead><tr>'
                    .'<th width="60%"></th>'.
                    '<th style="text-align:right;">Total</th>'
                    .'</tr></thead>'
                    .'<tbody>'.
                    $tablecontent
                    .'</tbody>'
                    .'</table>';
            return $table;
            
        }
        public function QuaarterlyProfitAndLoss(Request $request){
            
            date_default_timezone_set('Asia/Manila');
            $ss=date('Y-')."01-01";
            
            $date1  = date('Y-m-d', strtotime($ss));
            //return $date1;
            $date2  = date('Y-m-d');
            $output = [];
            $time   =strtotime($date1);
            //return $date1." ".$date2;
            $last   = date('m-Y', strtotime($date2));

            do {
                $month = date('m-Y', $time);
                $months = date('m', $time);
                $year = date('Y', $time);
                $total = date('t', $time);

                $output[] = [
                    'month' => $month,
                    'year' => $year,
                    'months' => $months,
                    'total' => $total,
                ];

                $time = strtotime('+1 month', $time);
            } while ($month != $last);
            $CurrentYear=date('Y');
            
            $sortsetting="";
            // $FROM = date('Y-m-d', strtotime('-4 days'));
            // $TO = date('Y-m-d');
            // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->get();
            
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
            $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $et_account_details= DB::table('et_account_details')->get();
            $combinedarray=array();
            foreach($STCustomer as $ST){
                foreach($ET_Customer as $SC){
                    
                        $combinedarray[]=$SC->et_customer;
                    
                }
            }
            foreach($ET_Customer as $SC){
                foreach($STCustomer as $ST){
                
                    if($SC->et_customer!=$ST->st_customer_id){
                        $combinedarray[]=$ST->st_customer_id;
                        
                    }
                }
            
            }
            $nodup=array_unique($combinedarray);
            $STARRAY=array();
            $emptyArray = array();

            foreach($nodup as $id){
                
                foreach ($SalesTransaction as $ST) {
                    
                    if($id==$ST->st_customer_id){
                        $STARRAY['type']  = "Sales" ;
                        $STARRAY['st_no']  = $ST->st_no ;
                        $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                        $STARRAY['st_type']  = $ST->st_type ;
                        $STARRAY['st_date']  = $ST->st_date ;
                        $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                        $STARRAY['et_date']  = "None";
                        $STARRAY['et_no']  = "None" ;
                        $STARRAY['et_customer']  = "None";
                        $STARRAY['et_type']  = "None";
                        $STARRAY['remark']  = $ST->remark;
                        array_push($emptyArray, $STARRAY);
                        
                    }
                }
                foreach ($expense_transactionssss as $ET) {
                    if($id==$ET->et_customer){
                        $STARRAY['st_no']  = "None" ;
                        $STARRAY['st_customer_id']  = "None";
                        $STARRAY['st_type']  ="None";
                        $STARRAY['st_amount_paid']  = "0";
                        $STARRAY['st_date']  = "None";
                        $STARRAY['type']  = "Expense" ;
                        $STARRAY['et_no']  = $ET->et_no ;
                        $STARRAY['et_date']  = $ET->et_date ;
                        $STARRAY['et_customer']  = $ET->et_customer ;
                        $STARRAY['et_type']  = $ET->et_type ;
                        $STARRAY['remark']  = $ET->remark;
                        array_push($emptyArray, $STARRAY);
                    }
                }
                
                // foreach($st_credit_notes as $SC){
                    
                //     if($SC->st_cn_product!=$as->st_i_product){
                //         $STARRAY['st_i_rate']  = $as->st_i_rate ;
                //         $STARRAY['st_i_product']  = $as->st_i_product ;
                //         array_push($emptyArray, $STARRAY);
                //     }
                // }
                
            }
            // foreach ($emptyArray as $e) {
            //     echo $e['st_no']." ".$e['type']."<br>";
            // }
            //return "";
            $VoucherCount=Voucher::count() + 1;
            if($VoucherCount<10){
                $VoucherCount="000".$VoucherCount;
            }
            else if($VoucherCount<100 && $VoucherCount>9 ){
                $VoucherCount="00".$VoucherCount;
            }
            else if($VoucherCount<1000 && $VoucherCount>99 ){
                $VoucherCount="0".$VoucherCount;
            }
            $VoucherCount=Voucher::all();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
            $numbering = Numbering::first();
            $st_invoice = DB::table('st_invoice')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
            return view('app.QuarterlyProfitAndLoss', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','CurrentYear','output','emptyArray','nodup','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
        
        }
        public function QuarterlyProfitandlossByDate(Request $request){
            date_default_timezone_set('Asia/Manila');
            $sortsetting="";
            $sortsettingjournal="";
            $FROM=$request->FROM;
            $TO=$request->TO;
            $CostCenterFilter=$request->CostCenterFilter;
            $filtertemplate=$request->filtertemplate;
            $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
            if($sortsettingjournal==""){
                $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
            }else{
                $sortjournal="  je_cost_center='".$CostCenterFilter."'";
            }
            if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
                $sortjournal="";
                $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
                if($filtertemplate=="All"){
                    $sortsetting="";
                    $sortsettingjournal="";
                }
            }
            $CurrentYear=date('Y',strtotime($FROM));
            
            
            
            $date1  = date('Y-m-d',strtotime($FROM));
            $date2  = date('Y-m-d',strtotime($TO));
            
            
            
                $sortsetting="";
                $FirstDate= DB::connection('mysql')->select("SELECT * FROM journal_entries  ORDER BY created_at LIMIT 1");
                
                date_default_timezone_set('Asia/Manila');
               
                    $date1  = $FirstDate[0]->created_at ;
                
                
            
            $output = [];
            $time   =strtotime($date1);
            //return $date1." ".$date2;
            $last   = date('m-Y', strtotime($date2));
            
            do {
                $month = date('m-Y', $time);
                $months = date('m', $time);
                $year = date('Y', $time);
                $total = date('t', $time);
                
                $output[] = [
                    'month' => $month,
                    'year' => $year,
                    'months' => $months,
                    'total' => $total,
                ];

                $time = strtotime('+1 month', $time);
            } while ($month != $last);
            
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                                ".$sortsetting." 
                                ORDER BY st_no ASC");
                                
            $STCustomer= DB::table('sales_transaction')
                            ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                            
                            ->select('st_customer_id')
                            ->groupBy('st_customer_id')
                            ->orderBy('display_name', 'ASC')
                            ->get();
            $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
            $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
            $customers = Customers::orderBy('display_name', 'ASC')->get();
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                ".$sortsettingjournal.$sortjournal." 
                                ORDER BY created_at ASC");
            $jounal = DB::table('journal_entries')
                    ->select('je_no')
                    ->groupBy('je_no')
                    ->get();
            $jounalcount=count($jounal)+1;
            date_default_timezone_set('Asia/Manila');
            $date = date('l, d F Y h:i a \G\T\MO');
            $Report = Report::all();
            $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->whereBetween('et_date', [$FROM, $TO])
                    ->get();
            $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
        
                $expense_transactions= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->get();
                $ET_Customer= DB::table('expense_transactions')
                    ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                    ->select('et_customer')
                    ->groupBy('et_customer')
                    ->orderBy('display_name', 'ASC')
                    ->get();
                $STCustomer= DB::table('sales_transaction')
                    ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                    ->select('st_customer_id')
                    ->groupBy('st_customer_id')
                    ->orderBy('display_name', 'ASC')
                    ->get();    
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
            $et_account_details= DB::table('et_account_details')->get();
            $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();
            $combinedarray=array();
            foreach($STCustomer as $ST){
                foreach($ET_Customer as $SC){
                    
                        $combinedarray[]=$SC->et_customer;
                    
                }
            }
            foreach($ET_Customer as $SC){
                foreach($STCustomer as $ST){
                
                    if($SC->et_customer!=$ST->st_customer_id){
                        $combinedarray[]=$ST->st_customer_id;
                        
                    }
                }
            
            }
            $nodup=array_unique($combinedarray);
            $STARRAY=array();
            $emptyArray = array();

            foreach($nodup as $id){
                
                foreach ($SalesTransaction as $ST) {
                    
                    if($id==$ST->st_customer_id){
                        $STARRAY['type']  = "Sales" ;
                        $STARRAY['st_no']  = $ST->st_no ;
                        $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                        $STARRAY['st_type']  = $ST->st_type ;
                        $STARRAY['st_date']  = $ST->st_date ;
                        $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                        $STARRAY['et_date']  = "None";
                        $STARRAY['et_no']  = "None" ;
                        $STARRAY['et_customer']  = "None";
                        $STARRAY['et_type']  = "None";
                        $STARRAY['remark']  = $ST->remark;
                        array_push($emptyArray, $STARRAY);
                        
                    }
                }
                foreach ($expense_transactions as $ET) {
                    if($id==$ET->et_customer){
                        $STARRAY['st_no']  = "None" ;
                        $STARRAY['st_customer_id']  = "None";
                        $STARRAY['st_type']  ="None";
                        $STARRAY['st_amount_paid']  = "0";
                        $STARRAY['st_date']  = "None";
                        $STARRAY['type']  = "Expense" ;
                        $STARRAY['et_no']  = $ET->et_no ;
                        $STARRAY['et_date']  = $ET->et_date ;
                        $STARRAY['et_customer']  = $ET->et_customer ;
                        $STARRAY['et_type']  = $ET->et_type ;
                        $STARRAY['remark']  = $ET->remark;
                        array_push($emptyArray, $STARRAY);
                    }
                }
                
                
            }
            

            $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                //PP1
                
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        
                                
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $individualinvoice=0;
                                        $individualinvoice2=0;
                                        $individualinvoice3=0;
                                        $individualinvoice4=0;
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice2-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice2+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice3-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice3+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice4-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice4+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice2,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice3,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice4,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';    
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $individualinvoice12=0;
                                $individualinvoice22=0;
                                $individualinvoice32=0;
                                $individualinvoice42=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice12-=$JE->je_credit;
                                            }else{
                                                $individualinvoice12+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice22-=$JE->je_credit;
                                            }else{
                                                $individualinvoice22+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice32-=$JE->je_credit;
                                            }else{
                                                $individualinvoice32+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice42-=$JE->je_credit;
                                            }else{
                                                $individualinvoice42+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice-$individualinvoice12,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2-$individualinvoice22,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3-$individualinvoice32,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4-$individualinvoice42,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";
                //PP1END    
            }
            else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                    $sortjournal=" AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                
                        $tablecontent.=$ccl->cc_name;
                
                $tablecontent.='</td>';
                $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                $tablecontent.="</tr>";
                
                //PP2
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        
                                
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $individualinvoice=0;
                                        $individualinvoice2=0;
                                        $individualinvoice3=0;
                                        $individualinvoice4=0;
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice2-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice2+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice3-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice3+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice4-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice4+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice2,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice3,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice4,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';    
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $individualinvoice12=0;
                                $individualinvoice22=0;
                                $individualinvoice32=0;
                                $individualinvoice42=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice12-=$JE->je_credit;
                                            }else{
                                                $individualinvoice12+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice22-=$JE->je_credit;
                                            }else{
                                                $individualinvoice22+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice32-=$JE->je_credit;
                                            }else{
                                                $individualinvoice32+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice42-=$JE->je_credit;
                                            }else{
                                                $individualinvoice42+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice-$individualinvoice12,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2-$individualinvoice22,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3-$individualinvoice32,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4-$individualinvoice42,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";
                    //PP2END
                    
                    
                    }

            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";

            //start by individual cost center quartrely
            $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        
                                
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $individualinvoice=0;
                                        $individualinvoice2=0;
                                        $individualinvoice3=0;
                                        $individualinvoice4=0;
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice2-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice2+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice3-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice3+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $individualinvoice4-=$JE->je_credit;
                                                    }else{
                                                        $individualinvoice4+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice2,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice3,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=number_format($individualinvoice4,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice-=$JE->je_credit;
                                            }else{
                                                $individualinvoice+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2-=$JE->je_credit;
                                            }else{
                                                $individualinvoice2+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3-=$JE->je_credit;
                                            }else{
                                                $individualinvoice3+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4-=$JE->je_credit;
                                            }else{
                                                $individualinvoice4+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';    
                                $individualinvoice=0;
                                $individualinvoice2=0;
                                $individualinvoice3=0;
                                $individualinvoice4=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=='Revenues' || $Coa->coa_account_type=='Revenue'){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice+=$JE->je_credit;
                                            }else{
                                                $individualinvoice-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice2+=$JE->je_credit;
                                            }else{
                                                $individualinvoice2-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice3+=$JE->je_credit;
                                            }else{
                                                $individualinvoice3-=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice4+=$JE->je_credit;
                                            }else{
                                                $individualinvoice4-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $individualinvoice12=0;
                                $individualinvoice22=0;
                                $individualinvoice32=0;
                                $individualinvoice42=0;
                                foreach ($COA as $Coa){
                                    if($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-01-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-03-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice12-=$JE->je_credit;
                                            }else{
                                                $individualinvoice12+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-04-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-06-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice22-=$JE->je_credit;
                                            }else{
                                                $individualinvoice22+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-07-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-09-30"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice32-=$JE->je_credit;
                                            }else{
                                                $individualinvoice32+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    elseif(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($CurrentYear."-10-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($CurrentYear."-12-31"))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $individualinvoice42-=$JE->je_credit;
                                            }else{
                                                $individualinvoice42+=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice-$individualinvoice12,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice2-$individualinvoice22,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice3-$individualinvoice32,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=number_format($individualinvoice4-$individualinvoice42,2);
                                $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";
            

        }


        
        $addth="";
            foreach ($output as $cus){
            
            $addth.="<th>".$cus['month']."</th>";
            }
           
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th></th>'.'<th>Jan-Mar '.$CurrentYear.'</th>'.'<th>Apr-Jun '.$CurrentYear.'</th>'.'<th>Jul-Sep '.$CurrentYear.'</th>'.'<th>Oct-Dec '.$CurrentYear.'</th>'.'<th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ProfitAndLossByMonth(Request $request){
        $FirstDate= DB::connection('mysql')->select("SELECT * FROM journal_entries  ORDER BY created_at LIMIT 1");
        
        date_default_timezone_set('Asia/Manila');
        $date1  = date('m-d-Y');
        
            $date1  = $FirstDate[0]->created_at ;
        
        
        
        $date2  = date('Y-m-d');
        $output = [];
        $time   =strtotime($date1);
        //return $date1." ".$date2;
        $last   = date('m-Y', strtotime($date2));

        do {
            $month = date('m-Y', $time);
            $months = date('m', $time);
            $year = date('Y', $time);
            $total = date('t', $time);

            $output[] = [
                'month' => $month,
                'year' => $year,
                'months' => $months,
                'total' => $total,
            ];

            $time = strtotime('+1 month', $time);
        } while ($month != $last);


        
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $combinedarray=array();
        foreach($STCustomer as $ST){
           
            foreach($ET_Customer as $SC){
                
                    $combinedarray[]=$SC->et_customer;
                
            }
        }
        foreach($ET_Customer as $SC){
            
            foreach($STCustomer as $ST){
               
                    
                    $combinedarray[]=$ST->st_customer_id;
                
            }
        
        }
        $nodup=array_unique($combinedarray);
        
        $STARRAY=array();
        $emptyArray = array();

        foreach($nodup as $id){
            
            foreach ($SalesTransaction as $ST) {
                
                if($id==$ST->st_customer_id){
                    $STARRAY['type']  = "Sales" ;
                    $STARRAY['st_no']  = $ST->st_no ;
                    $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                    $STARRAY['st_type']  = $ST->st_type ;
                    $STARRAY['st_date']  = $ST->st_date ;
                    $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                    $STARRAY['et_date']  = "None";
                    $STARRAY['et_no']  = "None" ;
                    $STARRAY['et_customer']  = "None";
                    $STARRAY['et_type']  = "None";
                    $STARRAY['remark']  = $ST->remark;
                    array_push($emptyArray, $STARRAY);
                    
                }
            }
            foreach ($expense_transactionssss as $ET) {
                if($id==$ET->et_customer){
                    $STARRAY['st_no']  = "None" ;
                    $STARRAY['st_customer_id']  = "None";
                    $STARRAY['st_type']  ="None";
                    $STARRAY['st_amount_paid']  = "0";
                    $STARRAY['st_date']  = "None";
                    $STARRAY['type']  = "Expense" ;
                    $STARRAY['et_no']  = $ET->et_no ;
                    $STARRAY['et_date']  = $ET->et_date ;
                    $STARRAY['et_customer']  = $ET->et_customer ;
                    $STARRAY['et_type']  = $ET->et_type ;
                    $STARRAY['remark']  = $ET->remark;
                    array_push($emptyArray, $STARRAY);
                }
            }
           
            // foreach($st_credit_notes as $SC){
                
            //     if($SC->st_cn_product!=$as->st_i_product){
            //         $STARRAY['st_i_rate']  = $as->st_i_rate ;
            //         $STARRAY['st_i_product']  = $as->st_i_product ;
            //         array_push($emptyArray, $STARRAY);
            //     }
            // }
            
        }
        
        // foreach ($emptyArray as $e) {
        //     echo $e['st_no']." ".$e['type'].$e['remark']."<br>";
        // }
        // return "";
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ProfitAndLossByMonth', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','output','emptyArray','nodup','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    
    }
    public function ProfitandlossByMonthByDate(Request $request){
        date_default_timezone_set('Asia/Manila');
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        
        
        $date1  = date('Y-m-d',strtotime($FROM));
        $date2  = date('Y-m-d',strtotime($TO));
        
        
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            $FirstDate= DB::connection('mysql')->select("SELECT * FROM journal_entries  ORDER BY created_at LIMIT 1");
        
            date_default_timezone_set('Asia/Manila');
            
            $date1  = $FirstDate[0]->created_at ;
            
            $date2  = date('Y-m-d');  
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $output = [];
        $time   =strtotime($date1);
        
        //return $date1." ".$date2;
        $last   = date('m-Y', strtotime($date2));
        
        do {
            $month = date('m-Y', $time);
            $months = date('m', $time);
            $year = date('Y', $time);
            $total = date('t', $time);
            
            $output[] = [
                'month' => $month,
                'year' => $year,
                'months' => $months,
                'total' => $total,
            ];

            $time = strtotime('+1 month', $time);
        } while ($month != $last);
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->orderBy('display_name', 'ASC')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $coa_account_type= ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $ET_Customer= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->select('et_customer')
                ->groupBy('et_customer')
                ->orderBy('display_name', 'ASC')
                ->get();
            $STCustomer= DB::table('sales_transaction')
                ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                ->select('st_customer_id')
                ->groupBy('st_customer_id')
                ->orderBy('display_name', 'ASC')
                ->get();    
        }        
        $et_account_details= DB::table('et_account_details')->get();
        
        $combinedarray=array();
        foreach($STCustomer as $ST){
            foreach($ET_Customer as $SC){
                
                    $combinedarray[]=$SC->et_customer;
                
            }
        }
        foreach($ET_Customer as $SC){
            foreach($STCustomer as $ST){
            
                    $combinedarray[]=$ST->st_customer_id;
                
            }
        
        }
        $nodup=array_unique($combinedarray);
        $STARRAY=array();
        $emptyArray = array();

        foreach($nodup as $id){
            
            foreach ($SalesTransaction as $ST) {
                
                if($id==$ST->st_customer_id){
                    //echo $ST->st_no."<br>";
                    $STARRAY['type']  = "Sales" ;
                    $STARRAY['st_no']  = $ST->st_no ;
                    $STARRAY['st_customer_id']  = $ST->st_customer_id ;
                    $STARRAY['st_type']  = $ST->st_type ;
                    $STARRAY['st_date']  = $ST->st_date ;
                    $STARRAY['st_amount_paid']  = $ST->st_amount_paid ;
                    $STARRAY['et_date']  = "None";
                    $STARRAY['et_no']  = "None" ;
                    $STARRAY['et_customer']  = "None";
                    $STARRAY['et_type']  = "None";
                    $STARRAY['remark']  = $ST->remark;
                    array_push($emptyArray, $STARRAY);
                    
                }
            }
            foreach ($expense_transactions as $ET) {
                if($id==$ET->et_customer){
                    $STARRAY['st_no']  = "None" ;
                    $STARRAY['st_customer_id']  = "None";
                    $STARRAY['st_type']  ="None";
                    $STARRAY['st_amount_paid']  = "0";
                    $STARRAY['st_date']  = "None";
                    $STARRAY['type']  = "Expense" ;
                    $STARRAY['et_no']  = $ET->et_no ;
                    $STARRAY['et_date']  = $ET->et_date ;
                    $STARRAY['et_customer']  = $ET->et_customer ;
                    $STARRAY['et_type']  = $ET->et_type ;
                    $STARRAY['remark']  = $ET->remark;
                    array_push($emptyArray, $STARRAY);
                }
            }
            
            
        }
        

        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                
                
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                foreach ($output as $ST){
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                }
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_month=0;
                                    $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{

                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                    $tablecontent.=number_format($coa_month,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                        $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                        $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                foreach ($output as $ST){
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                    
                    $tablecontent.='</td>';
                }
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_month=0;
                                    $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                    $tablecontent.=number_format($coa_month,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal." 
                                    ORDER BY created_at ASC");
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                        $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                                foreach ($COA as $Coa){
                                    $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                    if ($Coa->coa_account_type=="Cost of Sales"){
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                        $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        foreach ($output as $ST){
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_month=0;
                                            $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                            foreach ($JournalEntry as $JE){
                                                if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!=""){
                                                            $coa_month-=$JE->je_credit;
                                                        }else{
                                                            $coa_month+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                            $tablecontent.='</td>';
                                        }
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                        ".$sortsettingjournal.$sortjournal." 
                                        ORDER BY created_at ASC");
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                foreach ($output as $ST){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_month=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type==$coa->coa_account_type){
                                            $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                            foreach ($JournalEntry as $JE){
                                                if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!=""){
                                                            $coa_month-=$JE->je_credit;
                                                        }else{
                                                            $coa_month+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $tablecontent.=number_format($coa_month,2);
                                    $tablecontent.='</td>';
                                }
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        

                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                            $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                            foreach ($JournalEntry as $JE){
                                                if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!=""){
                                                            $coa_month-=$JE->je_credit;
                                                        }else{
                                                            $coa_month+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $tablecontent.=number_format($coa_month,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        foreach ($output as $ST){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_month=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                            $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                            foreach ($JournalEntry as $JE){
                                                if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!=""){
                                                            $coa_month+=$JE->je_credit;
                                                        }else{
                                                            $coa_month-=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    $coa_month2=0;
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                            $zxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01"));
                                    $sssxxc=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']));
                                    $between="AND created_at BETWEEN $zxc AND $sssxxc";
                                    if($sortsettingjournal=="" && $sortjournal==""){
                                        $between="WHERE created_at BETWEEN '$zxc' AND '$sssxxc'";
                                    }else{
                                        
                                    }
                                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                                    ".$sortsettingjournal.$sortjournal.$between." 
                                    ORDER BY created_at ASC");
                                            foreach ($JournalEntry as $JE){
                                                if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                        if ($JE->je_credit!=""){
                                                            $coa_month2-=$JE->je_credit;
                                                        }else{
                                                            $coa_month2+=$JE->je_debit;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                   
                                    $tablecontent.=number_format($coa_month-$coa_month2,2);
                            $tablecontent.='</td>';
                        }
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";

            }
            else if($CostCenterFilter=="By Cost Center"){

                foreach($all_cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                            if($sortsettingjournal==""){
                                $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                            }else{
                                $sortjournal=" AND je_cost_center='".$ccl->cc_no."'";
                            }
                            $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            
                                    $tablecontent.=$ccl->cc_name;
                            
                            $tablecontent.='</td>';
                            $tablecontent.="</tr>";
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.count($output).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                            $tablecontent.="</tr>";
                            //A3
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            $tablecontent.="</tr>";
                            $IncomeTotal=0;
                            $GrossProfit=0;
                            foreach ($coa_account_type as $coa){
                                if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                    
                                    $tablecontent.="</tr>";
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type==$coa->coa_account_type){
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                            foreach ($output as $ST){
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $coa_month=0;
                                                foreach ($JournalEntry as $JE){
                                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                            if ($JE->je_credit!=""){
                                                                $coa_month+=$JE->je_credit;
                                                            }else{
                                                                $coa_month-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($coa_month,2);
                                                $tablecontent.='</td>';
                                            }
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_name_total=0;
                                            foreach ($JournalEntry as $JE){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $coa_name_total+=$JE->je_credit;
                                                    }else{
                                                        $coa_name_total-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            $IncomeTotal+=$coa_name_total;
                                            $tablecontent.=number_format($coa_name_total,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.="</tr>"; 
                                        }
                    
                                    }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                                    foreach ($JournalEntry as $JE){
                                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                if ($JE->je_credit!=""){
                                                                    $coa_month+=$JE->je_credit;
                                                                }else{
                                                                    $coa_month-=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>";
                                    
                                }
                            }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_month=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                                    foreach ($JournalEntry as $JE){
                                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                if ($JE->je_credit!=""){
                                                                    $coa_month+=$JE->je_credit;
                                                                }else{
                                                                    $coa_month-=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>";
                                    $GrossProfit+=$IncomeTotal;
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                    $tablecontent.="</tr>";
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            $tablecontent.="</tr>";
                            $IncomeTotal=0;
                            foreach ($coa_account_type as $coa){
                                if ($coa->coa_account_type=="Cost of Sales"){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                    
                                    $tablecontent.="</tr>";
                                    foreach ($COA as $Coa){
                                        if ($Coa->coa_account_type=="Cost of Sales"){
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                            foreach ($output as $ST){
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $coa_month=0;
                                                foreach ($JournalEntry as $JE){
                                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                            if ($JE->je_credit!=""){
                                                                $coa_month+=$JE->je_credit;
                                                            }else{
                                                                $coa_month-=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($coa_month,2);
                                                $tablecontent.='</td>';
                                            }
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                            $coa_name_total=0;
                                            foreach ($JournalEntry as $JE){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                    if ($JE->je_credit!=""){
                                                        $coa_name_total+=$JE->je_credit;
                                                    }else{
                                                        $coa_name_total-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                            $IncomeTotal+=$coa_name_total;
                                            $tablecontent.=number_format($coa_name_total,2);
                                            $tablecontent.='</td>';
                                            $tablecontent.="</tr>"; 
                                        }
                    
                                    }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type=="Cost of Sales"){
                                                    foreach ($JournalEntry as $JE){
                                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                if ($JE->je_credit!=""){
                                                                    $coa_month+=$JE->je_credit;
                                                                }else{
                                                                    $coa_month-=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>";
                                    
                                }
                            }
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type=="Cost of Sales"){
                                                    foreach ($JournalEntry as $JE){
                                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                if ($JE->je_credit!=""){
                                                                    $coa_month+=$JE->je_credit;
                                                                }else{
                                                                    $coa_month-=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                    $tablecontent.="</tr>";
                                    $GrossProfit+=$IncomeTotal;
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                    $tablecontent.="</tr>";
                                    $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                                    foreach ($JournalEntry as $JE){
                                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                if ($JE->je_credit!=""){
                                                                    $coa_month+=$JE->je_credit;
                                                                }else{
                                                                    $coa_month-=$JE->je_debit;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                                    $tablecontent.="</tr>";
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                                    $tablecontent.="</tr>";
                                    //expense
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                    $tablecontent.="</tr>";
                                    
                                    $TotalOperatingExpense=0;
                                    foreach ($coa_account_type as $coa){
                                        $IncomeTotal=0;
                                        if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                            
                                            $tablecontent.="</tr>"; 
                                            foreach ($COA as $Coa){
                                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                                    $tablecontent.="<tr>";
                                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                                    foreach ($output as $ST){
                                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                        $coa_month=0;
                                                        foreach ($JournalEntry as $JE){
                                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $coa_month-=$JE->je_credit;
                                                                    }else{
                                                                        $coa_month+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        $tablecontent.=number_format($coa_month,2);
                                                        $tablecontent.='</td>';
                                                    }
                                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                    $coa_name_total=0;
                                                    foreach ($JournalEntry as $JE){
                                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                            if ($JE->je_credit!=""){
                                                                $coa_name_total-=$JE->je_credit;
                                                            }else{
                                                                $coa_name_total+=$JE->je_debit;
                                                            }
                                                        }
                                                    }
                                                    $IncomeTotal+=$coa_name_total;
                                                    $tablecontent.=number_format($coa_name_total,2);
                                                    $tablecontent.='</td>';
                                                    $tablecontent.="</tr>"; 
                                                }
                                            }
                                            $tablecontent.="<tr>";
                                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                            foreach ($output as $ST){
                                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $coa_month=0;
                                                foreach ($COA as $Coa){
                                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                                        foreach ($JournalEntry as $JE){
                                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $coa_month-=$JE->je_credit;
                                                                    }else{
                                                                        $coa_month+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($coa_month,2);
                                                $tablecontent.='</td>';
                                            }
                                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                            $tablecontent.="</tr>"; 
                                        }
                                        $TotalOperatingExpense+=$IncomeTotal;
                                    }
                                    
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                                    $tablecontent.="</tr>";
                                    
                
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                                foreach ($COA as $Coa){
                                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                                        foreach ($JournalEntry as $JE){
                                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $coa_month-=$JE->je_credit;
                                                                    }else{
                                                                        $coa_month+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                                    $tablecontent.="</tr>"; 
                                    $tablecontent.="<tr style='display:none;'>";
                                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                                    $tablecontent.="</tr>";
                                    $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                                $coa_month=0;
                                                foreach ($COA as $Coa){
                                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                                        foreach ($JournalEntry as $JE){
                                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $coa_month+=$JE->je_credit;
                                                                    }else{
                                                                        $coa_month-=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                $coa_month2=0;
                                                foreach ($COA as $Coa){
                                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                                        foreach ($JournalEntry as $JE){
                                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                                    if ($JE->je_credit!=""){
                                                                        $coa_month2-=$JE->je_credit;
                                                                    }else{
                                                                        $coa_month2+=$JE->je_debit;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                               
                                                $tablecontent.=number_format($coa_month-$coa_month2,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                                    $tablecontent.="</tr>";
                            //A3END

                            
                }

                
            } 
        }else{

            //by month by individual Cost Center
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($all_cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="'.count($output).'" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //A2
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
            foreach ($output as $ST){
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
            }
            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
            $tablecontent.="</tr>";
            $IncomeTotal=0;
            $GrossProfit=0;
            foreach ($coa_account_type as $coa){
                if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                    
                    $tablecontent.="</tr>";
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type==$coa->coa_account_type){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_month=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $coa_month+=$JE->je_credit;
                                            }else{
                                                $coa_month-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.="</tr>"; 
                        }
    
                    }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $coa_month=0;
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.="</tr>";
                    
                }
            }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_month=0;
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.="</tr>";
                    $GrossProfit+=$IncomeTotal;
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
            foreach ($output as $ST){
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                
                $tablecontent.='</td>';
            }
            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
            $tablecontent.="</tr>";
            $IncomeTotal=0;
            foreach ($coa_account_type as $coa){
                if ($coa->coa_account_type=="Cost of Sales"){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                    
                    $tablecontent.="</tr>";
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_month=0;
                                foreach ($JournalEntry as $JE){
                                    if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $coa_month+=$JE->je_credit;
                                            }else{
                                                $coa_month-=$JE->je_debit;
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.="</tr>"; 
                        }
    
                    }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $coa_month=0;
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Cost of Sales"){
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.="</tr>";
                    
                }
            }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $coa_month=0;
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Cost of Sales"){
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.="</tr>";
                    $GrossProfit+=$IncomeTotal;
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $coa_month=0;
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type=="Cost of Sales" || $Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue"){
                                    foreach ($JournalEntry as $JE){
                                        if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_month+=$JE->je_credit;
                                                }else{
                                                    $coa_month-=$JE->je_debit;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                    $tablecontent.="</tr>";
                    //expense
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                    $tablecontent.="</tr>";
                    
                    $TotalOperatingExpense=0;
                    foreach ($coa_account_type as $coa){
                        $IncomeTotal=0;
                        if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            
                            $tablecontent.="</tr>"; 
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    foreach ($output as $ST){
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_month=0;
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month-=$JE->je_credit;
                                                    }else{
                                                        $coa_month+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                        $tablecontent.=number_format($coa_month,2);
                                        $tablecontent.='</td>';
                                    }
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                            foreach ($output as $ST){
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month-=$JE->je_credit;
                                                    }else{
                                                        $coa_month+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                                $tablecontent.='</td>';
                            }
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.="</tr>"; 
                        }
                        $TotalOperatingExpense+=$IncomeTotal;
                    }
                    
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
                    

                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month-=$JE->je_credit;
                                                    }else{
                                                        $coa_month+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $tablecontent.=number_format($coa_month,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                    $tablecontent.="</tr>"; 
                    $tablecontent.="<tr style='display:none;'>";
                    $tablecontent.='<td colspan="'.(count($output)+2).'" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                    foreach ($output as $ST){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_month=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month+=$JE->je_credit;
                                                    }else{
                                                        $coa_month-=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                $coa_month2=0;
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                                        foreach ($JournalEntry as $JE){
                                            if(date('Y-m-d',strtotime($JE->created_at))>=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-01")) && date('Y-m-d',strtotime($JE->created_at))<=date('Y-m-d',strtotime($ST['year']."-".$ST['months']."-".$ST['total']))){
                                                if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                    if ($JE->je_credit!=""){
                                                        $coa_month2-=$JE->je_credit;
                                                    }else{
                                                        $coa_month2+=$JE->je_debit;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                               
                                $tablecontent.=number_format($coa_month-$coa_month2,2);
                        $tablecontent.='</td>';
                    }
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                    $tablecontent.="</tr>";
            ///A2END


            //end by month by individual costcenter
        }
        
        $addth="";
            foreach ($output as $cus){
            
            $addth.="<th>".$cus['month']."</th>";
            }
           
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th></th>'.
                $addth.
                '<th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ProfitAndLost(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        // $expense_transactions= DB::table('expense_transactions')
        //         ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
        //         //->whereBetween('et_date', [$FROM, $TO])
        //         ->get();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ProfitAndLoss', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    
    public function ProfitandlossComparisonByDate(Request $request){
        date_default_timezone_set('Asia/Manila');
        $sortsetting="";
        $sortsettingjournal="";
        $sortsettingjournalpv="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $FROMpv=strtotime($request->FROM.' -1 year');
        $TOpv=strtotime($request->TO.' -1 year');
        $DateRange="Total";
        $DateRangepy="Total(PY)";
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingpv="";
            $sortsettingjournal="";
            $sortsettingjournalpv="";
        }else{
            $FROMpv=strtotime($request->FROM.' -1 year');
            $TOpv=strtotime($request->TO.' -1 year');
            $FROMpv=date('Y-m-d', $FROMpv);
            $TOpv=date('Y-m-d', $TOpv);
            $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingpv="WHERE st_date BETWEEN '".$FROMpv."' AND '".$TOpv."'";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
            $sortsettingjournalpv="WHERE created_at BETWEEN '".$FROMpv."' AND '".$TOpv."' AND";
            $DateRange=date('m-d-Y',strtotime($FROM))."<br>to<br>".date('m-d-Y',strtotime($TO));
            $DateRangepy=date('m-d-Y',strtotime($FROMpv))."<br>to<br>".date('m-d-Y',strtotime($TOpv));
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
            $sortjournalpv="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
            $sortjournalpv=" je_cost_center='".$CostCenterFilter."'";
        }
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortjournalpv="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            $sortsettingjournalpv="WHERE created_at BETWEEN '".$FROMpv."' AND '".$TOpv."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingpv="";
                $sortsettingjournal="";
                $sortsettingjournalpv="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $SalesTransactionpv= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsettingpv." 
                            ORDER BY st_no ASC");                   
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $JournalEntrypv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpv.$sortjournalpv." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $expense_transactionspv= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROMpv, $TOpv])
                ->get();
        if($filtertemplate=="All"){
            $expense_transactionspv= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        }
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get(); 
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();         $all_cost_center_list= CostCenter::all();
        
        $et_account_details= DB::table('et_account_details')->get();

        $tablecontent="";

        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $GrossProfit=0;
                $GrossProfitpv=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv+=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $GrossProfitpv+=$IncomeTotalpv;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv+=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $GrossProfitpv+=$IncomeTotalpv;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        $TotalOperatingExpensepv=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                        $IncomeTotalpv=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_totalpv=0;
                                        foreach ($JournalEntrypv as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_totalpv-=$JE->je_credit;
                                                }else{
                                                    $coa_name_totalpv+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotalpv+=$coa_name_totalpv;
                                        $tablecontent.=number_format($coa_name_totalpv,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                            $TotalOperatingExpensepv+=$IncomeTotalpv;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpensepv,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv-$TotalOperatingExpensepv,2).'</td>';
                        $tablecontent.="</tr>"; 

            }
            else if($CostCenterFilter=="By Cost Center"){
                foreach($all_cost_center_list as $ccl){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                    
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";

                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    $sortjournalpv="WHERE je_cost_center='".$ccl->cc_no."'";
                    
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    $sortjournalpv="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                        $sortjournalpv="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
                    $JournalEntrypv= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournalpv.$sortjournalpv." 
                            ORDER BY created_at ASC");
                    //comparisonbycostcenterAA11
                    $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                $GrossProfit=0;
                $GrossProfitpv=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv+=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $GrossProfitpv+=$IncomeTotalpv;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $IncomeTotalpv=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_totalpv=0;
                                foreach ($JournalEntrypv as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_totalpv+=$JE->je_credit;
                                        }else{
                                            $coa_name_totalpv-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotalpv+=$coa_name_totalpv;
                                $tablecontent.=number_format($coa_name_totalpv,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $GrossProfitpv+=$IncomeTotalpv;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        $TotalOperatingExpensepv=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                        $IncomeTotalpv=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_totalpv=0;
                                        foreach ($JournalEntrypv as $JE){
                                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_totalpv-=$JE->je_credit;
                                                }else{
                                                    $coa_name_totalpv+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotalpv+=$coa_name_totalpv;
                                        $tablecontent.=number_format($coa_name_totalpv,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                            $TotalOperatingExpensepv+=$IncomeTotalpv;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpensepv,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv-$TotalOperatingExpensepv,2).'</td>';
                        $tablecontent.="</tr>"; 
                }
            }
        }else{
            //start comparison by individual cost center
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($all_cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            
                
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
            $tablecontent.="</tr>";
            $IncomeTotal=0;
            $IncomeTotalpv=0;
            $GrossProfit=0;
            $GrossProfitpv=0;
            foreach ($coa_account_type as $coa){
                if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue"){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type==$coa->coa_account_type){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv+=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotalpv+=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.="</tr>"; 
                        }
    
                    }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                    $tablecontent.="</tr>";
                    
                }
            }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                    $tablecontent.="</tr>";
                    $GrossProfit+=$IncomeTotal;
                    $GrossProfitpv+=$IncomeTotalpv;
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
            $tablecontent.="</tr>";
            $IncomeTotal=0;
            $IncomeTotalpv=0;
            foreach ($coa_account_type as $coa){
                if ($coa->coa_account_type=="Cost of Sales"){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.="</tr>";
                    foreach ($COA as $Coa){
                        if ($Coa->coa_account_type=="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_total=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotal+=$coa_name_total;
                            $tablecontent.=number_format($coa_name_total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                            $coa_name_totalpv=0;
                            foreach ($JournalEntrypv as $JE){
                                if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalpv+=$JE->je_credit;
                                    }else{
                                        $coa_name_totalpv-=$JE->je_debit;
                                    }
                                }
                            }
                            $IncomeTotalpv+=$coa_name_totalpv;
                            $tablecontent.=number_format($coa_name_totalpv,2);
                            $tablecontent.='</td>';
                            $tablecontent.="</tr>"; 
                        }
    
                    }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotalpv,2).'</td>';
                    $tablecontent.="</tr>";
                    
                }
            }
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                    $tablecontent.="</tr>";
                    $GrossProfit+=$IncomeTotal;
                    $GrossProfitpv+=$IncomeTotalpv;
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv,2).'</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                    $tablecontent.="</tr>";
                    //expense
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                    $tablecontent.="</tr>";
                    
                    $TotalOperatingExpense=0;
                    $TotalOperatingExpensepv=0;
                    foreach ($coa_account_type as $coa){
                        $IncomeTotal=0;
                    $IncomeTotalpv=0;
                        if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                            $tablecontent.="</tr>"; 
                            foreach ($COA as $Coa){
                                if ($Coa->coa_account_type==$coa->coa_account_type){
                                    $tablecontent.="<tr>";
                                    $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_total=0;
                                    foreach ($JournalEntry as $JE){
                                        if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $coa_name_total-=$JE->je_credit;
                                            }else{
                                                $coa_name_total+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotal+=$coa_name_total;
                                    $tablecontent.=number_format($coa_name_total,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                    $coa_name_totalpv=0;
                                    foreach ($JournalEntrypv as $JE){
                                        if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                            if ($JE->je_credit!=""){
                                                $coa_name_totalpv-=$JE->je_credit;
                                            }else{
                                                $coa_name_totalpv+=$JE->je_debit;
                                            }
                                        }
                                    }
                                    $IncomeTotalpv+=$coa_name_totalpv;
                                    $tablecontent.=number_format($coa_name_totalpv,2);
                                    $tablecontent.='</td>';
                                    $tablecontent.="</tr>"; 
                                }
                            }
                            $tablecontent.="<tr>";
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotalpv,2).'</td>';
                            $tablecontent.="</tr>"; 
                        }
                        $TotalOperatingExpense+=$IncomeTotal;
                        $TotalOperatingExpensepv+=$IncomeTotalpv;
                    }
                    
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                    $tablecontent.="</tr>";
                    
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpensepv,2).'</td>';
                    $tablecontent.="</tr>"; 
                    $tablecontent.="<tr style='display:none;'>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                    $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfitpv-$TotalOperatingExpensepv,2).'</td>';
                    $tablecontent.="</tr>"; 
            //end comparison by individual cost center
        }

        

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="60%"></th><th style="text-align:right;">'.$DateRange.'</th><th style="text-align:right;">'.$DateRangepy.'</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function AccountsPayableByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        }        
        $et_account_details= DB::table('et_account_details')->get();
        $cost_center_list=CostCenter::all();
        $tablecontent="";
        $Total=0;
        $amount=0;
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach ($expense_transactions as $et){
                    if($et->et_type=="Bill" && $et->remark!="Cancelled" && $et->et_bil_status!="Paid"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=date('m-d-Y', strtotime($et->et_date));
                        $tablecontent.="</td>";
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$et->et_type;
                        $tablecontent.="</td>";
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$et->et_no;
                        $tablecontent.="</td>";
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($et->display_name!=""){
                            $tablecontent.=$et->display_name;
                        }else{
                            $tablecontent.=$et->f_name." ".$et->l_name;
                        }
                        $tablecontent.="</td>";
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($et->et_due_date!=""){
                            $date1=date_create(date('Y-m-d'));
                            $date2=date_create($et->et_due_date);
                            $diff=date_diff($date1,$date2);
        
                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) ){
                                $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "")."</span>";
                            }else{
                                $tablecontent.=$et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "";
                            }
                        }
                        
        
                        $tablecontent.="</td>";
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $amount=0;
                        foreach ($et_account_details as $ead){
                            if($et->et_no==$ead->et_ad_no){
                                $amount+=$ead->et_ad_total;
                            }
                        }
                        $tablecontent.=number_format($amount,2);
                        $Total+=$amount;
                        $tablecontent.="</td>";
                        $tablecontent.="</tr>"; 
                    }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit' )";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit' )";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit' )";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($expense_transactions as $et){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }
                            if($et->et_type=="Bill" && $et->remark!="Cancelled" && $et->et_bil_status!="Paid" && $go==1){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=date('m-d-Y', strtotime($et->et_date));
                                $tablecontent.="</td>";
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$et->et_type;
                                $tablecontent.="</td>";
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$et->et_no;
                                $tablecontent.="</td>";
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($et->display_name!=""){
                                    $tablecontent.=$et->display_name;
                                }else{
                                    $tablecontent.=$et->f_name." ".$et->l_name;
                                }
                                $tablecontent.="</td>";
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($et->et_due_date!=""){
                                    $date1=date_create(date('Y-m-d'));
                                    $date2=date_create($et->et_due_date);
                                    $diff=date_diff($date1,$date2);
                
                                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) ){
                                        $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "")."</span>";
                                    }else{
                                        $tablecontent.=$et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "";
                                    }
                                }
                                
                
                                $tablecontent.="</td>";
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $amount=0;
                                foreach ($et_account_details as $ead){
                                    if($et->et_no==$ead->et_ad_no){
                                        $amount+=$ead->et_ad_total;
                                    }
                                }
                                $tablecontent.=number_format($amount,2);
                                $Total+=$amount;
                                $tablecontent.="</td>";
                                $tablecontent.="</tr>"; 
                            }
                        }
                    }
                }
            }

        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach ($expense_transactions as $et){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                            $go=1;
						}
						
					}
					
                }
                if($et->et_type=="Bill" && $et->remark!="Cancelled" && $et->et_bil_status!="Paid" && $go==1){
                    $tablecontent.="<tr>";
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=date('m-d-Y', strtotime($et->et_date));
                    $tablecontent.="</td>";
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$et->et_type;
                    $tablecontent.="</td>";
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$et->et_no;
                    $tablecontent.="</td>";
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($et->display_name!=""){
                        $tablecontent.=$et->display_name;
                    }else{
                        $tablecontent.=$et->f_name." ".$et->l_name;
                    }
                    $tablecontent.="</td>";
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($et->et_due_date!=""){
                        $date1=date_create(date('Y-m-d'));
                        $date2=date_create($et->et_due_date);
                        $diff=date_diff($date1,$date2);
    
                        if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) ){
                            $tablecontent.="<span title='overdue' style='color:red;'>".($et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "")."</span>";
                        }else{
                            $tablecontent.=$et->et_due_date!=""? date('m-d-Y', strtotime($et->et_due_date)) : "";
                        }
                    }
                    
    
                    $tablecontent.="</td>";
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                    $amount=0;
                    foreach ($et_account_details as $ead){
                        if($et->et_no==$ead->et_ad_no){
                            $amount+=$ead->et_ad_total;
                        }
                    }
                    $tablecontent.=number_format($amount,2);
                    $Total+=$amount;
                    $tablecontent.="</td>";
                    $tablecontent.="</tr>"; 
                }
            }
        }
        
        $tablecontent.="<tr>";
        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold">';
        $tablecontent.="Total";
        $tablecontent.="</td>";
        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;text-align:right;">';
        $tablecontent.="Php ".number_format($Total,2);
        $tablecontent.="</td>";
        $tablecontent.="</tr>";
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Due Date</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ProfitandlossByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        }        
        $et_account_details= DB::table('et_account_details')->get();

        $tablecontent="";


        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" | $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                            
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                            
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        

                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 

            }
            else if($CostCenterFilter=="By Cost Center"){
                foreach($all_cost_center_list as $ccl){
                    //profitand loss
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                            if($sortsettingjournal==""){
                                $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                            }else{
                                $sortjournal=" AND je_cost_center='".$ccl->cc_no."'";
                            }
                            $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ");

                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                   
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" | $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                            
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                            
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        

                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";
                    

                    }

                
            }

        }
        else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($all_cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            //start profit and loss
            $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" | $coa->coa_account_type=="Revenue"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                            
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                            
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        

                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.="</tr>";
            //end profit and loss
            
            
        }

        

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="60%"></th><th style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function ProfitandlossaspercetagetotalByDate(Request $request){
        $sortsetting="";
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
            
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal="  je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $coa_account_type=ChartofAccount::groupBy('coa_account_type')->orderBy('coa_detail_type','ASC')->get();    
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");    
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        if($filtertemplate=="All"){
            
            $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        }        
        $et_account_details= DB::table('et_account_details')->get();

        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $totalincomeforpercent=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent+=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeforpercent2=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent2-=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeexpense=$totalincomeforpercent-$totalincomeforpercent2;
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" ){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';

                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($GrossProfit*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";


                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($TotalOperatingExpense*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format((($GrossProfit-$TotalOperatingExpense)*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 

            }
            else if($CostCenterFilter=="By Cost Center"){
                foreach($all_cost_center_list as $ccl){
                    //profitand loss
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                            if($sortsettingjournal==""){
                                $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                            }else{
                                $sortjournal=" AND je_cost_center='".$ccl->cc_no."'";
                            }
                            $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ");

                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                   
                            $tablecontent.=$ccl->cc_name;
                    
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $totalincomeforpercent=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent+=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeforpercent2=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent2-=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeexpense=$totalincomeforpercent-$totalincomeforpercent2;
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" ){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';

                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($GrossProfit*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_cost_center==$ccl->cc_no && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";


                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($TotalOperatingExpense*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format((($GrossProfit-$TotalOperatingExpense)*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 

                    }

                
            }

        }
        else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($all_cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="3" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $totalincomeforpercent=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_account_type=="Revenues" || $Coa->coa_account_type=="Revenue" || $Coa->coa_account_type=="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent+=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent-=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeforpercent2=0;
                foreach ($COA as $Coa){
                    if ($Coa->coa_title=="Expenses" && $Coa->coa_account_type!="Cost of Sales"){
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!=""){
                                    $totalincomeforpercent2-=$JE->je_credit;
                                }else{
                                    $totalincomeforpercent2+=$JE->je_debit;
                                }
                            }
                        }
                    }
                }
                $totalincomeexpense=$totalincomeforpercent-$totalincomeforpercent2;
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Income</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                $GrossProfit=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Revenues" || $coa->coa_account_type=="Revenue" ){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type==$coa->coa_account_type){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';

                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Revenue</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                $tablecontent.="<tr>";
                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Cost of Sales</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.="</tr>";
                $IncomeTotal=0;
                foreach ($coa_account_type as $coa){
                    if ($coa->coa_account_type=="Cost of Sales"){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        foreach ($COA as $Coa){
                            if ($Coa->coa_account_type=="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $coa_name_total=0;
                                foreach ($JournalEntry as $JE){
                                    if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        if ($JE->je_credit!=""){
                                            $coa_name_total+=$JE->je_credit;
                                        }else{
                                            $coa_name_total-=$JE->je_debit;
                                        }
                                    }
                                }
                                $IncomeTotal+=$coa_name_total;
                                $tablecontent.=number_format($coa_name_total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;padding-left:20px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        
                    }
                }
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:11px;">Total Cost of Sales</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $GrossProfit+=$IncomeTotal;
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr  style='background-color: #eaf0f7;border-top:2px solid #ccc'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Gross Profit</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($GrossProfit*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        //expense
                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Less Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.="</tr>";
                        
                        $TotalOperatingExpense=0;
                        foreach ($coa_account_type as $coa){
                            $IncomeTotal=0;
                            if ($coa->coa_title=="Expenses" && $coa->coa_account_type!="Cost of Sales"){
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">'.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold"></td>';
                                $tablecontent.="</tr>"; 
                                foreach ($COA as $Coa){
                                    if ($Coa->coa_account_type==$coa->coa_account_type){
                                        $tablecontent.="<tr>";
                                        $tablecontent.='<td style="vertical-align:middle;font-size:11px;padding-left:30px;">'.$Coa->coa_name.'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $coa_name_total=0;
                                        foreach ($JournalEntry as $JE){
                                            if ($JE->je_cost_center==$CostCenterFilter && $JE->je_account==$Coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                                if ($JE->je_credit!=""){
                                                    $coa_name_total-=$JE->je_credit;
                                                }else{
                                                    $coa_name_total+=$JE->je_debit;
                                                }
                                            }
                                        }
                                        $IncomeTotal+=$coa_name_total;
                                        $tablecontent.=number_format($coa_name_total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                        $tablecontent.=$totalincomeexpense!=0? number_format(($coa_name_total*100)/$totalincomeexpense,2)." %" : "0"." %";
                                        $tablecontent.='</td>';
                                        $tablecontent.="</tr>"; 
                                    }
                                }
                                $tablecontent.="<tr>";
                                $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;padding-left:20px;">Total '.$coa->coa_account_type.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($IncomeTotal,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                                $tablecontent.=$totalincomeexpense!=0? number_format(($IncomeTotal*100)/$totalincomeexpense,2)." %" : "0"." %";
                                $tablecontent.='</td>';
                                $tablecontent.="</tr>"; 
                            }
                            $TotalOperatingExpense+=$IncomeTotal;
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:1px dotted #ccc"></td>';
                        $tablecontent.="</tr>";


                        $tablecontent.="<tr>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Total Operating Expenses</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format(($TotalOperatingExpense*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 
                        $tablecontent.="<tr style='display:none;'>";
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;text-align:right;border-top:2px solid #ccc"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr style='background-color: #eaf0f7;border-top:2px solid #ccc;border-bottom:2px solid #ccc;'>";
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;font-size:14px;">Net Income</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold">'.number_format($GrossProfit-$TotalOperatingExpense,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">';
                        $tablecontent.=$totalincomeexpense!=0? number_format((($GrossProfit-$TotalOperatingExpense)*100)/$totalincomeexpense,2)." %" : "0"." %";
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>"; 
        }
        

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="60%"></th><th style="text-align:right;">Total</th><th style="text-align:right;">% OF INCOME</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function AuditLogByDate(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $before="WHERE st_date <='".$TO."'";
        
        $AuditLog =AuditLog::orderBy('created_at','DESC')
                    ->whereBetween('created_at', [$FROM, $TO])
                    ->get();
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $AuditLog =AuditLog::orderBy('created_at','DESC')
                    ->get();
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')
                ->get();
        
        $tablecontent="";
        
        foreach($AuditLog as $Log){
            $tablecontent.="<tr>";
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->created_at!=""? date('m-d-Y',strtotime($Log->created_at)) : "";
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->log_user_id;
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->log_event;
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->log_name;
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->log_transaction_date!=""? date('m-d-Y',strtotime($Log->log_transaction_date)) : "";
            $tablecontent.='</td>';
            $tablecontent.='<td style="vertical-align:middle;">';
            $tablecontent.=$Log->log_amount!=""? number_format($Log->log_amount,2) : '';
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Log Date</th><th>User</th><th width="30%">Event</th><th>Name</th><th>Date</th><th>Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function AccountList(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $chart_of_accounts= DB::table('chart_of_accounts')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.accountlist', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','chart_of_accounts','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function AuditLogs(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $AuditLog =AuditLog::orderBy('created_at','DESC')->get();
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.auditlogslist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','AuditLog','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Transaction_List_By_Date(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.transactionlistbydate', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Transaction_List_By_Supplier(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.transactionlistbysupplier', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function TransactionListByDateDate(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;

        $FROM = date('Y-m-d', strtotime('-4 days'));
        $TO = date('Y-m-d');
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate="Custom";
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $cost_center_list=CostCenter::all();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')
                ->get();
        if($filtertemplate=="All"){
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->get();
        
        }
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.="<script>";
                $tablecontent.="$(document).ready(function(){";
                foreach($expense_transactions as $et){
                    $tablecontent.="var total=0;";
                    foreach($et_account_details as $etd){
                        if($etd->et_ad_no==$et->et_no){
                            $tablecontent.="var current=".$etd->et_ad_total.";";
                            $tablecontent.="total+=current;";
                            $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                        }
                    }
                }
                
                $tablecontent.="});";
                $tablecontent.="</script>";
                foreach($expense_transactions as $et2){
                
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et2->display_name!=""){
                    $tablecontent.=$et2->display_name;
                } 
                else{
                    $tablecontent.=$et2->f_name." ".$et2->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_account;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                $tablecontent.="</tr>";
                
                }
                foreach($SalesTransaction as $ST){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($ST->display_name!=""){
                    $tablecontent.=$ST->display_name;
                } 
                else{
                    $tablecontent.=$ST->f_name." ".$ST->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                if($ST->st_type=="Credit Note"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else if($ST->st_type=="Payment"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else if($ST->st_type=="Sales Receipt"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else{
                    $tablecontent.=number_format($ST->st_balance,2);
                }
                $tablecontent.="</td>";   
                $tablecontent.="</tr>";   
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<script>";
                        $tablecontent.="$(document).ready(function(){";
                        foreach($expense_transactions as $et){
            
                            $tablecontent.="var total=0;";
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                    $go=1;
                                    }
                                    
                                }
                                
                            }
                            foreach($et_account_details as $etd){
                                if($etd->et_ad_no==$et->et_no && $go==1){
                                    $tablecontent.="var current=".$etd->et_ad_total.";";
                                    $tablecontent.="total+=current;";
                                    $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                }
                            }
                        }
                        
                        $tablecontent.="});";
                        $tablecontent.="</script>";
                        foreach($expense_transactions as $et2){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                    $go=1;
                                    }
                                    
                                }
                                
                            }
                        if($go==1){
                            $tablecontent.="<tr>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                            $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_type;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_no;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            if($et2->display_name!=""){
                                $tablecontent.=$et2->display_name;
                            } 
                            else{
                                $tablecontent.=$et2->f_name." ".$et2->l_name;
                            }
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_memo;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_account;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                            $tablecontent.="</tr>";
                        }
                        
                        
                        }
                        foreach($SalesTransaction as $ST){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Estimate"  ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }
                            if($go==1){
                                $tablecontent.="<tr>";
                                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                                $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_type;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_no;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                if($ST->display_name!=""){
                                    $tablecontent.=$ST->display_name;
                                } 
                                else{
                                    $tablecontent.=$ST->f_name." ".$ST->l_name;
                                }
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_memo;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                                if($ST->st_type=="Credit Note"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else if($ST->st_type=="Payment"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else if($ST->st_type=="Sales Receipt"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else{
                                    $tablecontent.=number_format($ST->st_balance,2);
                                }
                                $tablecontent.="</td>";   
                                $tablecontent.="</tr>"; 
                            }
                          
                        }
		
                    } 
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<script>";
            $tablecontent.="$(document).ready(function(){";
            foreach($expense_transactions as $et){

                $tablecontent.="var total=0;";
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
                foreach($et_account_details as $etd){
                    if($etd->et_ad_no==$et->et_no && $go==1){
                        $tablecontent.="var current=".$etd->et_ad_total.";";
                        $tablecontent.="total+=current;";
                        $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                    }
                }
            }
            
            $tablecontent.="});";
            $tablecontent.="</script>";
            foreach($expense_transactions as $et2){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
            if($go==1){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et2->display_name!=""){
                    $tablecontent.=$et2->display_name;
                } 
                else{
                    $tablecontent.=$et2->f_name." ".$et2->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_account;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                $tablecontent.="</tr>";
            }
            
            
            }
            foreach($SalesTransaction as $ST){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Estimate"  ) && $JJJJ->je_credit!=""){
                            $go=1;
						}
						
					}
					
                }
                if($go==1){
                    $tablecontent.="<tr>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                    $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_type;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_no;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    if($ST->display_name!=""){
                        $tablecontent.=$ST->display_name;
                    } 
                    else{
                        $tablecontent.=$ST->f_name." ".$ST->l_name;
                    }
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_memo;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                    if($ST->st_type=="Credit Note"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else if($ST->st_type=="Payment"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else if($ST->st_type=="Sales Receipt"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else{
                        $tablecontent.=number_format($ST->st_balance,2);
                    }
                    $tablecontent.="</td>";   
                    $tablecontent.="</tr>"; 
                }
              
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Memo</th><th>Account</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function TransactionListByDate_Date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $cost_center_list=CostCenter::all();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')
                ->get();
        if($filtertemplate=="All"){
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->get();
        
        }
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.="<script>";
                $tablecontent.="$(document).ready(function(){";
                foreach($expense_transactions as $et){
                    $tablecontent.="var total=0;";
                    foreach($et_account_details as $etd){
                        if($etd->et_ad_no==$et->et_no){
                            $tablecontent.="var current=".$etd->et_ad_total.";";
                            $tablecontent.="total+=current;";
                            $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                        }
                    }
                }
                
                $tablecontent.="});";
                $tablecontent.="</script>";
                foreach($expense_transactions as $et2){
                
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et2->display_name!=""){
                    $tablecontent.=$et2->display_name;
                } 
                else{
                    $tablecontent.=$et2->f_name." ".$et2->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_account;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                $tablecontent.="</tr>";
                
                }
                foreach($SalesTransaction as $ST){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($ST->display_name!=""){
                    $tablecontent.=$ST->display_name;
                } 
                else{
                    $tablecontent.=$ST->f_name." ".$ST->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$ST->st_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                if($ST->st_type=="Credit Note"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else if($ST->st_type=="Payment"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else if($ST->st_type=="Sales Receipt"){
                    $tablecontent.=number_format($ST->st_amount_paid,2);
                }
                else{
                    $tablecontent.=number_format($ST->st_balance,2);
                }
                $tablecontent.="</td>";   
                $tablecontent.="</tr>";   
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<script>";
                        $tablecontent.="$(document).ready(function(){";
                        foreach($expense_transactions as $et){
            
                            $tablecontent.="var total=0;";
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                    $go=1;
                                    }
                                    
                                }
                                
                            }
                            foreach($et_account_details as $etd){
                                if($etd->et_ad_no==$et->et_no && $go==1){
                                    $tablecontent.="var current=".$etd->et_ad_total.";";
                                    $tablecontent.="total+=current;";
                                    $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                }
                            }
                        }
                        
                        $tablecontent.="});";
                        $tablecontent.="</script>";
                        foreach($expense_transactions as $et2){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                    $go=1;
                                    }
                                    
                                }
                                
                            }
                        if($go==1){
                            $tablecontent.="<tr>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                            $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_type;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_no;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            if($et2->display_name!=""){
                                $tablecontent.=$et2->display_name;
                            } 
                            else{
                                $tablecontent.=$et2->f_name." ".$et2->l_name;
                            }
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_memo;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_account;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                            $tablecontent.="</tr>";
                        }
                        
                        
                        }
                        foreach($SalesTransaction as $ST){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Estimate"  ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }
                            if($go==1){
                                $tablecontent.="<tr>";
                                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                                $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_type;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_no;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                if($ST->display_name!=""){
                                    $tablecontent.=$ST->display_name;
                                } 
                                else{
                                    $tablecontent.=$ST->f_name." ".$ST->l_name;
                                }
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.=$ST->st_memo;
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;'>";
                                $tablecontent.="</td>";
                                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                                if($ST->st_type=="Credit Note"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else if($ST->st_type=="Payment"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else if($ST->st_type=="Sales Receipt"){
                                    $tablecontent.=number_format($ST->st_amount_paid,2);
                                }
                                else{
                                    $tablecontent.=number_format($ST->st_balance,2);
                                }
                                $tablecontent.="</td>";   
                                $tablecontent.="</tr>"; 
                            }
                          
                        }
		
                    } 
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<script>";
            $tablecontent.="$(document).ready(function(){";
            foreach($expense_transactions as $et){

                $tablecontent.="var total=0;";
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
                foreach($et_account_details as $etd){
                    if($etd->et_ad_no==$et->et_no && $go==1){
                        $tablecontent.="var current=".$etd->et_ad_total.";";
                        $tablecontent.="total+=current;";
                        $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                    }
                }
            }
            
            $tablecontent.="});";
            $tablecontent.="</script>";
            foreach($expense_transactions as $et2){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
            if($go==1){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et2->display_name!=""){
                    $tablecontent.=$et2->display_name;
                } 
                else{
                    $tablecontent.=$et2->f_name." ".$et2->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_account;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                $tablecontent.="</tr>";
            }
            
            
            }
            foreach($SalesTransaction as $ST){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Estimate"  ) && $JJJJ->je_credit!=""){
                            $go=1;
						}
						
					}
					
                }
                if($go==1){
                    $tablecontent.="<tr>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                    $tablecontent.=$ST->st_date!=""? date('m-d-Y',strtotime($ST->st_date)) : "";
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_type;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_no;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    if($ST->display_name!=""){
                        $tablecontent.=$ST->display_name;
                    } 
                    else{
                        $tablecontent.=$ST->f_name." ".$ST->l_name;
                    }
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$ST->st_memo;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                    if($ST->st_type=="Credit Note"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else if($ST->st_type=="Payment"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else if($ST->st_type=="Sales Receipt"){
                        $tablecontent.=number_format($ST->st_amount_paid,2);
                    }
                    else{
                        $tablecontent.=number_format($ST->st_balance,2);
                    }
                    $tablecontent.="</td>";   
                    $tablecontent.="</tr>"; 
                }
              
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Memo</th><th>Account</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    } 
    public function TransactionListBySupplier(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $cost_center_list=CostCenter::all();
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')
                ->get();
        if($filtertemplate=="All"){
        $expense_transactions= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                
                ->get();
        
        }
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.="<script>";
                $tablecontent.="$(document).ready(function(){";
                foreach($expense_transactions as $et){
                    if($et->remark!="Cancelled"){
                        $tablecontent.="var total=0;";
                        foreach($et_account_details as $etd){
                            if($etd->et_ad_no==$et->et_no){
                                $tablecontent.="var current=".$etd->et_ad_total.";";
                                $tablecontent.="total+=current;";
                                $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            }
                        }
                    }
                    
                }
                $tablecontent.="});";
                $tablecontent.="</script>";
                foreach($customers as $cus){
                foreach($expense_transactions as $et){
                if($cus->customer_id==$et->et_customer){

                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et->display_name!=""){
                $tablecontent.=$et->display_name;
                }
                else{
                $tablecontent.=$et->f_name." ".$et->l_name;
                }
                $tablecontent.="</td>";
                $tablecontent.="</tr>";

                foreach($expense_transactions as $et2){
                if($cus->customer_id==$et2->et_customer){
                if($et2->remark!="Cancelled"){
                    $tablecontent.="<tr>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                    $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$et2->et_type;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$et2->et_no;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    if($et2->et_due_date!=""){
                        $date1=date_create(date('Y-m-d'));
                        $date2=date_create($et2->et_due_date);
                        $diff=date_diff($date1,$date2);
                        if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et2->et_bil_status!="Paid" ){
                            $tablecontent.="<span title='overdue' style='color:red;'>".($et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "")."</span>";
                        }else{
                            $tablecontent.=$et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "";
                        }
                    }
                    
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;'>";
                    $tablecontent.=$et2->et_memo;
                    $tablecontent.="</td>";
                    $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                    $tablecontent.="</tr>";
                }

                
                }
                }
                
                break;
                } 
                }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    }else{
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                                $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<script>";
                        $tablecontent.="$(document).ready(function(){";
                        foreach($expense_transactions as $et){
                            if($et->remark!="Cancelled"){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                            $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                $tablecontent.="var total=0;";
                                foreach($et_account_details as $etd){
                                    if($etd->et_ad_no==$et->et_no && $go==1){
                                        $tablecontent.="var current=".$etd->et_ad_total.";";
                                        $tablecontent.="total+=current;";
                                        $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                    }
                                }
                            }
                            
                        }
                        $tablecontent.="});";
                        $tablecontent.="</script>";
                        foreach($customers as $cus){
                        foreach($expense_transactions as $et){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }    
                        if($cus->customer_id==$et->et_customer && $go==1){

                        $tablecontent.="<tr>";
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($et->display_name!=""){
                        $tablecontent.=$et->display_name;
                        }
                        else{
                        $tablecontent.=$et->f_name." ".$et->l_name;
                        }
                        $tablecontent.="</td>";
                        $tablecontent.="</tr>";

                        foreach($expense_transactions as $et2){
                            $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                            $go=1;
                                        }
                                        
                                    }
                                    
                                }
                        if($cus->customer_id==$et2->et_customer && $go==1){
                        if($et2->remark!="Cancelled"){
                            $tablecontent.="<tr>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                            $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_type;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_no;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            if($et2->et_due_date!=""){
                                $date1=date_create(date('Y-m-d'));
                                $date2=date_create($et2->et_due_date);
                                $diff=date_diff($date1,$date2);
                                if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et2->et_bil_status!="Paid" ){
                                    $tablecontent.="<span title='overdue' style='color:red;'>".($et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "")."</span>";
                                }else{
                                    $tablecontent.=$et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "";
                                }
                            }
                            
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>";
                            $tablecontent.=$et2->et_memo;
                            $tablecontent.="</td>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                            $tablecontent.="</tr>";
                        }

                        
                        }
                        }
                        
                        break;
                        } 
                        }
                        }
		
                    }    
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<script>";
            $tablecontent.="$(document).ready(function(){";
            foreach($expense_transactions as $et){
                if($et->remark!="Cancelled"){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                $go=1;
                            }
                            
                        }
                        
                    }
                    $tablecontent.="var total=0;";
                    foreach($et_account_details as $etd){
                        if($etd->et_ad_no==$et->et_no && $go==1){
                            $tablecontent.="var current=".$etd->et_ad_total.";";
                            $tablecontent.="total+=current;";
                            $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                        }
                    }
                }
                
            }
            $tablecontent.="});";
            $tablecontent.="</script>";
            foreach($customers as $cus){
            foreach($expense_transactions as $et){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                            $go=1;
                        }
                        
                    }
                    
                }    
            if($cus->customer_id==$et->et_customer && $go==1){

            $tablecontent.="<tr>";
            $tablecontent.="<td style='vertical-align:middle;'>";
            if($et->display_name!=""){
            $tablecontent.=$et->display_name;
            }
            else{
            $tablecontent.=$et->f_name." ".$et->l_name;
            }
            $tablecontent.="</td>";
            $tablecontent.="</tr>";

            foreach($expense_transactions as $et2){
                $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$et2->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                $go=1;
                            }
                            
                        }
                        
                    }
            if($cus->customer_id==$et2->et_customer && $go==1){
            if($et2->remark!="Cancelled"){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;text-align:center;'>";
                $tablecontent.=$et2->et_date!=""? date('m-d-Y',strtotime($et2->et_date)) : "";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_type;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_no;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($et2->et_due_date!=""){
                    $date1=date_create(date('Y-m-d'));
                    $date2=date_create($et2->et_due_date);
                    $diff=date_diff($date1,$date2);
                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && $et2->et_bil_status!="Paid" ){
                        $tablecontent.="<span title='overdue' style='color:red;'>".($et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "")."</span>";
                    }else{
                        $tablecontent.=$et2->et_due_date!=""? date('m-d-Y',strtotime($et2->et_due_date)) : "";
                    }
                }
                
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                $tablecontent.=$et2->et_memo;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et2->et_no."'></td>";
                $tablecontent.="</tr>";
            }

            
            }
            }
            
            break;
            } 
            }
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Due Date</th><th>Memo</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function Check_Details(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.chequedetail', compact('expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function ChequeDetail_bydate(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')
                ->get();
        $cost_center_list=CostCenter::all();
        if($filtertemplate=="All"){
        $expense_transactions= DB::table('expense_transactions')
                ->get();
        
        }
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.="<script>";
                $tablecontent.="$(document).ready(function(){";
                foreach($expense_transactions as $et){
                    $tablecontent.="var total=0;";
                    foreach($et_account_details as $etd){
                        if($etd->et_ad_no==$et->et_no){
                            $tablecontent.="var current=".$etd->et_ad_total.";";
                            $tablecontent.="total+=current;";
                            $tablecontent.="if(total<0){";
                            $tablecontent.="total=total*-1;";
                            $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tablecontent.="}";
                            $tablecontent.="else{";
                             $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";   
                            $tablecontent.="}";

                            
                        }
                    }
                }
                $tablecontent.="});";
                $tablecontent.="</script>";
                foreach($expense_transactions as $et){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_date."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_type."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_no."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_memo."</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et->et_no."'></td>";
                $tablecontent.="</tr>";
                
                foreach($et_account_details as $etd){
                    if($etd->et_ad_no==$et->et_no){
                        $tablecontent.="<tr>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'>".$etd->et_ad_desc."</td>";
                        $tablecontent.="<td style='vertical-align:middle;text-align:right;'>".number_format($etd->et_ad_total,2)."</td>";
                        $tablecontent.="</tr>";   
                    }
                }
                }
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;'></td>";
                $tablecontent.="<td style='vertical-align:middle;'></td>";
                $tablecontent.="<td style='vertical-align:middle;'></td>";
                $tablecontent.="<td style='vertical-align:middle;'></td>";
                $tablecontent.="<td style='vertical-align:middle;'></td>";
                
                $tablecontent.="</tr>";
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'  AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'  AND (je_transaction_type='Bill' OR je_transaction_type='Cheque' OR je_transaction_type='Expense' OR je_transaction_type='Supplier Credit' OR je_transaction_type='Credit card credit')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<script>";
                        $tablecontent.="$(document).ready(function(){";
                        foreach($expense_transactions as $et){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }
                            $tablecontent.="var total=0;";
                            foreach($et_account_details as $etd){
                                if($etd->et_ad_no==$et->et_no && $go==1){
                                    $tablecontent.="var current=".$etd->et_ad_total.";";
                                    $tablecontent.="total+=current;";
                                    $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                }
                            }
                        }
                        $tablecontent.="});";
                        $tablecontent.="</script>";
                        foreach($expense_transactions as $et){
                        $go=0;
                        foreach($JournalEntry as $JJJJ){
                            if($JJJJ->je_cost_center==$ccl->cc_no){
                                if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                                    $go=1;
                                }
                                    
                            }
                        }
                        if($go==1){
                            $tablecontent.="<tr>";
                            $tablecontent.="<td style='vertical-align:middle;'>".$et->et_date."</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>".$et->et_type."</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>".$et->et_no."</td>";
                            $tablecontent.="<td style='vertical-align:middle;'>".$et->et_memo."</td>";
                            $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et->et_no."'></td>";
                            $tablecontent.="</tr>";
                            
                            foreach($et_account_details as $etd){
                                if($etd->et_ad_no==$et->et_no){
                                    $tablecontent.="<tr>";
                                    $tablecontent.="<td style='vertical-align:middle;'></td>";
                                    $tablecontent.="<td style='vertical-align:middle;'></td>";
                                    $tablecontent.="<td style='vertical-align:middle;'></td>";
                                    $tablecontent.="<td style='vertical-align:middle;'>".$etd->et_ad_desc."</td>";
                                    $tablecontent.="<td style='vertical-align:middle;text-align:right;'>".number_format($etd->et_ad_total,2)."</td>";
                                    $tablecontent.="</tr>";   
                                }
                            }
                        }
                        
                        }
                        $tablecontent.="<tr>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        
                        $tablecontent.="</tr>";
		
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<script>";
            $tablecontent.="$(document).ready(function(){";
            foreach($expense_transactions as $et){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                            $go=1;
						}
						
					}
					
                }
                $tablecontent.="var total=0;";
                foreach($et_account_details as $etd){
                    if($etd->et_ad_no==$et->et_no && $go==1){
                        $tablecontent.="var current=".$etd->et_ad_total.";";
                        $tablecontent.="total+=current;";
                        $tablecontent.="document.getElementById('Total".$et->et_no."').innerHTML='-'+(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                    }
                }
            }
            $tablecontent.="});";
            $tablecontent.="</script>";
            foreach($expense_transactions as $et){
            $go=0;
            foreach($JournalEntry as $JJJJ){
                if($JJJJ->je_cost_center==$CostCenterFilter){
                    if($JJJJ->other_no==$et->et_no && ($JJJJ->je_transaction_type=="Expense" || $JJJJ->je_transaction_type=="Bill" || $JJJJ->je_transaction_type=="Cheque" || $JJJJ->je_transaction_type=="Supplier Credit" || $JJJJ->je_transaction_type=="Credit card credit") && $JJJJ->je_credit!=""){
                        $go=1;
					}
						
				}
            }
            if($go==1){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_date."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_type."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_no."</td>";
                $tablecontent.="<td style='vertical-align:middle;'>".$et->et_memo."</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;' id='Total".$et->et_no."'></td>";
                $tablecontent.="</tr>";
                
                foreach($et_account_details as $etd){
                    if($etd->et_ad_no==$et->et_no){
                        $tablecontent.="<tr>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'></td>";
                        $tablecontent.="<td style='vertical-align:middle;'>".$etd->et_ad_desc."</td>";
                        $tablecontent.="<td style='vertical-align:middle;text-align:right;'>".number_format($etd->et_ad_total,2)."</td>";
                        $tablecontent.="</tr>";   
                    }
                }
            }
            
            }
            $tablecontent.="<tr>";
            $tablecontent.="<td style='vertical-align:middle;'></td>";
            $tablecontent.="<td style='vertical-align:middle;'></td>";
            $tablecontent.="<td style='vertical-align:middle;'></td>";
            $tablecontent.="<td style='vertical-align:middle;'></td>";
            $tablecontent.="<td style='vertical-align:middle;'></td>";
            
            $tablecontent.="</tr>";
        }

        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Memo</th><th style="text-align:right;">Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function General_Ledger_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $AccountFilter=$request->AccountFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$before." 
                            ORDER BY st_no ASC");
        $SalesTransaction2= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$before." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
                        //whereBetween('created_at', [$FROM, $TO])
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        if($AccountFilter=='All'){
                    $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        }else{
            $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE id='$AccountFilter' ORDER BY coa_code+0 ASC");
            
        }
        
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->whereBetween('et_date', [$FROM, $TO])
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        if($filtertemplate=="All"){
            //$JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        }
        $cost_center_list=CostCenter::all();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $coa_name_totaldebit=0;
                $coa_name_totalcredit=0;
                foreach ($COA as $coa){
                    $coa_name_total=0;
                    $coa_name_totalc=0;
                    $coa_name_totald=0;
                    foreach ($JournalEntry as $JE){
                        if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                            if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                $coa_name_totalc+=$JE->je_credit;
                                $coa_name_total+=$JE->je_credit;
                            }else{
                                $coa_name_totald+=$JE->je_debit;
                                $coa_name_total-=$JE->je_debit;
                            }
                        }
                    }
                    if ($coa_name_totalc!=0 || $coa_name_totald!=0){
                        $tablecontent.='<tr >';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">'.$coa->coa_name.'\'s Beginning Balance</td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa->coa_balance,2).'</td>';  
                        $tablecontent.='</tr>';  
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    $tablecontent.='<tr>';  
                                    $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_credit,2).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='</tr>'; 
                                }else{
                                    $tablecontent.='<tr>';  
                                    $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>'; 
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_debit,2).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                        $tablecontent.='<tr >';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3"><a class="btn btn-link" title="view sub Ledger" href="sub_ledger?chart_of_accounts='.$coa->id.'">'.$coa->coa_name." (".$coa->coa_code.")".'</a></td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totald,2).'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totalc,2).'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc),2).'</td>';  
                        $tablecontent.='</tr>'; 
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">Retained Earnings</td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc)+$coa->coa_balance,2).'</td>';  
                        $tablecontent.='</tr>'; 
                        
                    }
                    $coa_name_totaldebit+=$coa_name_totald;
                    $coa_name_totalcredit+=$coa_name_totalc;
                }
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
                $tablecontent.='<td style="vertical-align:middle;" colspan="3">Total</td>'; 
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';  
                $tablecontent.='</tr>';  
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");

                    if(count($JournalEntry)!=0){
                        
            
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            $tablecontent.=$ccl->cc_name;
                    $tablecontent.='</td>';
                    $tablecontent.="</tr>";
                    $tablecontent.="<tr>";
                    $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                    $tablecontent.="</tr>";
                    $coa_name_totaldebit=0;
                    $coa_name_totalcredit=0;
                    foreach ($COA as $coa){
                        $coa_name_total=0;
                        $coa_name_totalc=0;
                        $coa_name_totald=0;
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    $coa_name_totalc+=$JE->je_credit;
                                    $coa_name_total+=$JE->je_credit;
                                }else{
                                    $coa_name_totald+=$JE->je_debit;
                                    $coa_name_total-=$JE->je_debit;
                                }
                            }
                        }
                        if ($coa_name_totalc!=0 || $coa_name_totald!=0){
                            $tablecontent.='<tr >';  
                                         
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">'.$coa->coa_name.'\'s Beginning Balance</td>';  
                            
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa->coa_balance,2).'</td>';  
                            $tablecontent.='</tr>'; 
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                        $tablecontent.='<tr>';  
                                        $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_credit,2).'</td>'; 
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>'; 
                                        $tablecontent.='</tr>'; 
                                    }else{
                                        $tablecontent.='<tr>';  
                                        $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_debit,2).'</td>';  
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                        $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';
                                        $tablecontent.='</tr>'; 
                                    }
                                }
                            }
                            $tablecontent.='<tr >';  
                                         
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3"><a class="btn btn-link" title="view sub Ledger" href="sub_ledger?chart_of_accounts='.$coa->id.'">'.$coa->coa_name." (".$coa->coa_code.")".'</a></td>';  
                            
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totald,2).'</td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totalc,2).'</td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc),2).'</td>';  
                            $tablecontent.='</tr>'; 
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';  
                                            
                            $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">Retained Earnings</td>';  
                            
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc)+$coa->coa_balance,2).'</td>';  
                            $tablecontent.='</tr>';  
                        }
                        $coa_name_totaldebit+=$coa_name_totald;
                        $coa_name_totalcredit+=$coa_name_totalc;
                    }
                    $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
                    $tablecontent.='<td style="vertical-align:middle;" colspan="3">Total</td>';  
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>';  
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';  
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';
                    $tablecontent.='</tr>';  
                    }
            }
        }
        }else{
            
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
                $coa_name_totaldebit=0;
                $coa_name_totalcredit=0;
                foreach ($COA as $coa){
                    $coa_name_total=0;
                    $coa_name_totalc=0;
                    $coa_name_totald=0;
                    foreach ($JournalEntry as $JE){
                        if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                            if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                $coa_name_totalc+=$JE->je_credit;
                                $coa_name_total+=$JE->je_credit;
                            }else{
                                $coa_name_totald+=$JE->je_debit;
                                $coa_name_total-=$JE->je_debit;
                            }
                        }
                    }
                    if ($coa_name_totalc!=0 || $coa_name_totald!=0){
                        $tablecontent.='<tr >';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">'.$coa->coa_name.'\'s Beginning Balance</td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa->coa_balance,2).'</td>';  
                        $tablecontent.='</tr>'; 
                        foreach ($JournalEntry as $JE){
                            if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                                if ($JE->je_credit!="" && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                                    $tablecontent.='<tr>';  
                                    $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_credit,2).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';
                                    $tablecontent.='</tr>'; 
                                }else{
                                    $tablecontent.='<tr>';  
                                    $tablecontent.='<td style="vertical-align:middle;padding-left:20px;">'.date('m-d-Y',strtotime($JE->created_at)).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->other_no.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;">'.$JE->je_desc.'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;">'.number_format($JE->je_debit,2).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';
                                    $tablecontent.='</tr>'; 
                                }
                            }
                        }
                        $tablecontent.='<tr >';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3"><a class="btn btn-link" title="view sub Ledger" href="sub_ledger?chart_of_accounts='.$coa->id.'">'.$coa->coa_name." (".$coa->coa_code.")".'</a></td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totald,2).'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format($coa_name_totalc,2).'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc),2).'</td>';  
                        $tablecontent.='</tr>'; 
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';  
                                         
                        $tablecontent.='<td style="vertical-align:middle;font-weight:bold;" colspan="3">Retained Earnings</td>';  
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($coa_name_totald-$coa_name_totalc)+$coa->coa_balance,2).'</td>';  
                        $tablecontent.='</tr>';  
                    }
                    $coa_name_totaldebit+=$coa_name_totald;
                    $coa_name_totalcredit+=$coa_name_totalc;
                }
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
                $tablecontent.='<td style="vertical-align:middle;" colspan="3">Total</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;padding-left:20px;"></td>';
                $tablecontent.='</tr>';    
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="20%">Account Title</th><th width="20%" >Ref No</th><th width="20%" >Description</th>
                <th width="20%" style="text-align:right;">Debit</th><th width="20%" style="text-align:right;">Credit</th><th width="20%" style="text-align:right;"></th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;


    }
    public function AccountsPayableAgeingSummary(Request $request){
        $sortsetting="";
        // $FROM = date('Y-m-d', strtotime('-4 days'));
        // $TO = date('Y-m-d');
        // $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
                            
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
        $expense_transactionssss= DB::table('expense_transactions')
                ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
                //->whereBetween('et_date', [$FROM, $TO])
                ->get();
        $et_account_details= DB::table('et_account_details')->get();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $paybillgroup = DB::table('pay_bill')
                ->select('*')
                ->groupBy('bill_no')
                ->get();
        $VoucherCount=Voucher::all();
        $et_acc = DB::table('et_account_details')->get();
        $et_it = DB::table('et_item_details')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();
        $ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $st_invoice = DB::table('st_invoice')->get();
        return view('app.AccountsPayableAgeingSummary', compact('paybillgroup','expense_transactionssss','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','et_acc','et_it','VoucherCount','et_account_details','expense_transactions','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function AccountsPayableAgeingSummaryByDate(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE payment_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE payment_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $ETran = DB::table('expense_transactions')->get();
        $paybillgroup= DB::connection('mysql')->select("SELECT * FROM pay_bill
                            ".$sortsetting." GROUP BY  bill_no");
        $PayBill= DB::connection('mysql')->select("SELECT * FROM pay_bill
                            ".$sortsetting."");
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $et_account_details= DB::table('et_account_details')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
        $tablecontent='';
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $totalonetotal=0;
                $totalrqototal=0;
                $totalthreetotal=0;
                $totalfourtotal=0;
                $totaltotaltotal=0;
                $totaltotal2=0;
                foreach ($paybillgroup as $pb){
                    foreach ($ETran as $et){
                        if ($et->remark!="Cancelled"){
                            if ($pb->bill_no==$et->et_no && $et->et_type=="Bill"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td style="vertical-align:middle;">'.$et->et_no.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                foreach ($customers as $customer){
                                    if ($customer->customer_id==$et->et_customer){
                                        $tablecontent.=$customer->display_name!=""? $customer->display_name  : $customer->f_name." ".$customer->l_name;
                                    }
                                }
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $total=0;
                                foreach ($et_account_details as $ea){
                                    if ($ea->et_ad_no==$pb->bill_no && $ea->et_ad_type=="Bill"){
                                        $total+=$ea->et_ad_total;
                                    }
                                }
                                $tablecontent.=number_format($total,2);
                                $totaltotal2+=$total;
                                $tablecontent.='</td>';
                                $totalone=0;
                                $totalrqo=0;
                                $totalthree=0;
                                $totalfour=0;
                                $totaltotal=0;
                                foreach ($PayBill as $pp){
                                    if ($pb->bill_no==$pp->bill_no){
                                        if($pp->payment_date>date('Y-m-d', strtotime('-30 days'))){
                                            $totalone+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-31 days')) && $pp->payment_date>date('Y-m-d', strtotime('-60 days'))){
                                            $totalrqo+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-61 days')) && $pp->payment_date>date('Y-m-d', strtotime('-90 days'))){
                                            $totalthree+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-91 days'))){
                                            $totalfour+=$pp->bill_payment_amount;
                                        }
                                        $totaltotal+=$pp->bill_payment_amount;
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalone,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalrqo,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalthree,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalfour,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totaltotal,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                $totalonetotal+=$totalone;
                                $totalrqototal+=$totalrqo;
                                $totalthreetotal+=$totalthree;
                                $totalfourtotal+=$totalfour;
                                $totaltotaltotal+=$totaltotal;
                            }
                        }
                    }
                }
                        $tablecontent.='<tr style="font-weight:bold;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.=number_format($totaltotal2,2);
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalonetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqototal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthreetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfourtotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
            }else if($CostCenterFilter=="By Cost Center"){

            }
        }else{
            $totalonetotal=0;
            $totalrqototal=0;
            $totalthreetotal=0;
            $totalfourtotal=0;
            $totaltotaltotal=0;
            $totaltotal2=0;
            foreach ($paybillgroup as $pb){
                $valid_cost_center=0;
                foreach($JournalEntry as $JE){
                    if($JE->other_no==$pb->bill_no && $JE->je_transaction_type=="Bill" && $JE->je_cost_center==$CostCenterFilter){
                        $valid_cost_center=1;
                    }
                }
                if($valid_cost_center==1){
                    foreach ($ETran as $et){
                        if ($et->remark!="Cancelled"){
                            if ($pb->bill_no==$et->et_no && $et->et_type=="Bill"){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td style="vertical-align:middle;">'.$et->et_no.'</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                foreach ($customers as $customer){
                                    if ($customer->customer_id==$et->et_customer){
                                        $tablecontent.=$customer->display_name!=""? $customer->display_name  : $customer->f_name." ".$customer->l_name;
                                    }
                                }
                                
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $total=0;
                                foreach ($et_account_details as $ea){
                                    if ($ea->et_ad_no==$pb->bill_no && $ea->et_ad_type=="Bill"){
                                        $total+=$ea->et_ad_total;
                                    }
                                }
                                $tablecontent.=number_format($total,2);
                                $totaltotal2+=$total;
                                $tablecontent.='</td>';
                                $totalone=0;
                                $totalrqo=0;
                                $totalthree=0;
                                $totalfour=0;
                                $totaltotal=0;
                                foreach ($PayBill as $pp){
                                    if ($pb->bill_no==$pp->bill_no){
                                        if($pp->payment_date>date('Y-m-d', strtotime('-30 days'))){
                                            $totalone+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-31 days')) && $pp->payment_date>date('Y-m-d', strtotime('-60 days'))){
                                            $totalrqo+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-61 days')) && $pp->payment_date>date('Y-m-d', strtotime('-90 days'))){
                                            $totalthree+=$pp->bill_payment_amount;
                                        }
                                        if($pp->payment_date<date('Y-m-d', strtotime('-91 days'))){
                                            $totalfour+=$pp->bill_payment_amount;
                                        }
                                        $totaltotal+=$pp->bill_payment_amount;
                                    }
                                }
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalone,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalrqo,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalthree,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalfour,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totaltotal,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                $totalonetotal+=$totalone;
                                $totalrqototal+=$totalrqo;
                                $totalthreetotal+=$totalthree;
                                $totalfourtotal+=$totalfour;
                                $totaltotaltotal+=$totaltotal;
                            }
                        }
                    }
                }
                
            }
                        $tablecontent.='<tr style="font-weight:bold;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.=number_format($totaltotal2,2);
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalonetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqototal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthreetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfourtotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';

        }

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th></th><th></th><th>Current</th><th>1-30</th><th>31-60</th><th>61-90</th><th>91 and above</th><th>Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function Trial_balance_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $CostCenterFilter=$request->CostCenterFilter;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        $before="WHERE st_date <='".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
            $before="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$before." 
                            ORDER BY st_no ASC");
        $SalesTransaction2= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$before." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
                        //whereBetween('created_at', [$FROM, $TO])
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortsettingjournal.$sortjournal." 
                            ORDER BY created_at ASC");
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $expense_transactions= DB::table('expense_transactions')
                ->whereBetween('et_date', [$FROM, $TO])
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        if($filtertemplate=="All"){
            //$JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('created_at','ASC')->get();
            $expense_transactions= DB::table('expense_transactions')
                ->join('et_account_details', 'et_account_details.et_ad_no', '=', 'expense_transactions.et_no')
                ->get();
        }
        $cost_center_list=CostCenter::all();
        $AccountRecievable=0;
        $Cash=0;
        $Sales=0;
        $ExpensesTotal=0;
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $coa_name_totaldebit=0;
                $coa_name_totalcredit=0;
                $totaltotalssasdasd=0;
                $totaltotalssasdasd_d=0;
                $beginningbalance_total=0;
                $beginningbalance_total_d=0;
                $retaunbedearnings=0;
                $LandImprovements=0;
                foreach ($COA as $coa){
                    if($coa->coa_name=='Arkcons, Capital'){
                        $retaunbedearnings=1;
                        $RetainedEarningsSubs=0;
                        $data=Advance::first();
                        if(!empty($data)){
                            $RetainedEarningsSubs+=$data->advance_beginning_balance;
                        }
                        $tablecontent.='<tr>';  
                        $tablecontent.='<td style="vertical-align:middle;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                        $tablecontent.='<td style="vertical-align:middle;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                        $tablecontent.='</tr>'; 
                    } 
                    $coa_name_total=0;
                    $coa_name_totalc=0;
                    $coa_name_totald=0;
                    
                    foreach ($JournalEntry as $JE){
                        if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED'){
                            if ($JE->je_credit!=""){
                                $coa_name_totalc+=$JE->je_credit;
                                $coa_name_total+=$JE->je_credit;
                            }else{
                                $coa_name_totald+=$JE->je_debit;
                                $coa_name_total-=$JE->je_debit;
                            }
                        }
                    }
                    if($coa->coa_name=='Land Improvements'){
                        
                    }
                    //if ("$coa_name_totalc!=0 || $coa_name_totald!=0"){
                    if(""==""){
                        
                        // if($coa->normal_balance=="Debit"){
                        //     $coa_name_totald+=$coa->coa_balance;
                        // }
                        // else if($coa->normal_balance=="Credit"){
                        //     $coa_name_totalc+=$coa->coa_balance;
                        // }
                        

                        $debit=0;
                        $credit=0;
                        if($coa_name_totalc<$coa_name_totald){
                            $debit=$coa_name_totalc-$coa_name_totald;
                            if($debit<0){
                                $debit*=-1;
                            }
                            $credit="";
                        }else if($coa_name_totalc>$coa_name_totald){
                            $debit="";
                            $credit=$coa_name_totalc-$coa_name_totald;
                            if($credit<0){
                                $credit*=-1;
                            }
                        }
                        $credit_validated=$credit!=""? $credit : 0;
                        $debit_validated=$debit!=""? $debit : 0;
                        $tablecontent.='<tr>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_code.'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_name.'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_account_type.'</td>'; 
                        if($coa->normal_balance=="Debit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>'; 
                            $beginningbalance_total_d+=$coa->coa_balance;
                        }
                        else if($coa->normal_balance=="Credit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>'; 
                            $beginningbalance_total+=$coa->coa_balance;
                        } 
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($debit!=""? number_format($debit,2) : '').'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($credit!=""? number_format($credit,2): '').'</td>';
                        if($coa->normal_balance=="Debit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)+$coa->coa_balance,2).'</td>'; 
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                            $totaltotalssasdasd_d+=($debit_validated-$credit_validated)+$coa->coa_balance; 
                        }
                        else if($coa->normal_balance=="Credit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)-$coa->coa_balance,2).'</td>'; 
                            $totaltotalssasdasd+=($debit_validated-$credit_validated)-$coa->coa_balance; 
                        }
                        $tablecontent.='</tr>';  
                    }
                    $coa_name_totaldebit+=$coa_name_totald;
                    $coa_name_totalcredit+=$coa_name_totalc;
                }
                if($retaunbedearnings==0){
                    $RetainedEarningsSubs=0;
                    $data=Advance::first();
                    if(!empty($data)){
                        $RetainedEarningsSubs+=$data->advance_beginning_balance;
                    }
                    $tablecontent.='<tr>';  
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                    $tablecontent.='</tr>'; 
                }
                $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
                $tablecontent.='<td colspan="3" style="vertical-align:middle;">Total</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total_d,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total+$RetainedEarningsSubs,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>'; 
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd_d,2).'</td>';  
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd-$RetainedEarningsSubs,2).'</td>';  
                $tablecontent.='</tr>';  
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'";
                    }else{
                        $sortjournal="AND je_cost_center='".$ccl->cc_no."'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");

                    if(count($JournalEntry)!=0){
                        
                        $beginningbalance_total=0;
                        $beginningbalance_total_d=0;
                        $coa_name_totaldebit=0;
                        $coa_name_totalcredit=0;
                        $totaltotalssasdasd=0;
                        $totaltotalssasdasd_d=0;
                        $retaunbedearnings=0;
                        foreach ($COA as $coa){
                            if($coa->coa_name=='Arkcons, Capital'){
                                $retaunbedearnings=1;
                                $RetainedEarningsSubs=0;
                                $data=Advance::first();
                                if(!empty($data)){
                                    $RetainedEarningsSubs+=$data->advance_beginning_balance;
                                }
                                $tablecontent.='<tr>';  
                                $tablecontent.='<td style="vertical-align:middle;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                                $tablecontent.='<td style="vertical-align:middle;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                                $tablecontent.='</tr>'; 
                            } 
                            $coa_name_total=0;
                            $coa_name_totalc=0;
                            $coa_name_totald=0;
                            foreach ($JournalEntry as $JE){
                                if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$ccl->cc_no){
                                    if ($JE->je_credit!=""){
                                        $coa_name_totalc+=$JE->je_credit;
                                        $coa_name_total+=$JE->je_credit;
                                    }else{
                                        $coa_name_totald+=$JE->je_debit;
                                        $coa_name_total-=$JE->je_debit;
                                    }
                                }
                            }
                             //if ("$coa_name_totalc!=0 || $coa_name_totald!=0"){
                            if(""==""){
                                //$coa_name_totald+=$coa->coa_balance;
                                $debit=0;
                                $credit=0;
                                if($coa_name_totalc<$coa_name_totald){
                                    $debit=$coa_name_totalc-$coa_name_totald;
                                    if($debit<0){
                                        $debit*=-1;
                                    }
                                    $credit="";
                                }else if($coa_name_totalc>$coa_name_totald){
                                    $debit="";
                                    $credit=$coa_name_totalc-$coa_name_totald;
                                    if($credit<0){
                                        $credit*=-1;
                                    }
                                }
                                $credit_validated=$credit!=""? $credit : 0;
                                $debit_validated=$debit!=""? $debit : 0;
                                $tablecontent.='<tr>';  
                                $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_code.'</td>';  
                                $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_name.'</td>';  
                                $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_account_type.'</td>'; 
                                if($coa->normal_balance=="Debit"){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>'; 
                                    $beginningbalance_total_d+=$coa->coa_balance;
                                }
                                else if($coa->normal_balance=="Credit"){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';  
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>'; 
                                    $beginningbalance_total+=$coa->coa_balance;
                                } 
                                
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($debit!=""? number_format($debit,2) : '').'</td>';  
                                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($credit!=""? number_format($credit,2): '').'</td>';
                                if($coa->normal_balance=="Debit"){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)+$coa->coa_balance,2).'</td>'; 
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                                    $totaltotalssasdasd_d+=($debit_validated-$credit_validated)+$coa->coa_balance; 
                                }
                                else if($coa->normal_balance=="Credit"){
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)-$coa->coa_balance,2).'</td>'; 
                                    $totaltotalssasdasd+=($debit_validated-$credit_validated)-$coa->coa_balance; 
                                }   
                                
                                
                                
                                $tablecontent.='</tr>'; 
                            }
                            $coa_name_totaldebit+=$coa_name_totald;
                            $coa_name_totalcredit+=$coa_name_totalc;
                        }
                        if($retaunbedearnings==0){
                            $RetainedEarningsSubs=0;
                            $data=Advance::first();
                            if(!empty($data)){
                                $RetainedEarningsSubs+=$data->advance_beginning_balance;
                            }
                            $tablecontent.='<tr>';  
                            $tablecontent.='<td style="vertical-align:middle;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                            $tablecontent.='<td style="vertical-align:middle;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                            $tablecontent.='</tr>'; 
                        } 
                        $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
                        $tablecontent.='<td colspan="3" style="vertical-align:middle;">Total</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total_d,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>'; 
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd_d,2).'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd,2).'</td>'; 
                        $tablecontent.='</tr>';     
                    }
            }
        }
        }else{
            
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="6" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $coa_name_totaldebit=0;
            $coa_name_totalcredit=0;
            $totaltotalssasdasd=0;
            $totaltotalssasdasd_d=0;
            $retaunbedearnings=0;
            foreach ($COA as $coa){
                if($coa->coa_name=='Arkcons, Capital'){
                    $retaunbedearnings=1;
                    $RetainedEarningsSubs=0;
                    $data=Advance::first();
                    if(!empty($data)){
                        $RetainedEarningsSubs+=$data->advance_beginning_balance;
                    }
                    $tablecontent.='<tr>';  
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                    $tablecontent.='</tr>'; 
                } 
                $beginningbalance_total=0;
                $beginningbalance_total_d=0;
                $coa_name_total=0;
                $coa_name_totalc=0;
                $coa_name_totald=0;
                foreach ($JournalEntry as $JE){
                    if ($JE->je_account==$coa->id && $JE->remark!='Cancelled' && $JE->remark!='NULLED' && $JE->je_cost_center==$CostCenterFilter){
                        if ($JE->je_credit!=""){
                            $coa_name_totalc+=$JE->je_credit;
                            $coa_name_total+=$JE->je_credit;
                        }else{
                            $coa_name_totald+=$JE->je_debit;
                            $coa_name_total-=$JE->je_debit;
                        }
                    }
                }
                 //if ("$coa_name_totalc!=0 || $coa_name_totald!=0"){
                    if(""==""){
                    //$coa_name_totald+=$coa->coa_balance;
                    $debit=0;
                    $credit=0;
                    if($coa_name_totalc<$coa_name_totald){
                        $debit=$coa_name_totalc-$coa_name_totald;
                        if($debit<0){
                            $debit*=-1;
                        }
                        $credit="";
                    }else if($coa_name_totalc>$coa_name_totald){
                        $debit="";
                        $credit=$coa_name_totalc-$coa_name_totald;
                        if($credit<0){
                            $credit*=-1;
                        }
                    }
                    $credit_validated=$credit!=""? $credit : 0;
                    $debit_validated=$debit!=""? $debit : 0;
                    $tablecontent.='<tr>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_code.'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_name.'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;">'.$coa->coa_account_type.'</td>'; 
                        if($coa->normal_balance=="Debit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>'; 
                            $beginningbalance_total_d+=$coa->coa_balance;
                        }
                        else if($coa->normal_balance=="Credit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';  
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa->coa_balance,2).'</td>'; 
                            $beginningbalance_total+=$coa->coa_balance;
                        } 
                        
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($debit!=""? number_format($debit,2) : '').'</td>';  
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.($credit!=""? number_format($credit,2): '').'</td>';
                        if($coa->normal_balance=="Debit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)+$coa->coa_balance,2).'</td>'; 
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                            $totaltotalssasdasd_d+=($debit_validated-$credit_validated)+$coa->coa_balance; 
                        }
                        else if($coa->normal_balance=="Credit"){
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>'; 
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(($debit_validated-$credit_validated)-$coa->coa_balance,2).'</td>'; 
                            $totaltotalssasdasd+=($debit_validated-$credit_validated)-$coa->coa_balance; 
                        }   
                        
                        
                        
                        $tablecontent.='</tr>'; 
                }
                $coa_name_totaldebit+=$coa_name_totald;
                $coa_name_totalcredit+=$coa_name_totalc;
            }
            if($retaunbedearnings==0){
                $RetainedEarningsSubs=0;
                $data=Advance::first();
                if(!empty($data)){
                    $RetainedEarningsSubs+=$data->advance_beginning_balance;
                }
                $tablecontent.='<tr>';  
                $tablecontent.='<td style="vertical-align:middle;"></td>';
                $tablecontent.='<td style="vertical-align:middle;">Retained Earnings</td>';
                $tablecontent.='<td style="vertical-align:middle;"></td>';
                $tablecontent.='<td style="vertical-align:middle;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($RetainedEarningsSubs,2).'</td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;"></td>';
                $tablecontent.='<td style="vertical-align:middle;text-align:right;font-weight:bold;">'.number_format(-$RetainedEarningsSubs,2).'</td>';
                $tablecontent.='</tr>'; 
            } 
            $tablecontent.='<tr style="background-color: #eaf0f7;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:bold;">';  
            $tablecontent.='<td colspan="3" style="vertical-align:middle;">Total</td>';  
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total_d,2).'</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($beginningbalance_total,2).'</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totaldebit,2).'</td>'; 
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($coa_name_totalcredit,2).'</td>';
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd_d,2).'</td>';  
            $tablecontent.='<td style="vertical-align:middle;text-align:right;">'.number_format($totaltotalssasdasd,2).'</td>'; 
            $tablecontent.='</tr>';  
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th style="vertical-align:middle;" rowspan="2">Account Code</th><th style="vertical-align:middle;" rowspan="2">Account Title</th><th style="vertical-align:middle;" rowspan="2">Account Account Type</th><th style="text-align:center;" colspan="2">Beginning Balance</th><th  colspan="2" style="text-align:center;">Current</th><th  colspan="2" style="text-align:center;">Total</th>'
                .'</tr>'
                .'<tr>'
                .'<th>Debit</th><th>Credit</th><th>Debit</th><th>Credit</th><th>Debit</th><th>Credit</th>'
                .'</tr>'
                .'</thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;


    }
    public function Customer_Balance_Summary(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.customerbalancesummary', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function ProductandServices_List(Request $request){
        $sortsetting="";
        if($request->sort){
            $sortsetting=$request->sort;
        }else{
            
        }
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.productlist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Collection_Report(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.collectionreport', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Supplier_Contact_List(Request $request){
        $sortsetting="";
        if($request->sort){
            $sortsetting=$request->sort;
        }else{
            
        }
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
         $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.suppliercontact', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Invoice_List_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($SalesTransaction as $emp){
                    if($emp->st_type=="Invoice" && $emp->remark!="Cancelled"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_type;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_no;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($emp->display_name!=""){
                        $tablecontent.=$emp->display_name;
                        }else{
                        $tablecontent.=$emp->f_name." ".$emp->l_name;
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_memo;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($emp->st_due_date!=""){
                            $date1=date_create(date('Y-m-d'));
                            $date2=date_create($emp->st_due_date);
                            $diff=date_diff($date1,$date2);
                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                $tablecontent.='<span title="overdue" style="color:red;">'; 
                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                $tablecontent.='</span>'; 
                            }else{
                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                            }
                        }
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $total=0;
                        foreach($st_invoice as $st_i){
                            if($st_i->st_i_no==$emp->st_no){
                                $total=$total+$st_i->st_i_total;
                            }
                        }
                        $tablecontent.=number_format($total,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($emp->st_balance,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_bill_address;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_bill_address;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_term;
                        $tablecontent.='</td>';
        
        
        
        
                    }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Sales Receipt' OR je_transaction_type='Credit Note')";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Sales Receipt' OR je_transaction_type='Credit Note')";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Sales Receipt' OR je_transaction_type='Credit Note')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        
                        $tablecontent.=$ccl->cc_name;
                        
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                    }
                    $go=0;
                    foreach($SalesTransaction as $emp){
                        foreach($JournalEntry as $JJJJ){
                            if($JJJJ->je_cost_center==$ccl->cc_no){
                                if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $go=1;
                                }
                                
                            }
                            
                        }
                        if($emp->st_type=="Invoice" && $emp->remark!="Cancelled" && $go==1){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->display_name!=""){
                            $tablecontent.=$emp->display_name;
                            }else{
                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_memo;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->st_due_date!=""){
                                $date1=date_create(date('Y-m-d'));
                                $date2=date_create($emp->st_due_date);
                                $diff=date_diff($date1,$date2);
                                if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                    $tablecontent.='<span title="overdue" style="color:red;">'; 
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                    $tablecontent.='</span>'; 
                                }else{
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                }
                            }
                            
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $total=0;
                            foreach($st_invoice as $st_i){
                                if($st_i->st_i_no==$emp->st_no){
                                    $total=$total+$st_i->st_i_total;
                                }
                            }
                            $tablecontent.=number_format($total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($emp->st_balance,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_term;
                            $tablecontent.='</td>';
            
            
            
            
                        }
                    }
                    
                    
                }
            }
            
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="11" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            
            $go=0;
            foreach($SalesTransaction as $emp){
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
						$go=1;
						}
						
					}
					
                }
                if($emp->st_type=="Invoice" && $emp->remark!="Cancelled" && $go==1){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_type;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_no;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($emp->display_name!=""){
                    $tablecontent.=$emp->display_name;
                    }else{
                    $tablecontent.=$emp->f_name." ".$emp->l_name;
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_memo;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($emp->st_due_date!=""){
                        $date1=date_create(date('Y-m-d'));
                        $date2=date_create($emp->st_due_date);
                        $diff=date_diff($date1,$date2);
                        if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                            $tablecontent.='<span title="overdue" style="color:red;">'; 
                            $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                            $tablecontent.='</span>'; 
                        }else{
                            $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                        }
                    }
                    
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $total=0;
                    foreach($st_invoice as $st_i){
                        if($st_i->st_i_no==$emp->st_no){
                            $total=$total+$st_i->st_i_total;
                        }
                    }
                    $tablecontent.=number_format($total,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($emp->st_balance,2);
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_bill_address;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_bill_address;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_term;
                    $tablecontent.='</td>';
    
    
    
    
                }
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Memo</th><th>Due Date</th><th>Amount</th><th>Open Balance</th><th>Billing Address</th><th>Shipping Address</th><th>Terms</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function collectionreport_bydate(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $cost_center_list=CostCenter::all();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($STCustomer as $STC){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                    foreach($SalesTransaction as $emp){
                        if($emp->customer_id==$STC->st_customer_id){
                            if($emp->st_status=="Paid"){
                            $tablecontent.=$emp->display_name;
                            break;
                        }
                        }
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    foreach($SalesTransaction as $emp){
                        if($emp->customer_id==$STC->st_customer_id){
                        if($emp->remark!="Cancelled"){
                            if($emp->st_type=="Invoice" &&($emp->st_status=="Paid" )){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_type;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_no;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($emp->display_name!=""){
                                $tablecontent.=$emp->display_name;
                                }else{
                                $tablecontent.=$emp->f_name." ".$emp->l_name;
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_memo;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($emp->st_due_date!=""){
                                    $date1=date_create(date('Y-m-d'));
                                    $date2=date_create($emp->st_due_date);
                                    $diff=date_diff($date1,$date2);
                                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                        $tablecontent.='<span title="overdue" style="color:red;">'; 
                                        $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                        $tablecontent.='</span>'; 
                                    }else{
                                        $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                    }
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $total=0;
                                foreach($st_invoice as $st_i){
                                    if($st_i->st_i_no==$emp->st_no){
                                        $total=$total+$st_i->st_i_total;
                                    }
                                }
                                $tablecontent.=number_format($total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_status;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_bill_address;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_bill_address;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_term;
                                $tablecontent.='</td>';
                
                                
                            }
                        }
                        
            
                        }
                    }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach($STCustomer as $STC){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                            
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->customer_id==$STC->st_customer_id && $go==1){
                                    if($emp->st_status=="Paid"){
                                    $tablecontent.=$emp->display_name;
                                    break;
                                }
                                }
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                            
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->customer_id==$STC->st_customer_id){
                                if($emp->remark!="Cancelled" && $go==1){
                                    if($emp->st_type=="Invoice" &&($emp->st_status=="Paid")){
                                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_type;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_no;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        if($emp->display_name!=""){
                                        $tablecontent.=$emp->display_name;
                                        }else{
                                        $tablecontent.=$emp->f_name." ".$emp->l_name;
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_memo;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        if($emp->st_due_date!=""){
                                            $date1=date_create(date('Y-m-d'));
                                            $date2=date_create($emp->st_due_date);
                                            $diff=date_diff($date1,$date2);
                                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                                $tablecontent.='<span title="overdue" style="color:red;">'; 
                                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                                $tablecontent.='</span>'; 
                                            }else{
                                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                            }
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $total=0;
                                        foreach($st_invoice as $st_i){
                                            if($st_i->st_i_no==$emp->st_no){
                                                $total=$total+$st_i->st_i_total;
                                            }
                                        }
                                        $tablecontent.=number_format($total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_status;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_bill_address;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_bill_address;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_term;
                                        $tablecontent.='</td>';
                        
                                        
                                    }
                                }
                                
                    
                                }
                            }
                        }
                    }
                    
                    
                }
            }

        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach($STCustomer as $STC){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                            $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->customer_id==$STC->st_customer_id && $go==1){
                        if($emp->st_status=="Paid" ){
                        $tablecontent.=$emp->display_name;
                        break;
                    }
                    }
                }
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                            $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->customer_id==$STC->st_customer_id){
                    if($emp->remark!="Cancelled" && $go==1){
                        if($emp->st_type=="Invoice" &&($emp->st_status=="Paid")){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->display_name!=""){
                            $tablecontent.=$emp->display_name;
                            }else{
                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_memo;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->st_due_date!=""){
                                $date1=date_create(date('Y-m-d'));
                                $date2=date_create($emp->st_due_date);
                                $diff=date_diff($date1,$date2);
                                if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                    $tablecontent.='<span title="overdue" style="color:red;">'; 
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                    $tablecontent.='</span>'; 
                                }else{
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                }
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $total=0;
                            foreach($st_invoice as $st_i){
                                if($st_i->st_i_no==$emp->st_no){
                                    $total=$total+$st_i->st_i_total;
                                }
                            }
                            $tablecontent.=number_format($total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_status;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_term;
                            $tablecontent.='</td>';
            
                            
                        }
                    }
                    
        
                    }
                }
            }
        }
        
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Memo</th><th>Due Date</th><th>Amount</th><th>Status</th><th>Billing Address</th><th>Shipping Address</th><th>Terms</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function Journal_by_date(Request $request){
        $CostCenterArray=$request->CostCenterFilter;
        $CostCenterFilter="By Cost Center";
        if(!empty($CostCenterArray)){
            foreach($CostCenterArray as $CC){
                if($CC=="All"){
                    $CostCenterFilter="All";
                    break;
                }
            }
            
        }else{
            $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction type</th><th>No.</th><th>Name</th><th>Memo</th><th>Account</th><th>Remark</th><th style="text-align:right;">Debit</th><th style="text-align:right;">Credit</th>'
                .'</tr></thead>'
                .'<tbody></tbody>'
                .'</table>';
            return $table;
        }
        $query_condition="";
        if($CostCenterFilter=="By Cost Center"){
            $count=1;
            foreach($CostCenterArray as $CC){
                if($count==1){
                    $query_condition.="je_cost_center='$CC'";
                }else{
                    $query_condition.=" OR je_cost_center='$CC'";
                }
                $count++;
            }
        }

        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            if($query_condition==""){
                $sortjournal="WHERE (remark!='NULLED' OR remark IS NULL)";
            }else{
                $sortjournal="WHERE ($query_condition) AND (remark!='NULLED' OR remark IS NULL)";
            }
            
        }else{
            if($query_condition==""){
                $sortjournal=" WHERE (remark!='NULLED' OR remark IS NULL)";
            }else{
                $sortjournal=" WHERE ($query_condition)  AND (remark!='NULLED' OR remark IS NULL)";
            }
           
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($query_condition==""){
                $sortjournal="WHERE (remark!='NULLED' OR remark IS NULL)";
            }else{
                $sortjournal="WHERE ($query_condition) AND (remark!='NULLED' OR remark IS NULL)";  
            }
            
            $sortsettingjournal="AND created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        
        // $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->whereBetween('created_at', [$FROM, $TO])
        //                     ->orderBy('created_at','ASC')->get();
        // 
        // $je_grouped= DB::table('journal_entries')
        //         ->whereBetween('journal_entries.created_at', [$FROM, $TO])
        //         ->join('cost_center', 'journal_entries.je_cost_center', '=', 'cost_center.cc_no')
        //         ->select('*')
        //         ->groupBy('je_cost_center')
        //         ->get();
        if($FROM==""){
            if($query_condition==""){
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                GROUP BY je_cost_center"); 
            }else{
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                WHERE ($query_condition)
                GROUP BY je_cost_center");
            }
            
        }else{
            if($query_condition==""){
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                WHERE journal_entries.created_at BETWEEN '$FROM' AND '$TO' GROUP BY je_cost_center");
                
            }else{
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                WHERE ($query_condition) AND journal_entries.created_at BETWEEN '$FROM' AND '$TO' GROUP BY je_cost_center");
               
            }
            
        }
        
        if($filtertemplate=="All"){
            // $je_grouped= DB::table('journal_entries')
            // ->join('cost_center', 'journal_entries.je_cost_center', '=', 'cost_center.cc_no')
            // ->select('*')
            // ->groupBy('je_cost_center')
            // ->get();
            if($query_condition==""){
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                GROUP BY je_cost_center");
            }else{
                $je_grouped= DB::connection('mysql')->select("SELECT * FROM journal_entries JOIN cost_center ON journal_entries.je_cost_center=cost_center.cc_no
                WHERE ($query_condition)
                GROUP BY je_cost_center");
            }
            
        }                  
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal.$sortsettingjournal." 
                            ORDER BY created_at ASC");
        
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $tablecontent="";
        $tablecontent.="<script>";
        
        $tablecontent.="var totaldebit=0;";
        $tablecontent.="var totalcredit=0;";
        $tablecontent.="$(document).ready(function(){";
        $tablecontent.="document.getElementById('TotalDebit').innerHTML=(totaldebit).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
        $tablecontent.="document.getElementById('TotalCredit').innerHTML=(totalcredit).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
        $tablecontent.="});";
        $tablecontent.="</script>";
        $currentno="";

        if($CostCenterFilter=="By Cost Center"){
            foreach($je_grouped as $group){
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;font-weight:bold;' colspan='1'>";
                $tablecontent.=$group->cc_name_code;
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;font-weight:bold;' colspan='8'>";
                $tablecontent.=$group->cc_name;
                $tablecontent.="</td>";
                
                $tablecontent.="</tr>";
                foreach($JournalEntry as $JE){
                    if($JE->je_cost_center==$group->cc_no){
                        $PaymentFor="";
                        $Invoice_Location="";
                        $Invoice_Type="";
                        foreach ($SalesTransaction as $sales){
                            if($sales->st_no==$JE->other_no){
                                $PaymentFor=$sales->st_payment_for;
                                $Invoice_Location=$sales->st_location;
                                $Invoice_Type=$sales->st_invoice_type;
                            }
            
                        }
                        
                        $tablecontent.="<tr>";
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($JE->remark==""){  
                        //<a style="cursor:pointer;" onclick="getModal('{{$JE->other_no}}','{{$JE->je_transaction_type}}','{{$PaymentFor}}')">
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$currentno!=$JE->je_no? date('m-d-Y',strtotime($JE->created_at)) : "";
                        $tablecontent.="</a>";
                        }else{
                            $tablecontent.=$currentno!=$JE->je_no? date('m-d-Y',strtotime($JE->created_at)) : ""; 
                        }
                        $tablecontent.="</td>";
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($JE->remark==""){  
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$currentno!=$JE->je_no? $JE->je_transaction_type : "";
                        $tablecontent.="</a>";
                        }else{
                            $tablecontent.=$currentno!=$JE->je_no? $JE->je_transaction_type : ""; 
                        }
                        $tablecontent.="</td>"; 
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($JE->je_transaction_type=="Journal Entry"){
                            if($JE->remark==""){   
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->je_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=$currentno!=$JE->je_no? $JE->je_no : "";
                            $tablecontent.="</a>";
                            }else{
                                $tablecontent.=$currentno!=$JE->je_no? $JE->je_no : "";  
                            }
                        }else{
                            if($JE->remark==""){   
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                            $tablecontent.=$currentno!=$JE->je_no? $JE->other_no : "";
                            $tablecontent.="</a>";
                            }else{
                                $tablecontent.=$currentno!=$JE->je_no? $JE->other_no : "";  
                            }
                        }
                        
                        $tablecontent.="</td>"; 
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($JE->remark==""){   
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$currentno!=$JE->je_no? $JE->je_name : "";
                        $tablecontent.="</a>";
                        }else{
                            $tablecontent.=$currentno!=$JE->je_no? $JE->je_name : ""; 
                        }
                        $tablecontent.="</td>";  
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        
                        if($JE->remark==""){   
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        $tablecontent.=$JE->je_memo;
                        $tablecontent.="</a>";
                        }else{
                            $tablecontent.=$JE->je_memo;  
                        }
                        $tablecontent.="</td>";
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        if($JE->remark==""){   
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                        foreach ($COA as $csa){
                            if($csa->id==$JE->je_account){
                                $tablecontent.=$csa->coa_name;
                            }
                        }
                        }else{
                            foreach ($COA as $csa){
                                if($csa->id==$JE->je_account){
                                    $tablecontent.=$csa->coa_name;
                                }
                            } 
                        }
                        
                        $tablecontent.="</a>";
                        $tablecontent.="</td>";
                        $tablecontent.="<td style='vertical-align:middle;'>";
                        
                        if($JE->remark!=""){
                            $tablecontent.=$JE->remark;
                        }
                        
                       
                        $tablecontent.="</td>";
                        $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                        if($JE->je_debit!=""){
                        if($JE->remark==""){   
                        $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\')">'; 
                        $tablecontent.=number_format($JE->je_debit,2);
                        $tablecontent.="</a>";
                        $tablecontent.="<script>";
                        $tablecontent.="totaldebit+=".$JE->je_debit.";";
                        $tablecontent.="</script>";
                        }else{
                            $tablecontent.=number_format($JE->je_debit,2);
                        }
                        }
                        
                        $tablecontent.="</td>";
                        $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                        if($JE->je_credit!=""){
                        if($JE->remark==""){
                            $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\')">';   
                            $tablecontent.=number_format($JE->je_credit,2);
                            $tablecontent.="</a>";
                            $tablecontent.="<script>";
                            $tablecontent.="totalcredit+=".$JE->je_credit.";";
                            $tablecontent.="</script>";
                        }else{
                            $tablecontent.=number_format($JE->je_credit,2); 
                        }
                        
                        }
                        
                        $tablecontent.="</td>";
                        $tablecontent.="</tr>";    
                        if($currentno!=$JE->je_no){
                            $currentno=$JE->je_no;
                        }
                    }
               
            }
            }
            
        }else{
            foreach($JournalEntry as $JE){
                $PaymentFor="";
                $Invoice_Location="";
                $Invoice_Type="";
                foreach ($SalesTransaction as $sales){
                    if($sales->st_no==$JE->other_no){
                        $PaymentFor=$sales->st_payment_for;
                        $Invoice_Location=$sales->st_location;
                        $Invoice_Type=$sales->st_invoice_type;
                    }
    
                }
                $tablecontent.="<tr>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($JE->remark==""){  
                //<a style="cursor:pointer;" onclick="getModal('{{$JE->other_no}}','{{$JE->je_transaction_type}}','{{$PaymentFor}}')">
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                $tablecontent.=$currentno!=$JE->je_no? date('m-d-Y',strtotime($JE->created_at)) : "";
                $tablecontent.="</a>";
                
                }else{
                    $tablecontent.=$currentno!=$JE->je_no? date('m-d-Y',strtotime($JE->created_at)) : ""; 
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($JE->remark==""){  
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                $tablecontent.=$currentno!=$JE->je_no? $JE->je_transaction_type : "";
                $tablecontent.="</a>";
                }else{
                    $tablecontent.=$currentno!=$JE->je_no? $JE->je_transaction_type : ""; 
                }
                $tablecontent.="</td>"; 
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($JE->je_transaction_type=="Journal Entry"){
                    if($JE->remark==""){   
                    $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                    $tablecontent.=$currentno!=$JE->je_no? $JE->je_no : "";
                    $tablecontent.="</a>";
                    }else{
                        $tablecontent.=$currentno!=$JE->je_no? $JE->je_no : "";  
                    }
                }else{
                    if($JE->remark==""){   
                    $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                    $tablecontent.=$currentno!=$JE->je_no? $JE->other_no : "";
                    $tablecontent.="</a>";
                    }else{
                        $tablecontent.=$currentno!=$JE->je_no? $JE->other_no : "";  
                    }
                }
                
                $tablecontent.="</td>"; 
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($JE->remark==""){   
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                $tablecontent.=$currentno!=$JE->je_no? $JE->je_name : "";
                $tablecontent.="</a>";
                }else{
                    $tablecontent.=$currentno!=$JE->je_no? $JE->je_name : ""; 
                }
                $tablecontent.="</td>";  
                $tablecontent.="<td style='vertical-align:middle;'>";
                
                if($JE->remark==""){   
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                $tablecontent.=$JE->je_memo;
                $tablecontent.="</a>";
                }else{
                    $tablecontent.=$JE->je_memo;  
                }
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                if($JE->remark==""){   
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\',\''.$PaymentFor.'\')">';
                foreach ($COA as $csa){
                    if($csa->id==$JE->je_account){
                        $tablecontent.=$csa->coa_name;
                    }
                }
                }else{
                    foreach ($COA as $csa){
                        if($csa->id==$JE->je_account){
                            $tablecontent.=$csa->coa_name;
                        }
                    } 
                }
                
                $tablecontent.="</a>";
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;'>";
                
                if($JE->remark!=""){
                    $tablecontent.=$JE->remark;
                }
                
               
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                if($JE->je_debit!=""){
                if($JE->remark==""){   
                $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\')">'; 
                $tablecontent.=number_format($JE->je_debit,2);
                $tablecontent.="</a>";
                $tablecontent.="<script>";
                $tablecontent.="totaldebit+=".$JE->je_debit.";";
                $tablecontent.="</script>";
                }else{
                    $tablecontent.=number_format($JE->je_debit,2);
                }
                }
                
                $tablecontent.="</td>";
                $tablecontent.="<td style='vertical-align:middle;text-align:right;'>";
                if($JE->je_credit!=""){
                if($JE->remark==""){
                    $tablecontent.='<a style="cursor:pointer;" onclick="getModal(\''.$Invoice_Location.'\',\''.$Invoice_Type.'\',\''.$JE->other_no.'\',\''.$JE->je_transaction_type.'\')">';   
                    $tablecontent.=number_format($JE->je_credit,2);
                    $tablecontent.="</a>";
                    $tablecontent.="<script>";
                    $tablecontent.="totalcredit+=".$JE->je_credit.";";
                    $tablecontent.="</script>";
                }else{
                    $tablecontent.=number_format($JE->je_credit,2); 
                }
                
                }
                
                $tablecontent.="</td>";
                $tablecontent.="</tr>";    
                if($currentno!=$JE->je_no){
                    $currentno=$JE->je_no;
                }
            }
        }
        

        
        $tablecontent.="<tr>";
        $tablecontent.='<td colspan="9" style="vertical-align:middle;text-align:center;font-size:11px;" ></td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;text-align:center;font-size:11px;" ></td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;text-align:center;font-size:11px;" ></td>';
        $tablecontent.="</tr>";
        $tablecontent.="<tr>";
        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;" >Total</td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;font-weight:bold;text-align:right;" id="TotalDebit"></td>';
        $tablecontent.='<td colspan="1" style="vertical-align:middle;font-weight:bold;text-align:right;" id="TotalCredit"></td>';
        $tablecontent.="</tr>";

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction type</th><th>No.</th><th>Name</th><th>Memo</th><th>Account</th><th>Remark</th><th style="text-align:right;">Debit</th><th style="text-align:right;">Credit</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function salesbyProduct_Summary_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingi="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingi="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsettingi="";
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice ".$sortsettingi);
        $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $STProduct= DB::table('st_invoice')
                        ->whereBetween('created_at', [$FROM, $TO])
                        ->select('st_i_product')
                        ->groupBy('st_i_product')
                        ->get();
        $SCredit= DB::table('st_credit_notes')
                        ->whereBetween('created_at', [$FROM, $TO])
                        ->select('st_cn_product')
                        ->groupBy('st_cn_product')
                        ->get();
        $cost_center_list=CostCenter::all();
        if($filtertemplate=="All"){
            $STProduct= DB::table('st_invoice')
                        ->select('st_i_product')
                        ->groupBy('st_i_product')
                        ->get();
            $SCredit= DB::table('st_credit_notes')
                        ->select('st_cn_product')
                        ->groupBy('st_cn_product')
                        ->get();
        }
        $combinedarray=array();
        foreach($SCredit as $ST){
            
                    $combinedarray[]=$ST->st_cn_product;
            
        }
        foreach($STProduct as $ST){
            
                    $combinedarray[]=$ST->st_i_product;
            
        }
        $nodup=array_unique($combinedarray);
        $STARRAY=array();
        $emptyArray = array();
        foreach($st_invoice as $as){
            
                    $STARRAY['st_i_no']  = $as->st_i_no ;
                    $STARRAY['st_i_rate']  = $as->st_i_rate ;
                    $STARRAY['st_i_product']  = $as->st_i_product ;
                    array_push($emptyArray, $STARRAY);
            
        }
        foreach($st_credit_notes as $as){
                    $STARRAY['st_i_no']  = $as->st_cn_no ;
                    $STARRAY['st_i_rate']  = "-".$as->st_cn_rate ;
                    $STARRAY['st_i_product']  = $as->st_cn_product ;
                    array_push($emptyArray, $STARRAY);
            
        }
        //$input=$emptyArray;
        $input = array_map("unserialize", array_unique(array_map("serialize", $emptyArray)));
        //return $input;
        $tablecontent='';
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $tablecontent.="<script>var totalall=0;var idcount=[];</script>";
        
                foreach($nodup as $st_i){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle">';
                    foreach($products_and_services as $ps){
                        if($ps->product_id==$st_i){
                            $tablecontent.=$ps->product_name;
                        }
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="QTY'.$st_i.'">';
                    $tablecontent.='<script>';
                    $tablecontent.='$(document).ready(function(){';
                    $tablecontent.='var qty=0;';
                    $tablecontent.='var amount="";';
                    $tablecontent.='var AVG="";';
                    $tablecontent.='idcount.push("'.$st_i.'");';
                    $tablecontent.='var percenteage=0;';
                    foreach($input as $STI){
                        $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                        $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                        if($STI["st_i_product"]==$st_i){
                            $tablecontent.='qty++;';
                            $tablecontent.='amount=amount*qty;';
                            $tablecontent.='AVG=AVG*1;';
                            $tablecontent.='totalall=totalall+amount;';
                            $tablecontent.="document.getElementById('AVG".$st_i."').innerHTML=(AVG).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tablecontent.="document.getElementById('Amount".$st_i."').innerHTML=(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tablecontent.="document.getElementById('QTY".$st_i."').innerHTML=qty;";
                            
                            
                        }
                    }
                    $tablecontent.='});';
                    $tablecontent.='</script>';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Amount'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Percent'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="AVG'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    
                }
                $tablecontent.='<script>';
                $tablecontent.='$(document).ready(function(){';
                $tablecontent.='var idex=0;';    
                foreach($nodup as $st_i){
                $tablecontent.='var qty=0;';
                $tablecontent.='var amount="";';
                $tablecontent.='var AVG="";';
                foreach($input as $STI){
                    $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                    $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                    if($STI["st_i_product"]==$st_i){
                        $tablecontent.='qty++;';
                        
                        $tablecontent.='amount=amount*qty;';
                        $tablecontent.='AVG=AVG*1;';
                        $tablecontent.='percenteage=(amount*100)/totalall;';
                        

                        $tablecontent.="document.getElementById('Percent'+idcount[idex]).innerHTML=(percenteage).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')+' %';";
                        $tablecontent.='idex++;';
                    }
                }
                }
                $tablecontent.='});';
                $tablecontent.='</script>';
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    }else{
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
            
                        $tablecontent.="<script>var totalall=0;var idcount=[];</script>";
                        foreach($nodup as $st_i){
                            $enableproduct=0;
                            foreach($input as $STI){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                            $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($STI["st_i_product"]==$st_i && $go==1){
                                    $enableproduct=1;
                                }
                            }
                            if($enableproduct==1){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td style="vertical-align:middle">';
                                foreach($products_and_services as $ps){
                                    if($ps->product_id==$st_i){
                                        $tablecontent.=$ps->product_name;
                                    }
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle" id="QTY'.$st_i.'">';
                                $tablecontent.='<script>';
                                $tablecontent.='$(document).ready(function(){';
                                $tablecontent.='var qty=0;';
                                $tablecontent.='var amount="";';
                                $tablecontent.='var AVG="";';
                                $tablecontent.='idcount.push("'.$st_i.'");';
                                $tablecontent.='var percenteage=0;';
                                $go=0;
                                foreach($input as $STI){
                                    foreach($JournalEntry as $JJJJ){
                                        if($JJJJ->je_cost_center==$ccl->cc_no){
                                            if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                                $go=1;
                                            }
                                            
                                        }
                                        
                                    }
                                    $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                                    $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                                    if($STI["st_i_product"]==$st_i && $go==1){
                                        $tablecontent.='qty++;';
                                        $tablecontent.='amount=amount*qty;';
                                        $tablecontent.='AVG=AVG*1;';
                                        $tablecontent.='totalall=totalall+amount;';
                                        $tablecontent.="document.getElementById('AVG".$st_i."').innerHTML=(AVG).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                        $tablecontent.="document.getElementById('Amount".$st_i."').innerHTML=(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                        $tablecontent.="document.getElementById('QTY".$st_i."').innerHTML=qty;";
                                        
                                        
                                    }
                                }
                                $tablecontent.='});';
                                $tablecontent.='</script>';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Amount'.$st_i.'">';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Percent'.$st_i.'">';
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="text-align:right;vertical-align:middle" id="AVG'.$st_i.'">';
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                            }
                            
                            
                            }
                            $tablecontent.='<script>';
                            $tablecontent.='$(document).ready(function(){';
                            $tablecontent.='var idex=0;';    
                            foreach($nodup as $st_i){
                                $tablecontent.='var qty=0;';
                                $tablecontent.='var amount="";';
                                $tablecontent.='var AVG="";';
                            
                                foreach($input as $STI){
                                    $go=0;
                                    foreach($JournalEntry as $JJJJ){
                                        if($JJJJ->je_cost_center==$ccl->cc_no){
                                            if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                                $go=1;
                                            }
                                            
                                        }
                                        
                                    }
                                    $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                                    $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                                    if($STI["st_i_product"]==$st_i && $go==1){
                                        $tablecontent.='qty++;';
                                        
                                        $tablecontent.='amount=amount*qty;';
                                        $tablecontent.='AVG=AVG*1;';
                                        $tablecontent.='percenteage=(amount*100)/totalall;';
                                        
            
                                        $tablecontent.="document.getElementById('Percent'+idcount[idex]).innerHTML=(percenteage).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')+' %';";
                                        $tablecontent.='idex++;';
                                    }
                                }
                            }
                            $tablecontent.='});';
                            $tablecontent.='</script>';
		
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="5" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";

            $tablecontent.="<script>var totalall=0;var idcount=[];</script>";
            foreach($nodup as $st_i){
                $enableproduct=0;
                foreach($input as $STI){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $go=1;
                            }
                            
                        }
                        
                    }
                    if($STI["st_i_product"]==$st_i && $go==1){
                        $enableproduct=1;
                    }
                }
                if($enableproduct==1){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle">';
                    foreach($products_and_services as $ps){
                        if($ps->product_id==$st_i){
                            $tablecontent.=$ps->product_name;
                        }
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="QTY'.$st_i.'">';
                    $tablecontent.='<script>';
                    $tablecontent.='$(document).ready(function(){';
                    $tablecontent.='var qty=0;';
                    $tablecontent.='var amount="";';
                    $tablecontent.='var AVG="";';
                    $tablecontent.='idcount.push("'.$st_i.'");';
                    $tablecontent.='var percenteage=0;';
                    $go=0;
                    foreach($input as $STI){
                        foreach($JournalEntry as $JJJJ){
                            if($JJJJ->je_cost_center==$CostCenterFilter){
                                if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                    $go=1;
                                }
                                
                            }
                            
                        }
                        $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                        $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                        if($STI["st_i_product"]==$st_i && $go==1){
                            $tablecontent.='qty++;';
                            $tablecontent.='amount=amount*qty;';
                            $tablecontent.='AVG=AVG*1;';
                            $tablecontent.='totalall=totalall+amount;';
                            $tablecontent.="document.getElementById('AVG".$st_i."').innerHTML=(AVG).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tablecontent.="document.getElementById('Amount".$st_i."').innerHTML=(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tablecontent.="document.getElementById('QTY".$st_i."').innerHTML=qty;";
                            
                            
                        }
                    }
                    $tablecontent.='});';
                    $tablecontent.='</script>';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Amount'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="Percent'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="text-align:right;vertical-align:middle" id="AVG'.$st_i.'">';
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                }
                
                
                }
                $tablecontent.='<script>';
                $tablecontent.='$(document).ready(function(){';
                $tablecontent.='var idex=0;';    
                foreach($nodup as $st_i){
                    $tablecontent.='var qty=0;';
                    $tablecontent.='var amount="";';
                    $tablecontent.='var AVG="";';
                
                    foreach($input as $STI){
                        $go=0;
                        foreach($JournalEntry as $JJJJ){
                            if($JJJJ->je_cost_center==$CostCenterFilter){
                                if($JJJJ->other_no==$STI['st_i_no'] && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                    $go=1;
                                }
                                
                            }
                            
                        }
                        $tablecontent.='AVG="'.$STI["st_i_rate"].'";';
                        $tablecontent.='amount="'.$STI["st_i_rate"].'";';
                        if($STI["st_i_product"]==$st_i && $go==1){
                            $tablecontent.='qty++;';
                            
                            $tablecontent.='amount=amount*qty;';
                            $tablecontent.='AVG=AVG*1;';
                            $tablecontent.='percenteage=(amount*100)/totalall;';
                            

                            $tablecontent.="document.getElementById('Percent'+idcount[idex]).innerHTML=(percenteage).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')+' %';";
                            $tablecontent.='idex++;';
                        }
                    }
                }
                $tablecontent.='});';
                $tablecontent.='</script>';
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th ></th><th style="text-align:right;">Quantity</th><th style="text-align:right;">Amount</th><th  style="text-align:right;">% of Sales</th><th style="text-align:right;">AVG. Price</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function salesbyCustomer_Summary_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $cost_center_list=CostCenter::all();
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($STCustomer as $STC){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                   
                    $ssss="";
                    foreach($SalesTransaction as $emp){
                        if($emp->customer_id==$STC->st_customer_id){
                            $tablecontent.=' <td style="vertical-align:middle;" >';
                            if($emp->display_name!=""){
                                $tablecontent.=$emp->display_name;
                            }else{
                                $tablecontent.=$emp->f_name." ".$emp->l_name;
                            }
                            $tablecontent.='</td>';
                            $ssss=$emp->st_no;
                            break;
                        }
                    }
                    
                    if($ssss!=""){
        
                    
                    $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                    $tablecontent.='<script>';
                    $tablecontent.='var total=0;';
                    $tablecontent.='var id="total_balancetd'.$ssss.'";';
                    $toollas=0;
                    foreach($SalesTransaction as $emp){
                        if($emp->remark!="Cancelled"){
                            if($emp->customer_id==$STC->st_customer_id){
                                if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                                    //$tablecontent.="total=total+".$emp->st_balance.";";
                                    $toollas+=$emp->st_balance;
                                }
                                if($emp->st_type=="Credit Note"){
                                    //$tablecontent.="total=total+".$emp->st_amount_paid.";";
                                    $toollas+=$emp->st_amount_paid;
                                }
            
                            }
                        }
                        
        
                    }
                    
                    $tablecontent.='</script>';
                    $tablecontent.=number_format($toollas,2);
                    $tablecontent.='</td>';
                    }
                    $tablecontent.='</tr>';
        
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    }else{
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortsettingjournal.$sortjournal." 
                    ORDER BY created_at ASC");    
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                            $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach($STCustomer as $STC){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        
                            $ssss="";
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                            $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->customer_id==$STC->st_customer_id && $go==1){
                                    $tablecontent.=' <td style="vertical-align:middle;" >';
                                    if($emp->display_name!=""){
                                        $tablecontent.=$emp->display_name;
                                    }else{
                                        $tablecontent.=$emp->f_name." ".$emp->l_name;
                                    }
                                    $tablecontent.='</td>';
                                    $ssss=$emp->st_no;
                                    break;
                                }
                            }
                            
                            if($ssss!=""){
                
                            
                            $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                            $tablecontent.='<script>';
                            $tablecontent.='var total=0;';
                            $tablecontent.='var id="total_balancetd'.$ssss.'";';
                            $toollas=0;
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                            $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->remark!="Cancelled" && $go==1){
                                    if($emp->customer_id==$STC->st_customer_id){
                                        if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                                            //$tablecontent.="total=total+".$emp->st_balance.";";
                                            $toollas+=$emp->st_balance;
                                        }
                                        if($emp->st_type=="Credit Note"){
                                            //$tablecontent.="total=total+".$emp->st_amount_paid.";";
                                            $toollas+=$emp->st_amount_paid;
                                        }
                    
                                    }
                                }
                                
                
                            }
                            
                            $tablecontent.='</script>';
                            $tablecontent.=number_format($toollas,2);
                            $tablecontent.='</td>';
                            }
                            $tablecontent.='</tr>';
                
                        }
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach($STCustomer as $STC){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
               
                $ssss="";
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->customer_id==$STC->st_customer_id && $go==1){
                        $tablecontent.=' <td style="vertical-align:middle;" >';
                        if($emp->display_name!=""){
                            $tablecontent.=$emp->display_name;
                        }else{
                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                        }
                        $tablecontent.='</td>';
                        $ssss=$emp->st_no;
                        break;
                    }
                }
                
                if($ssss!=""){
    
                
                $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                $tablecontent.='<script>';
                $tablecontent.='var total=0;';
                $tablecontent.='var id="total_balancetd'.$ssss.'";';
                $toollas=0;
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->remark!="Cancelled" && $go==1){
                        if($emp->customer_id==$STC->st_customer_id){
                            if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                                //$tablecontent.="total=total+".$emp->st_balance.";";
                                $toollas+=$emp->st_balance;
                            }
                            if($emp->st_type=="Credit Note"){
                                //$tablecontent.="total=total+".$emp->st_amount_paid.";";
                                $toollas+=$emp->st_amount_paid;
                            }
        
                        }
                    }
                    
    
                }
                
                $tablecontent.='</script>';
                $tablecontent.=number_format($toollas,2);
                $tablecontent.='</td>';
                }
                $tablecontent.='</tr>';
    
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="40%"></th><th width="60%" style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function Customer_Balance_Summary_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $cost_center_list=CostCenter::all();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
           if($CostCenterFilter=="All"){
            foreach($STCustomer as $STC){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
               
                $ssss="";
                foreach($SalesTransaction as $emp){
                    if($emp->customer_id==$STC->st_customer_id){
                        if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open") ){
                        $tablecontent.=' <td style="vertical-align:middle;" >';
                        if($emp->display_name!=""){
                            $tablecontent.=$emp->display_name;
                        }else{
                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                        }
                        $tablecontent.='</td>';
                        $ssss=$emp->st_no;
                        break;
                    }
                    }
                }
                
                if($ssss!=""){
                $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                $tablecontent.='<script>';
                $tablecontent.='var total=0;';
                $tablecontent.='var id="total_balancetd'.$ssss.'";';
                $tot=0;
                foreach($SalesTransaction as $emp){
                    if($emp->customer_id==$STC->st_customer_id){
                        if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open")){
                            //$tablecontent.="total=total+".$emp->st_balance.";";
                            //$tablecontent.="document.getElementById(id).innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                            $tot+=$emp->st_balance;
                        }else if($emp->st_type=="Credit Note"){
                            $tot-=$emp->st_amount_paid;
                        }
                    }
    
                }
                $tablecontent.="document.getElementById(id).innerHTML='".number_format($tot,2)."'";
                $tablecontent.='</script>';
                
                $tablecontent.='</td>';
                }
                $tablecontent.='</tr>';
    
            }
           }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal=" je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Invoice'";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Invoice'";
                    }else{
                    $sortjournal=" je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Invoice'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                       
                        $tablecontent.=$ccl->cc_name;
                        
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
		
                    }
                    foreach($STCustomer as $STC){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                       
                        $ssss="";
                        foreach($SalesTransaction as $emp){
                            if($emp->customer_id==$STC->st_customer_id){
                                if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open") ){
                                    foreach($JournalEntry as $JJJJ){
                                        if($JJJJ->je_cost_center==$ccl->cc_no){
                                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                                $tablecontent.=' <td style="vertical-align:middle;" >';
                                                if($emp->display_name!=""){
                                                    $tablecontent.=$emp->display_name;
                                                }else{
                                                    $tablecontent.=$emp->f_name." ".$emp->l_name;
                                                }
                                                $tablecontent.='</td>';
                                                $ssss=$emp->st_no;
                                                break;
                                            }
                                            
                                        }
                                        
                                    }
                                
                            }
                            }
                        }
                        
                        if($ssss!=""){
                        $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                        $tablecontent.='<script>';
                        $tablecontent.='var total=0;';
                        $tablecontent.='var id="total_balancetd'.$ssss.'";';
                        $tot=0;
                        foreach($SalesTransaction as $emp){
                            if($emp->customer_id==$STC->st_customer_id){
                                if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open")){
                                    foreach($JournalEntry as $JJJJ){
                                        if($JJJJ->je_cost_center==$ccl->cc_no){
                                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                                $tot+=$emp->st_balance;
                                            }
                                            
                                        }
                                        
                                    }
                                    //$tablecontent.="total=total+".$emp->st_balance.";";
                                    //$tablecontent.="document.getElementById(id).innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                                   
                                }else if($emp->st_type=="Credit Note"){
                                    foreach($JournalEntry as $JJJJ){
                                        if($JJJJ->je_cost_center==$CostCenterFilter){
                                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                                $tot-=$emp->st_amount_paid;
                                            }
                                            
                                        }
                                        
                                    }
                                    
                                }
                            }
            
                        }
                        $tablecontent.="document.getElementById(id).innerHTML='".number_format($tot,2)."'";
                        $tablecontent.='</script>';
                        
                        $tablecontent.='</td>';
                        }
                        $tablecontent.='</tr>';
            
                    }

                    
                }
           }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="2" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach($STCustomer as $STC){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
               
                $ssss="";
                foreach($SalesTransaction as $emp){
                    if($emp->customer_id==$STC->st_customer_id){
                        if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open") ){
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$CostCenterFilter){
                                    if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $tablecontent.=' <td style="vertical-align:middle;" >';
                                        if($emp->display_name!=""){
                                            $tablecontent.=$emp->display_name;
                                        }else{
                                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                                        }
                                        $tablecontent.='</td>';
                                        $ssss=$emp->st_no;
                                        break;
                                    }
                                    
                                }
                                
                            }
                        
                    }
                    }
                }
                
                if($ssss!=""){
                $tablecontent.='<td style="vertical-align:middle;text-align:right;" id="total_balancetd'.$ssss.'">';
                $tablecontent.='<script>';
                $tablecontent.='var total=0;';
                $tablecontent.='var id="total_balancetd'.$ssss.'";';
                $tot=0;
                foreach($SalesTransaction as $emp){
                    if($emp->customer_id==$STC->st_customer_id){
                        if($emp->st_type=="Invoice" && ($emp->remark!="Cancelled") && ($emp->st_status=="Partially paid" || $emp->st_status=="Open")){
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$CostCenterFilter){
                                    if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $tot+=$emp->st_balance;
                                    }
                                    
                                }
                                
                            }
                            //$tablecontent.="total=total+".$emp->st_balance.";";
                            //$tablecontent.="document.getElementById(id).innerHTML=(total).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');";
                           
                        }else if($emp->st_type=="Credit Note"){
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$CostCenterFilter){
                                    if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $tot-=$emp->st_amount_paid;
                                    }
                                    
                                }
                                
                            }
                            
                        }
                    }
    
                }
                $tablecontent.="document.getElementById(id).innerHTML='".number_format($tot,2)."'";
                $tablecontent.='</script>';
                
                $tablecontent.='</td>';
                }
                $tablecontent.='</tr>';
    
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th width="40%"></th><th width="60%" style="text-align:right;">Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function Open_Invoice_List_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $cost_center_list=CostCenter::all();
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($STCustomer as $STC){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                    foreach($SalesTransaction as $emp){
                        if($emp->customer_id==$STC->st_customer_id){
                            if($emp->st_status=="Partially paid" || $emp->st_status=="Open" ){
                            $tablecontent.=$emp->display_name;
                            break;
                        }
                        }
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='</tr>';
                    foreach($SalesTransaction as $emp){
                        if($emp->customer_id==$STC->st_customer_id){
                        if($emp->remark!="Cancelled"){
                            if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_type;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_no;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($emp->display_name!=""){
                                $tablecontent.=$emp->display_name;
                                }else{
                                $tablecontent.=$emp->f_name." ".$emp->l_name;
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_memo;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($emp->st_due_date!=""){
                                    $date1=date_create(date('Y-m-d'));
                                    $date2=date_create($emp->st_due_date);
                                    $diff=date_diff($date1,$date2);
                                    if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                        $tablecontent.='<span title="overdue" style="color:red;">'; 
                                        $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                        $tablecontent.='</span>'; 
                                    }else{
                                        $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                    }
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $total=0;
                                foreach($st_invoice as $st_i){
                                    if($st_i->st_i_no==$emp->st_no){
                                        $total=$total+$st_i->st_i_total;
                                    }
                                }
                                $tablecontent.=number_format($total,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($emp->st_balance,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_bill_address;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_bill_address;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_term;
                                $tablecontent.='</td>';
                
                                
                            }
                        }
                        
            
                        }
                    }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND (je_transaction_type='Invoice' OR je_transaction_type='Credit Note' OR je_transaction_type='Sales Receipt')";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach($STCustomer as $STC){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                            
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->customer_id==$STC->st_customer_id && $go==1){
                                    if($emp->st_status=="Partially paid" || $emp->st_status=="Open" ){
                                    $tablecontent.=$emp->display_name;
                                    break;
                                }
                                }
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                            
                            foreach($SalesTransaction as $emp){
                                $go=0;
                                foreach($JournalEntry as $JJJJ){
                                    if($JJJJ->je_cost_center==$ccl->cc_no){
                                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                        }
                                        
                                    }
                                    
                                }
                                if($emp->customer_id==$STC->st_customer_id){
                                if($emp->remark!="Cancelled" && $go==1){
                                    if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_type;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_no;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        if($emp->display_name!=""){
                                        $tablecontent.=$emp->display_name;
                                        }else{
                                        $tablecontent.=$emp->f_name." ".$emp->l_name;
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_memo;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        if($emp->st_due_date!=""){
                                            $date1=date_create(date('Y-m-d'));
                                            $date2=date_create($emp->st_due_date);
                                            $diff=date_diff($date1,$date2);
                                            if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                                $tablecontent.='<span title="overdue" style="color:red;">'; 
                                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                                $tablecontent.='</span>'; 
                                            }else{
                                                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                            }
                                        }
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $total=0;
                                        foreach($st_invoice as $st_i){
                                            if($st_i->st_i_no==$emp->st_no){
                                                $total=$total+$st_i->st_i_total;
                                            }
                                        }
                                        $tablecontent.=number_format($total,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=number_format($emp->st_balance,2);
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_bill_address;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_bill_address;
                                        $tablecontent.='</td>';
                                        $tablecontent.='<td style="vertical-align:middle;">';
                                        $tablecontent.=$emp->st_term;
                                        $tablecontent.='</td>';
                        
                                        
                                    }
                                }
                                
                    
                                }
                            }
                        }
                    }
                    
                    
                }
            }

        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="9" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach($STCustomer as $STC){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td style="vertical-align:middle;" colspan="20">';
                
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                            $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->customer_id==$STC->st_customer_id && $go==1){
                        if($emp->st_status=="Partially paid" || $emp->st_status=="Open" ){
                        $tablecontent.=$emp->display_name;
                        break;
                    }
                    }
                }
                $tablecontent.='</td>';
                $tablecontent.='</tr>';
                
                foreach($SalesTransaction as $emp){
                    $go=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                            $go=1;
                            }
                            
                        }
                        
                    }
                    if($emp->customer_id==$STC->st_customer_id){
                    if($emp->remark!="Cancelled" && $go==1){
                        if($emp->st_type=="Invoice" &&($emp->st_status=="Open" || $emp->st_status=="Partially paid")){
                            $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_type;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_no;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->display_name!=""){
                            $tablecontent.=$emp->display_name;
                            }else{
                            $tablecontent.=$emp->f_name." ".$emp->l_name;
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_memo;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            if($emp->st_due_date!=""){
                                $date1=date_create(date('Y-m-d'));
                                $date2=date_create($emp->st_due_date);
                                $diff=date_diff($date1,$date2);
                                if(($diff->format("%R")=="-" || ($diff->format("%R")=="+" && $diff->format("%a")=="0")) && ($emp->st_status=="Open" || $emp->st_status=="Partially paid" )){
                                    $tablecontent.='<span title="overdue" style="color:red;">'; 
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                    $tablecontent.='</span>'; 
                                }else{
                                    $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : ""; 
                                }
                            }
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $total=0;
                            foreach($st_invoice as $st_i){
                                if($st_i->st_i_no==$emp->st_no){
                                    $total=$total+$st_i->st_i_total;
                                }
                            }
                            $tablecontent.=number_format($total,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($emp->st_balance,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_bill_address;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$emp->st_term;
                            $tablecontent.='</td>';
            
                            
                        }
                    }
                    
        
                    }
                }
            }
        }
        
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction Type</th><th>No.</th><th>Name</th><th>Memo</th><th>Due Date</th><th>Amount</th><th>Open Balance</th><th>Billing Address</th><th>Shipping Address</th><th>Terms</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function deposit_detail_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $cost_center_list=CostCenter::all();
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $tablecontent="";
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                foreach($SalesTransaction as $emp){
                    if($emp->st_type=="Sales Receipt"){
                        $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_type;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_no;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        if($emp->display_name!=""){
                        $tablecontent.=$emp->display_name;
                        }else{
                        $tablecontent.=$emp->f_name." ".$emp->l_name;
                        }
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->st_memo;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$emp->payment_method;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($emp->st_amount_paid,2);
                        $tablecontent.='</td>';
                        
        
        
        
        
                    }
                }
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Sales Receipt'";
                    if($sortsettingjournal==""){
                        $sortjournal="WHERE je_cost_center='".$ccl->cc_no."'  AND je_transaction_type='Sales Receipt'";
                    }else{
                        $sortjournal=" WHERE je_cost_center='".$ccl->cc_no."'  AND je_transaction_type='Sales Receipt'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                                $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        foreach($SalesTransaction as $emp){
                            $go=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" ) && $JJJJ->je_credit!=""){
                                        $go=1;
                                    }
                                    
                                }
                                
                            }
                            if($emp->st_type=="Sales Receipt" && $go==1){
                                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_type;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_no;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                if($emp->display_name!=""){
                                $tablecontent.=$emp->display_name;
                                }else{
                                $tablecontent.=$emp->f_name." ".$emp->l_name;
                                }
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->st_memo;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$emp->payment_method;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($emp->st_amount_paid,2);
                                $tablecontent.='</td>';
                                
                
                
                
                
                            }
                        }
                    }
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="7" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            foreach($SalesTransaction as $emp){
                $go=0;
                foreach($JournalEntry as $JJJJ){
                    if($JJJJ->je_cost_center==$CostCenterFilter){
                        if($JJJJ->other_no==$emp->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Credit Note" || $JJJJ->je_transaction_type=="Sales Receipt" ) && $JJJJ->je_credit!=""){
                            $go=1;
						}
						
					}
					
                }
                if($emp->st_type=="Sales Receipt" && $go==1){
                    $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_type;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_no;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    if($emp->display_name!=""){
                    $tablecontent.=$emp->display_name;
                    }else{
                    $tablecontent.=$emp->f_name." ".$emp->l_name;
                    }
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->st_memo;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=$emp->payment_method;
                    $tablecontent.='</td>';
                    $tablecontent.='<td style="vertical-align:middle;">';
                    $tablecontent.=number_format($emp->st_amount_paid,2);
                    $tablecontent.='</td>';
                    
    
    
    
    
                }
            }
        }
        
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Transaction type</th><th>No.</th><th>Name</th><th>Memo</th><th>Payment Method</th><th>Amount</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function estimatebycustomer_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        if($filtertemplate=="All"){
            $sortsetting="";
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $tablecontent="";
        foreach($SalesTransaction as $emp){
            if($emp->st_type=="Estimate"){
                $tablecontent.='<tr style="border-bottom:1px solid #ccc;">';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_date!=""? date('m-d-Y',strtotime($emp->st_date)) : "";
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_status;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_no;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                if($emp->display_name!=""){
                $tablecontent.=$emp->display_name;
                }else{
                $tablecontent.=$emp->f_name." ".$emp->l_name;
                }
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_memo;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_due_date!=""? date('m-d-Y',strtotime($emp->st_due_date)) : "";
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $total=0;
                foreach($st_invoice as $st_i){
                    if($st_i->st_i_no==$emp->st_no){
                        $total=$total+$st_i->st_i_total;
                    }
                }
                $tablecontent.=number_format($total,2);
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_email;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_bill_address;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_bill_address;
                $tablecontent.='</td>';
                $tablecontent.='<td style="vertical-align:middle;">';
                $tablecontent.=$emp->st_type;
                $tablecontent.='</td>';




            }
        }
        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th>Date</th><th>Estimate Status</th><th>No.</th><th>Name</th><th>Memo</th><th>Due Date</th><th>Amount</th><th>Email</th><th>Billing Address</th><th>Shipping Address</th><th>Transaction type</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;
    }
    public function DipositDetail(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.Deposit_Detail', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_estimates','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Invoice_List(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.invoicelist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Open_Invoice_List(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.openinvoicelist', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function AR_REceivable_ageing_by_date(Request $request){
        $FROM=$request->FROM;
        $TO=$request->TO;
        $CostCenterFilter=$request->CostCenterFilter;
        $filtertemplate=$request->filtertemplate;
        $sortsetting="WHERE st_date BETWEEN '".$FROM."' AND '".$TO."'";
        $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."' AND";
        if($filtertemplate=="All"){
            $sortsetting="";
            $sortsettingjournal="";
        }
        if($sortsettingjournal==""){
            $sortjournal="WHERE je_cost_center='".$CostCenterFilter."'";
        }else{
            $sortjournal=" WHERE je_cost_center='".$CostCenterFilter."'";
        }
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            $sortjournal="";
            $sortsettingjournal="WHERE created_at BETWEEN '".$FROM."' AND '".$TO."'";
            if($filtertemplate=="All"){
                $sortsetting="";
                $sortsettingjournal="";
            }
        }
        $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                            ".$sortjournal." 
                            ORDER BY created_at ASC");
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $saletransaction = DB::table('sales_transaction')
                ->select('*')
                ->groupBy('st_payment_for')
                ->get();
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $cost_center_list=CostCenter::all();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $tablecontent='';
        
        if($CostCenterFilter=="All" || $CostCenterFilter=="By Cost Center"){
            if($CostCenterFilter=="All"){
                $totaltotal2=0;
                $totalonetotal=0;
                $totalrqototal=0;
                $totalthreetotal=0;
                $totalfourtotal=0;
                $totaltotaltotal=0;
                foreach($saletransaction as $ST){
                    if($ST->remark!="Cancelled"){
                        if($ST->st_type=="Sales Receipt"){
                            $tablecontent.='<tr>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=$ST->st_payment_for;
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            foreach ($customers as $customer){
                                if ($customer->customer_id==$ST->st_customer_id){
                                    $tablecontent.=$customer->display_name!=""? $customer->display_name  : $customer->f_name." ".$customer->l_name;
                                }
                            }
                            

                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $total=0;
                            foreach($st_invoice as $st_i){
                                if($st_i->st_i_no==$ST->st_payment_for){
                                    $total=$total+$st_i->st_i_total;
                                }
                            }
                            $tablecontent.=number_format($total,2);
                            $totaltotal2+=$total;
                            $tablecontent.='</td>';
                            $totalone=0;
                            $totalrqo=0;
                            $totalthree=0;
                            $totalfour=0;
                            $totaltotal=0;
                            foreach($SalesTransaction as $ST2){
                                if($ST2->remark!="Cancelled"){
                                    if($ST2->st_payment_for==$ST->st_payment_for){
                                        if($ST2->st_date>date('Y-m-d', strtotime('-30 days'))){
                                            $totalone+=$ST2->st_amount_paid;
                                        }
                                        if($ST2->st_date<date('Y-m-d', strtotime('-31 days')) && $ST2->st_date>date('Y-m-d', strtotime('-60 days'))){
                                            $totalrqo+=$ST2->st_amount_paid;
                                        }
                                        if($ST2->st_date<date('Y-m-d', strtotime('-61 days')) && $ST2->st_date>date('Y-m-d', strtotime('-90 days'))){
                                            $totalthree+=$ST2->st_amount_paid;
                                        }
                                        if($ST2->st_date<date('Y-m-d', strtotime('-91 days'))){
                                            $totalfour+=$ST2->st_amount_paid;
                                        }
                                            $totaltotal+=$ST2->st_amount_paid;
                                    }
                                }
                            }

                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($totalone,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($totalrqo,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($totalthree,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($totalfour,2);
                            $tablecontent.='</td>';
                            $tablecontent.='<td style="vertical-align:middle;">';
                            $tablecontent.=number_format($totaltotal,2);
                            $tablecontent.='</td>';
                            $tablecontent.='</tr>';
                            $totalonetotal+=$totalone;
                            $totalrqototal+=$totalrqo;
                            $totalthreetotal+=$totalthree;
                            $totalfourtotal+=$totalfour;
                            $totaltotaltotal+=$totaltotal;
                        }
                    }
                }
                        $tablecontent.='<tr style="font-weight:bold;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.=number_format($totaltotal2,2);
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalonetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqototal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthreetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfourtotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                
            }else if($CostCenterFilter=="By Cost Center"){
                foreach($cost_center_list as $ccl){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Sales Receipt'";
                    if($sortsettingjournal==""){
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Sales Receipt'";
                    }else{
                    $sortjournal="WHERE je_cost_center='".$ccl->cc_no."' AND je_transaction_type='Sales Receipt'";
                    }
                    $JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
                    ".$sortjournal." 
                    ORDER BY created_at ASC");
                    if(count($JournalEntry)!=0){
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
                        $tablecontent.=$ccl->cc_name;
                        $tablecontent.='</td>';
                        $tablecontent.="</tr>";
                        $tablecontent.="<tr>";
                        $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
                        $tablecontent.="</tr>";
		
                    }
                    $totaltotal2=0;
                    $totalonetotal=0;
                    $totalrqototal=0;
                    $totalthreetotal=0;
                    $totalfourtotal=0;
                    $totaltotaltotal=0;
                    foreach($saletransaction as $ST){
                        if($ST->remark!="Cancelled"){
                            $costcenterselected=0;
                            foreach($JournalEntry as $JJJJ){
                                if($JJJJ->je_cost_center==$ccl->cc_no){
                                    if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                        $costcenterselected=1;
                                    }
                                    
                                }
                                
                            }
                            if($ST->st_type=="Sales Receipt" && $costcenterselected==1){
                                $tablecontent.='<tr>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=$ST->st_payment_for;
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                foreach ($customers as $customer){
                                    if ($customer->customer_id==$ST->st_customer_id){
                                        $tablecontent.=$customer->display_name!=""? $customer->display_name  : $customer->f_name." ".$customer->l_name;
                                    }
                                }
                                
        
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $total=0;
                                foreach($st_invoice as $st_i){
                                    if($st_i->st_i_no==$ST->st_payment_for){
                                        $total=$total+$st_i->st_i_total;
                                    }
                                }
                                $tablecontent.=number_format($total,2);
                                $totaltotal2+=$total;
                                $tablecontent.='</td>';
                                $totalone=0;
                                $totalrqo=0;
                                $totalthree=0;
                                $totalfour=0;
                                $totaltotal=0;
                                foreach($SalesTransaction as $ST2){
                                    if($ST2->remark!="Cancelled"){
                                        if($ST2->st_payment_for==$ST->st_payment_for){
                                            if($ST2->st_date>date('Y-m-d', strtotime('-30 days'))){
                                                $totalone+=$ST2->st_amount_paid;
                                            }
                                            if($ST2->st_date<date('Y-m-d', strtotime('-31 days')) && $ST2->st_date>date('Y-m-d', strtotime('-60 days'))){
                                                $totalrqo+=$ST2->st_amount_paid;
                                            }
                                            if($ST2->st_date<date('Y-m-d', strtotime('-61 days')) && $ST2->st_date>date('Y-m-d', strtotime('-90 days'))){
                                                $totalthree+=$ST2->st_amount_paid;
                                            }
                                            if($ST2->st_date<date('Y-m-d', strtotime('-91 days'))){
                                                $totalfour+=$ST2->st_amount_paid;
                                            }
                                                $totaltotal+=$ST2->st_amount_paid;
                                        }
                                    }
                                }
        
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalone,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalrqo,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalthree,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totalfour,2);
                                $tablecontent.='</td>';
                                $tablecontent.='<td style="vertical-align:middle;">';
                                $tablecontent.=number_format($totaltotal,2);
                                $tablecontent.='</td>';
                                $tablecontent.='</tr>';
                                $totalonetotal+=$totalone;
                                $totalrqototal+=$totalrqo;
                                $totalthreetotal+=$totalthree;
                                $totalfourtotal+=$totalfour;
                                $totaltotaltotal+=$totaltotal;
                            }
                        }
                    }
                        $tablecontent.='<tr style="font-weight:bold;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.=number_format($totaltotal2,2);
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalonetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqototal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthreetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfourtotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                    
                }
            }
        }else{
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;text-align:center;">';
            foreach($cost_center_list as $ccl){
                if($ccl->cc_no==$CostCenterFilter){
                    $tablecontent.=$ccl->cc_name;
                }
            }
            $tablecontent.='</td>';
            $tablecontent.="</tr>";
            $tablecontent.="<tr>";
            $tablecontent.='<td colspan="8" style="vertical-align:middle;font-weight:bold;font-size:14px;"></td>';
            $tablecontent.="</tr>";
            $totaltotal2=0;
            $totalonetotal=0;
            $totalrqototal=0;
            $totalthreetotal=0;
            $totalfourtotal=0;
            $totaltotaltotal=0;
            foreach($saletransaction as $ST){
                if($ST->remark!="Cancelled"){
                    $costcenterselected=0;
                    foreach($JournalEntry as $JJJJ){
                        if($JJJJ->je_cost_center==$CostCenterFilter){
                            if($JJJJ->other_no==$ST->st_no && ($JJJJ->je_transaction_type=="Invoice" || $JJJJ->je_transaction_type=="Sales Receipt" || $JJJJ->je_transaction_type=="Credit Note" ) && $JJJJ->je_credit!=""){
                                $costcenterselected=1;
                            }
                            
                        }
                        
                    }
                    if($ST->st_type=="Sales Receipt" && $costcenterselected==1){
                        $tablecontent.='<tr>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=$ST->st_payment_for;
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        foreach ($customers as $customer){
                            if ($customer->customer_id==$ST->st_customer_id){
                                $tablecontent.=$customer->display_name!=""? $customer->display_name  : $customer->f_name." ".$customer->l_name;
                            }
                        }
                        

                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $total=0;
                        foreach($st_invoice as $st_i){
                            if($st_i->st_i_no==$ST->st_payment_for){
                                $total=$total+$st_i->st_i_total;
                            }
                        }
                        $tablecontent.=number_format($total,2);
                        $totaltotal2+=$total;
                        $tablecontent.='</td>';
                        $totalone=0;
                        $totalrqo=0;
                        $totalthree=0;
                        $totalfour=0;
                        $totaltotal=0;
                        foreach($SalesTransaction as $ST2){
                            if($ST2->remark!="Cancelled"){
                                if($ST2->st_payment_for==$ST->st_payment_for){
                                    if($ST2->st_date>date('Y-m-d', strtotime('-30 days'))){
                                        $totalone+=$ST2->st_amount_paid;
                                    }
                                    if($ST2->st_date<date('Y-m-d', strtotime('-31 days')) && $ST2->st_date>date('Y-m-d', strtotime('-60 days'))){
                                        $totalrqo+=$ST2->st_amount_paid;
                                    }
                                    if($ST2->st_date<date('Y-m-d', strtotime('-61 days')) && $ST2->st_date>date('Y-m-d', strtotime('-90 days'))){
                                        $totalthree+=$ST2->st_amount_paid;
                                    }
                                    if($ST2->st_date<date('Y-m-d', strtotime('-91 days'))){
                                        $totalfour+=$ST2->st_amount_paid;
                                    }
                                        $totaltotal+=$ST2->st_amount_paid;
                                }
                            }
                        }

                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalone,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqo,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthree,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfour,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
                        $totalonetotal+=$totalone;
                        $totalrqototal+=$totalrqo;
                        $totalthreetotal+=$totalthree;
                        $totalfourtotal+=$totalfour;
                        $totaltotaltotal+=$totaltotal;
                    }
                }
            }
                        $tablecontent.='<tr style="font-weight:bold;">';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        
                        $tablecontent.=number_format($totaltotal2,2);
                        $tablecontent.='</td>';
                        
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalonetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalrqototal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalthreetotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totalfourtotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='<td style="vertical-align:middle;">';
                        $tablecontent.=number_format($totaltotaltotal,2);
                        $tablecontent.='</td>';
                        $tablecontent.='</tr>';
        }

        $table='<table id="tablemain" class="table table-sm" style="text-align:left;font-size:12px;">'
                .'<thead><tr>'
                .'<th></th><th></th><th>Current</th><th>1-30</th><th>31-60</th><th>61-90</th><th>91 and above</th><th>Total</th>'
                .'</tr></thead>'
                .'<tbody>'.
                $tablecontent
                .'</tbody>'
                .'</table>';
        return $table;

    }
    public function AR_Receivable_Ageing(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $saletransaction = DB::table('sales_transaction')
                ->select('*')
                ->groupBy('st_payment_for')
                ->get();
        //return $saletransaction;    
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        // $COA= ChartofAccount::where('coa_active','1')->orderBy('coa_code','ASC')->get();
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.ar_recievable', compact('saletransaction','numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function Estimate_by_Customer(Request $request){
        $sortsetting="";
        if($request->date_from){
            $sortsetting="WHERE st_date BETWEEN '".$request->date_from."' AND '".$request->date_to."'";
        }else{
            
        }
        $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id
                            ".$sortsetting." 
                            ORDER BY st_no ASC");
        $STCustomer= DB::table('sales_transaction')
                        ->join('customers', 'customers.customer_id', '=', 'sales_transaction.st_customer_id')
                        ->select('st_customer_id')
                        ->groupBy('st_customer_id')
                        ->get();
            
        $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice");
        $st_estimates= DB::connection('mysql')->select("SELECT * FROM st_estimates");
        $Supplier= Supplier::orderBy('display_name', 'ASC')->get();
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $jounal = DB::table('journal_entries')
                ->select('je_no')
                ->groupBy('je_no')
                ->get();
        $jounalcount=count($jounal)+1;
        date_default_timezone_set('Asia/Manila');
        $date = date('l, d F Y h:i a \G\T\MO');
        $Report = Report::all();
        $VoucherCount=Voucher::count() + 1;
        if($VoucherCount<10){
            $VoucherCount="000".$VoucherCount;
        }
        else if($VoucherCount<100 && $VoucherCount>9 ){
            $VoucherCount="00".$VoucherCount;
        }
        else if($VoucherCount<1000 && $VoucherCount>99 ){
            $VoucherCount="0".$VoucherCount;
        }
        $VoucherCount=Voucher::all();
        $expense_transactions = DB::table('expense_transactions')
            ->join('et_account_details', 'expense_transactions.et_no', '=', 'et_account_details.et_ad_no')
            ->join('customers', 'customers.customer_id', '=', 'expense_transactions.et_customer')
            ->get();
            $et_acc = DB::table('et_account_details')->get();
            $et_it = DB::table('et_item_details')->get();
        $totalexp=0;
        foreach($expense_transactions as $et){
            if($et->remark==""){$totalexp=$totalexp+$et->et_ad_total;}
        }
        $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        $SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
        $numbering = Numbering::first();
        $st_invoice = DB::table('st_invoice')->get();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        return view('app.estimatecustomer', compact('numbering','st_invoice','cost_center_list','all_cost_center_list','ETran','SS','COA','expense_transactions','totalexp','et_acc','et_it','VoucherCount','st_estimates','STCustomer','st_invoice','SalesTransaction','Supplier','Report','date','jounalcount','customers', 'products_and_services','JournalEntry'));
    }
    public function employee_contact_add(Request $request){
        //
        
        $message="";
        if($request->reportsettings['ReportID']==""){
            $reportcount = Report::count()+1;
            $Report = new  Report;
            $Report->report_id = $reportcount;
            $message=$reportcount;
            $eventlog="Added Custom Report";
        }else{
            $Report = Report::find($request->reportsettings['ReportID']);
            $message="Successfully updated Custom Report template";
            $eventlog="Edited Custom Report";
        }
        $Report->report_name=$request->reportsettings['ReportName'];
        $Report->report_header=$request->reportsettings['ReportHeader'];
        $Report->report_title=$request->reportsettings['ReportTitle'];
        $Report->report_type=$request->reportsettings['ReportType'];
        $Report->report_show_note=$request->reportsettings['noteShow'];
        $Report->report_note=$request->reportsettings['noteContent'];
        $Report->report_sort_by=$request->reportsettings['ReportSortBy'];
        $Report->report_sort_order=$request->reportsettings['ReportSortOrder'];
        $Report->report_table_column=$request->reportsettings['ReportTableColumns'];
        $Report->report_url=$request->reportsettings['report_url'];
        $Report->report_content_cost_center_filter=$request->reportsettings['report_cost_center_filter'];
        
        if($request->reportsettings['report_content_filter']){
            $Report->report_content_filter=$request->reportsettings['report_content_filter'];
            $Report->report_content_from=$request->reportsettings['report_content_from'];
            $Report->report_content_to=$request->reportsettings['report_content_to'];
        }

        if($Report->save()){
            $AuditLog= new AuditLog;
            $AuditLogcount=AuditLog::count()+1;
            $userid = Auth::user()->id;
            $username = Auth::user()->name;
            $AuditLog->log_id=$AuditLogcount;
            $AuditLog->log_user_id=$userid;
            $AuditLog->log_event=$eventlog;
            $AuditLog->log_name=$username;
            $AuditLog->log_transaction_date="";
            $AuditLog->log_amount="";
            $AuditLog->save();
            return $message;
        }else{
            return "Error! please try again later";
        }

    }
    public function deactivate_report(Request $request){
        
            
        $Report = Report::find($request->id);
        $Report->report_status="0";
        $message="Successfully deleted custom report";
        if($Report->save()){
            $AuditLog= new AuditLog;
            $AuditLogcount=AuditLog::count()+1;
            $userid = Auth::user()->id;
            $username = Auth::user()->name;
            $eventlog="Deleted Custom Report";
            $AuditLog->log_id=$AuditLogcount;
            $AuditLog->log_user_id=$username;
            $AuditLog->log_event=$eventlog;
            $AuditLog->log_name="";
            $AuditLog->log_transaction_date="";
            $AuditLog->log_amount="";
            $AuditLog->save();  

            return $message;
        }else{
            return "Error! please try again later";
        }
    }
    public function replaceeditinvoicemodal(Request $request){
        //return $request->id;
        //$JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->find($request->id);
        //$JournalEntry= DB::connection('mysql')->select("SELECT * FROM journal_entries
        //                    WHERE je_no='".$request->id."'");
        //$JournalEntry = DB::table('journal_entries')->where('je_transaction_type', '=', $request->id)->get();
        $ID=$request->id;
        $Type=$request->type;
        $Location=$request->Location;
        $TTTT=$request->TTTTT;
        $customers = Customers::orderBy('display_name', 'ASC')->get();
        $numbering = Numbering::first();
        $cost_center_list= CostCenter::where('cc_status','1')->orderBy('cc_type_code', 'asc')->get();         $all_cost_center_list= CostCenter::all();
        $JournalEntry = JournalEntry::where([['remark','!=','NULLED']])->orWhereNull('remark')->orderBy('je_no','DESC')->get();
        $userpos=Auth::user()->position;
                $COA= DB::connection('mysql')->select("SELECT * FROM chart_of_accounts WHERE coa_active='1' ORDER BY coa_code+0 ASC");
        if($Type=="Invoice"){
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
                JOIN customers ON sales_transaction.st_customer_id=customers.customer_id WHERE st_no='".$request->id."' AND st_type='Invoice' AND st_location='".$Location."' AND st_invoice_type='".$TTTT."'");
            
            if(!empty($SalesTransaction) && $SalesTransaction[0]->st_status=="Open"){
                $sales_receipt_invoice= DB::connection('mysql')->select("SELECT * FROM sales_transaction WHERE st_payment_for='".$request->id."' AND st_type='Sales Receipt' AND st_location='".$Location."' AND st_invoice_type='".$TTTT."'");
                if(count($sales_receipt_invoice)>0){
                    return "Invalid";
                }
                // print_r("SELECT * FROM sales_transaction
                // JOIN customers ON sales_transaction.st_customer_id=customers.customer_id WHERE st_no='".$request->id."' AND st_location='".$Location."' AND st_invoice_type='".$TTTT."'");
                $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_invoice WHERE st_i_no='".$request->id."' AND st_p_location='".$Location."' AND st_p_invoice_type='".$TTTT."'");
                $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
                //$SS=SalesTransaction::all();$ETran = DB::table('expense_transactions')->get();
                $form="";
                $form.='<form action="update_invoice_edit" class="form-horizontal" method="POST" id="edit_invoice_form"  autocomplete="off">';
                $form.=csrf_field();
                $form.='<input id="transaction_id_edit" name="transaction_id_edit" value="'.$ID.'" hidden>';
                $form.='<input id="transaction_type_edit" name="transaction_type_edit" value="Invoice" hidden>';
                $form.='<input id="product_count_edit" name="product_count_edit" value="0" hidden>';
                $form.='<input type="text" id="total_balance_edit" name="total_balance_edit" value="0" hidden>';
                $form.='<input type="number" id="sales_transaction_number_estimate_edit" name="sales_transaction_number_estimate_edit" value="0" hidden>';
                $form.='<input type="number" id="sales_transaction_number_delayed_charge_edit" name="sales_transaction_number_delayed_charge_edit" value="0" hidden>';
                $form.='<input type="number" id="sales_transaction_number_delayed_credit_edit" name="sales_transaction_number_delayed_credit_edit" value="0" hidden>';
                $form.='<div class="modal-dialog modal-full" role="document" style="min-width: 100%; margin: 0;">';
                $form.='<div class="modal-content" style="min-height: 100vh;">';
                $form.='<div class="modal-header">';
                $form.='<h5 class="modal-title">Invoice</h5>';
                $form.='<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
                $form.='<span aria-hidden="true"></span>';
                $form.='</button>';
                $form.='</div>';
                $form.='<div class="modal-body p-4" id="result_edit">';
                $form.='<div class="col-md-12 p-0 mb-4">';
                $form.='<div class="col-md-12 p-0  mb-4">';
                    $form.='<div class="col-md-2 p-0 pr-3">';
                    $form.='<p>Location</p>';
                    $form.='<select class="w-100 form-control" id="invoice_location_top_edit" name="invoice_location_top_edit" >';
                    $form.='<option>'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_location : '').'</option>';
                    
                    $form.='</select>';
                    $form.='</div>';
                    $form.='<div class="col-md-2 p-0 pr-3">';
                    $form.='<p>Type</p>';
                    $form.='<select class="w-100 form-control" id="invoice_type_top_edit" name="invoice_type_top_edit" >';
                    $form.='<option>'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_invoice_type : '').'</option>';
                    
                    $form.='</select>';
                    $form.='</div>';
                $form.='</div>';
                $form.='<div class="col-md-12 p-0">';
                    $form.='<div class="col-md-2 p-0 pr-3  mb-4">';
                    $form.='<p>Invoice No</p>';
                    $form.='<input type="text" name="" id="" class="w-100" value="'.$ID.'" readonly>';
                    $form.='</div>';
                    $form.='<div class="col-md-2 p-0 pr-3">';
                    $form.='<p>Invoice Date</p>';
                    $form.='<input id="invoicedate_edit"  type="date" name="date_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_date : '').'" class="w-100 form-control" required>';
                    $form.='</div>';
                    $form.='<div class="col-md-2 p-0 pr-3">';
                    $form.='<p>Due Date</p>';
                    $form.='<input id="invoiceduedate_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_due_date :'').'" min="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_date : '').'"  type="date" name="due_date_edit" value="'.(!empty($SalesTransaction)?  $SalesTransaction[0]->st_due_date : '').'" class="w-100 form-control" >';
                    $form.='</div>';
                    
                $form.='</div>';
                $form.='<div class="col-md-12 p-0" style="display:none;">';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<div class="col-md-4 p-0 pr-3" style="display:none;">';
                }else{
                    $form.='<div class="col-md-4 p-0 pr-3" style="">';
                }
                
                $form.='<p>Cost Center</p>';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<select name="CostCenterInvoiceEdit" id="CostCenterInvoiceEdit" class="w-100">';
                }else{
                    $form.='<select name="CostCenterInvoiceEdit" id="CostCenterInvoiceEdit"  class="w-100">';
                }
                
                $form.='<option value="">--Select Cost Center--</option>';
                foreach ($cost_center_list as $list){
                    $form.='<option value="'.$list->cc_no.'">'.$list->cc_name.'</option>';
                }
                $form.='</select>';
                $form.='<script>';
                foreach($JournalEntry as $JE){
                    if($JE->other_no==$ID){
                    $form.='document.getElementById(\'CostCenterInvoiceEdit\').value="'.$JE->je_cost_center.'";';
                    }
                }
                $form.='</script>';
                $form.='</div>';
                $form.='</div>';
                $form.='<div class="my-3 p-0">';
                    $form.='<div class="col-md-4 p-0 pr-3  mb-4">';
                    $form.='<p>Customer</p>';
                    $form.='<select id="invoicecustomer_edit" type="text" name="customer_edit" class="w-100 selectpicker" data-live-search="true" required>';
                    $form.='<option value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->customer_id : '').'">'.(!empty($SalesTransaction)? $SalesTransaction[0]->display_name : '').'</option>';    
                    $form.='</select>';
                    $form.='</div>';
                    
                    
                $form.='</div>';//first div
                $form.='<div class="col-md-12 p-0  mb-4">';
                    $form.='<div class="col-md-4 p-0 pr-3">';
                    $form.='<p>Billing Address</p>';
                    $form.='<input type="text" name="bill_address_edit" id="bill_address_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_bill_address : '').'" class="w-100 form-control" >';
                    $form.='</div>';
                    $form.='<div class="col-md-2 p-0 pr-3">';
                    $form.='<p>Terms</p>';
                    $form.='<input class="w-100 form-control" list="terms_list" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_term : '').'" name="term_edit" id="term_edit" >';
                    $form.='<datalist id="terms_list">';
                    $form.='<option>Due on receipt</option>';
                    $form.='<option>Net 15</option>';
                    $form.='<option>Net 30</option>';
                    $form.='<option>Net 60</option>';
                    $form.='</datalist>';
                    $form.='</div>';
                
                
    
                $form.='</div>';
                $form.='<div class="col-md-12 p-0  mb-4">';
                $form.='<div class="col-md-2 p-0 pr-3">';
                $form.='<p>Job Order</p>';
                $form.='<input type="text" name="job_order_invoice_edit" id="job_order_invoice_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_invoice_job_order : '').'" class="w-100 form-control">';
                $form.='</div>';
                $form.='<div class="col-md-2 p-0 pr-3">';
                $form.='<p>Work No</p>';
                $form.='<input type="text" name="job_work_no_edit" id="job_work_no_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_invoice_work_no : '').'" class="w-100 form-control">';
                $form.='</div>';
                $form.='</div>';
                
                    $form.='<div class="col-md-3 p-0 pr-3">';
                    $form.='<p>Email</p>';
                    $form.='<input type="text" id="email_edit" value="'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_email : '').'" name="email_edit" placeholder="Email (Separate emails with a comma)" class="w-100 form-control"><br>';
                        
                    $form.='</div>';
                    $form.='<div class="col-md-3 p-0 pr-3 pt-4">';
                        $form.='<div class="float-left">';
                        $form.='<input type="checkbox" name="send_later_edit" value="yes"> Send Now';
                        $form.='</div>';
                        $form.='<div class="float-right">';
                        $form.='<p class="text-info" style="margin-bottom:0px;"></p>';
                        $form.='</div>';
                        $form.='<div class="float-left" style="padding-left:10px;">';
                        $form.='<input type="checkbox" name="generate_pdf_edit" >Generate PDF';
                        $form.='</div>';
                    $form.='</div>';
                    $form.='<div class="col-md-6 p-0 d-inline-flex justify-content-end pr-5" style="text-align:right;">';
                    $form.='<h4 class="mr-2">BALANCE DUE: </h4>';
                    $form.='<h4 id="big_invoicebalance">PHP '.(!empty($SalesTransaction)?  number_format($SalesTransaction[0]->opening_balance,2) : '').'</h4>';
                    $form.='</div>';           
                                
                           
                $form.='</div>';
                $form.='<table id="invoice_table_edit" class="table table-bordered table-responsive-md table-striped text-left font14">';
                $form.='<tr>';
                $form.='<th class="text-center" width="5%">#</th>';
                $form.='<th class="text-center"  width="10%">PARTICULARS</th>';
                $form.='<th class="text-center"  width="10%">ITEM</th>';
                $form.='<th class="text-center">DESCRIPTION</th>';
                $form.='<th class="text-center" width="5%">QTY</th>';
                $form.='<th class="text-center"  width="10%">RATE</th>';
                $form.='<th class="text-center"  width="10%">AMOUNT</th>';
                $form.='<th class="text-center"></th>';
                $form.='</tr>';
                $ctrcount=1;
                foreach($st_invoice as $st){
                if($st->st_i_no==$request->id){
                $form.='<tr class="invoice_lines_edit" id="invoice_line_edit'.$ctrcount.'">';
                $form.='<td class="pt-3-half" id="number_tag_edit" contenteditable="false">'.$ctrcount.'</td>';
                $form.='<td class="pt-3-half" contenteditable="false">';
                $form.='<select onchange="ChangeParticularInvoiceEdit(this)" id="ParticularInvoiceEdit'.$ctrcount.'" data-columncount="'.$ctrcount.'" class="w-100 invoice_particularEdit form-control"><option '.($st->st_i_product!=''? '': 'Selected').'>Cost Center</option><option '.($st->st_i_product!=''? 'Selected': '').'>Product/Service</option></select>';
                
                $form.='</td>';
                $form.='<td class="pt-3-half">';  
                $form.='<div class="ProductServicesInvoiceItemDivClassEdit" id="ProductServicesInvoiceItemDivEdit'.$ctrcount.'" style="'.($st->st_i_product!=''? '': 'display:none;').'">';
                $form.='<select name="InvoiceEditProductName'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\'),GetProductRate(\''.$ctrcount.'\')" style="border:0; width:100%;" class="invoice_data_edit product_select  selectpicker" data-live-search="true" id="select_product_name_edit'.$ctrcount.'">';
                foreach($products_and_services as $prod){
                    if($prod->product_id==$st->st_i_product){
                        $form.='<option value="'.$prod->product_id.'" Selected>'.$prod->product_name.'</option>';
                        break;
                    }
                    
                }
                $form.='<option value="">--Select Product--</option>';
                foreach($products_and_services as $product){
                $form.='<option value="'.$product->product_id.'.">'.$product->product_name.'</option>';
                    
                }
    
                $form.='</select>';
                $form.='</div>';
                $form.='<div id="CostCenterInvoiceItemDivClassEdit'.$ctrcount.'" class="CostCenterInvoiceItemDivClassEdit" style="'.($st->st_i_product!=''? 'display:none;': '').'">';
                $form.='<select value="'.$st->st_p_cost_center.'" class="selectpicker" data-live-search="true" name="CostCenterInvoiceEdit'.$ctrcount.'" id="CostCenterInvoiceEdit'.$ctrcount.'">';
                $form.='<option value="" Selected>--Select Cost Center--</option>';
                foreach($all_cost_center_list as $ccclll){
                    if($ccclll->cc_no==$st->st_p_cost_center){
                        $form.='<option value="'.$ccclll->cc_no.'" Selected>'.$ccclll->cc_name.'</option>';
                    }else{
                        $form.='<option value="'.$ccclll->cc_no.'">'.$ccclll->cc_name.'</option>';
                    }
                }
                $form.='</select>';
                $form.='</div>';
                
                  
                $form.='</td>';
                $form.='<td class="pt-3-half">';  
                $form.='<input type="hidden" name="InvoiceEditST_I_id'.$ctrcount.'" class="invoice_data_edit product_description" id="InvoiceEditST_I_id'.$ctrcount.'" value="'.$st->st_i_id.'" style="border:0;" >';  
                $form.='<textarea name="InvoiceEditProductDesc'.$ctrcount.'" class="w-100 invoice_data_edit product_description form-control" id="select_product_description_edit'.$ctrcount.'"  style="border:0;">'.$st->st_i_desc.'</textarea>';  
                $form.='</td>';  
                $form.='<td class="pt-3-half">';  
                $form.='<input type="number" name="InvoiceEditProductQty'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\')" class="invoice_data_edit product_qty form-control" onclick="this.select();" value="'.$st->st_i_qty.'" id="product_qty_edit'.$ctrcount.'" style="border:0; text-align:center;" value="1" min="1" required>';  
                $form.='</td>';  
                $form.='<td class="pt-3-half">';  
                $form.='<input type="text" name="InvoiceEditProductRateMask'.$ctrcount.'" class="product_rate_change_edit form-control"  id="select_product_rate_edit_mask'.$ctrcount.'" title="'.$st->st_i_rate.'" value="'.number_format($st->st_i_rate,2).'" style="border:0;text-align:right;" required>';  
                $form.='<input type="hidden" name="InvoiceEditProductRate'.$ctrcount.'" class="invoice_data_edit product_rate" onchange="GetProductAll(\''.$ctrcount.'\')"  id="select_product_rate_edit'.$ctrcount.'" title="'.$st->st_i_rate.'" value="'.$st->st_i_rate.'" style="border:0;">';  
                
                $form.='</td>';  
                $form.='<td class="pt-3-half product_total_edit" id="total_amount_edit'.$ctrcount.'" title="'.$st->st_i_total.'">'.number_format($st->st_i_total,2);
                $form.='</td>';  
                $form.='<td class="pt-3-half">';  
                $form.='';  
                $form.='</td>';
                $form.='</tr>'; 
                $form.='<script>'; 
                $form.='var textbox'.$ctrcount.' = "#select_product_rate_edit_mask'.$ctrcount.'";'; 
                $form.='var hidden'.$ctrcount.' = "#select_product_rate_edit'.$ctrcount.'";'; 
               
                $form.='$(textbox'.$ctrcount.').keyup(function () {'; 
                   
                $form.='$(textbox'.$ctrcount.').val(this.value.match(/[0-9.,-]*/));'; 
                $form.='var num = $(textbox'.$ctrcount.').val();'; 
                $form.='var comma = /,/g;'; 
                $form.='num = num.replace(comma,"");'; 
                $form.='$(hidden'.$ctrcount.').val(num);'; 
                $form.='$(hidden'.$ctrcount.').attr("title",num);'; 
                $form.='var numCommas = addCommas(num);'; 
                $form.='$(textbox'.$ctrcount.').val(numCommas);';
                $form.='$(hidden'.$ctrcount.').change();';
                
                $form.=' });'; 
                
                $form.='</script>'; 
              
                $ctrcount++;
                }
                }
                $form.='</table>';
                $form.='<input type="number" id="columncounteditinvoice" name="columncounteditinvoice" value="'.$ctrcount.'" hidden>';
                $form.='<div class="col-md-12 p-0">';
                $form.='<div class="float-left">';
                $form.='<div class="d-inline-flex">';
                $form.='<button type="button" class="btn btn-outline-dark rounded mr-1 font14" onclick="addlineinvoiceedit()" id="add_lines_invoic_edite">Add Lines</button>';
                $form.='</div>';
                $form.='</div>';
                $form.='<div class="float-right mr-5">';
                $form.='<div class="d-inline-flex mr-4">';
                $form.='<p class="mb-0 pr-4 text-dark font-weight-bold">TOTAL</p>';
                $form.='<p id="invoicetotal_edit" class="mb-0 text-dark font-weight-bold">PHP 0.00</p>';
                $form.='</div>';
                $form.='</div>';
                $form.='</div>';
                $form.='<div class="col-md-12 p-0">';
                $form.='<div class="float-right mr-5">';
                $form.='<div class="d-inline-flex mr-4">';
                $form.='<p class="pr-4 text-dark font-weight-bold">BALANCE DUE</p>';
                $form.='<p id="invoicebalance_edit" class="text-dark font-weight-bold">PHP '.(!empty($SalesTransaction)? number_format($SalesTransaction[0]->opening_balance,2) : '').'</p>';
                $form.='</div>';
                $form.=' </div>';
                $form.='</div>';
                $form.='<div class="col-md-12 p-0">';
                $form.='<div class="col-md-6 pl-0">';
                $form.='<p>Message Displayed on Invoice</p>';
                $form.='<textarea rows="3" class="w-100 form-control" name="note_edit" id="note_edit" >'.(!empty($SalesTransaction)? $SalesTransaction[0]->st_note : '').'</textarea>';
                $form.='</div>';
                $form.='<div class="col-md-6 pr-0">';
                $form.='<p>Message Displayed on Statement</p>';
                $form.='<textarea rows="3" class="w-100 form-control" name="memo_edit" id="memo_edit" >'.(!empty($SalesTransaction)?  $SalesTransaction[0]->st_memo : '').'</textarea>';
                $form.='</div>';
                $form.='</div>';
                
                $form.='<div class="col-md-12 p-0 mt-4">';
                $form.='<table class="table table-light">';
                $form.='<thead class="thead-light">';
                $form.='<tr>';
                $form.='<th colspan="3" style="vertical-align:middle;text-align:center;">Accounts</th>';
                $form.='</tr>';
                $form.='<tr>';
                $form.='<th style="vertical-align:middle;text-align:center;border-right: 1px solid #ccc;width:5%">#</th>';
                $form.='<th style="vertical-align:middle;text-align:center;border-right: 1px solid #ccc;width: 40%;">Debit</th>';
                $form.='<th style="vertical-align:middle;text-align:center;">Credit</th>';
                $form.='</tr>';
                $form.='</thead>';
                $form.='<tbody id="InvoiceAccountTBodyEdit">';
                $invoice_acc_count=1;
                foreach($st_invoice as $st){
                    $form.='<tr>';
                    $form.='<td style="vertical-align:middle;text-align:center;" >';
                    $form.=$invoice_acc_count;
                    $form.='</td>';
                    $form.='<td style="vertical-align:middle;" >';
                    $form.='<select class="form-control selectpicker" data-live-search="true" name="invoice_account_debit_accountedit'.$invoice_acc_count.'"  id="invoice_account_debit_accountedit'.$invoice_acc_count.'" required>';
                    $form.='<option value="">--Select Account--</option>';
                    foreach($COA as $coa){
                        if($coa->coa_sub_account=="Receivable Accounts" || $coa->coa_code=="136" || $coa->coa_name=="Cash Clearing Account"){
                            if($st->st_p_debit==$coa->id){
                                $form.='<option value="'.$coa->id.'" Selected>'.$coa->coa_name.'</option>';
                            }else{
                                $form.='<option value="'.$coa->id.'">'.$coa->coa_name.'</option>';
                            }
                        }
                    }
                    $form.='</select>';
                    $form.='</td>';
                    $form.='<td style="vertical-align:middle;" >';
                    $form.='<select class="form-control selectpicker" data-live-search="true" name="invoice_account_credit_accountedit'.$invoice_acc_count.'"  id="invoice_account_credit_accountedit'.$invoice_acc_count.'" required>';
                    $form.='<option value="">--Select Account--</option>';
                    foreach($COA as $coa){
                        if($coa->coa_account_type=="Revenue" || $coa->coa_code=="136" || $coa->coa_name=="Cash Clearing Account"){
                            if($st->st_p_credit==$coa->id){
                                $form.='<option value="'.$coa->id.'" Selected>'.$coa->coa_name.'</option>';
                            }else{
                                $form.='<option value="'.$coa->id.'">'.$coa->coa_name.'</option>';
                            }
                        }
                    }
                    $form.='</select>';
                    $form.='</td>';
                    $form.='</tr>';
                    $invoice_acc_count++;
                }
                

                $form.='</tbody>';
                $form.='</table>';
                $form.='</div>';
                
                $form.='<div class="col-md-6 m-0 p-0 mt-3" style="display:none;">';
                $form.='<div class="d-inline-flex">';
                $form.='<p class="fa fa-paperclip"></p>';
                $form.='<p class="p-0 ml-1">Maximum Size: 20MB</p>';
                $form.='</div>';
                $form.='<div class="input-group mb-3 p-0">';
                $form.='<div class="custom-file">';
                $form.='<input type="file" name="attachment_edit" class="custom-file-input" id="inputGroupFile01_edit" aria-describedby="inputGroupFileAddon01">';
                $form.='<label class="custom-file-label bg-transparent" for="inputGroupFile01">Choose file</label>';
                $form.='</div>';
                $form.='</div>';
                $form.='</div>';
                $form.='</div>';
                
                $form.='<div class="modal-footer">';
                $form.='<button type="button" class="btn btn-secondary rounded" data-dismiss="modal">Cancel</button>';
                $form.='<button id="invoiceadd_edit" class="btn btn-success rounded" type="submit">Save</button>';
                $form.='</div>';
                $form.='</div>';
                $form.='</div>';
                $form.='</form>';
                return $form;
            }else{
                return "Invalid";
            }
            
        }
        else if($Type=="Journal Entry" ){
            return "Journal Entry Type";

        }
        else if($Type=="Sales Receipt"){
            return "Sales Receipt";
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id WHERE st_no='".$request->id."'");
            $st_sales_receipts= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts WHERE st_s_no='".$request->id."'");
            //print_r($SalesTransaction);
            $st_invoice= DB::connection('mysql')->select("SELECT * FROM st_sales_receipts");
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $form="";
            $form.='<form action="update_sales_receipt_edit" class="form-horizontal" method="POST" id="edit_invoice_form"  autocomplete="off">';
            $form.=csrf_field();
            $form.='<input id="transaction_id_edit" name="transaction_id_edit" value="'.$ID.'" hidden>';
            $form.='<input id="transaction_type_edit" name="transaction_type_edit" value="Sales Receipt" hidden>';
            $form.='<input id="product_count_edit" name="product_count_edit" value="0" hidden>';
            $form.='<input type="text" id="total_balance_edit" step="0.01" name="total_balance_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_estimate_edit" name="sales_transaction_number_estimate_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_delayed_charge_edit" name="sales_transaction_number_delayed_charge_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_delayed_credit_edit" name="sales_transaction_number_delayed_credit_edit" value="0" hidden>';
            $form.='<div class="modal-dialog modal-full" role="document" style="min-width: 100%; margin: 0;">';
            $form.='<div class="modal-content" style="min-height: 100vh;">';
            $form.='<div class="modal-header">';
            $form.='<h5 class="modal-title">Sales Receipt</h5>';
            $form.='<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
            $form.='<span aria-hidden="true"></span>';
            $form.='</button>';
            $form.='</div>';
            $form.='<div class="modal-body p-4" id="result_edit">';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="col-md-2 p-0 pr-3">';
            $form.='<p>Sales Receipt No</p>';
            $form.='<input type="text" name="" id="" class="w-100" value="'.$ID.'" readonly>';
            $form.='</div>';
            $form.='<div class="col-md-2 p-0 pr-3">';
            $form.='<p>Sales Receipt Date</p>';
            $form.='<input id="sales_receipt_date_edit" '.($userpos!="CEO"? 'readonly' : '').' type="date" name="date_edit" value="'.$SalesTransaction[0]->st_date.'" class="w-100" required>';
            $form.='</div>';
            $form.='</div>';

            $form.='<div class="col-md-12 p-0 mb-4">';
            $form.='<div class="my-3 p-0">';
                $form.='<div class="col-md-4 p-0 pr-3">';
                $form.='<p>Customer</p>';
                $form.='<select id="sales_receipt_customer_edit" type="text" name="customer_edit" class="w-100" required>';
                $form.='<option value="'.$SalesTransaction[0]->customer_id.'">'.$SalesTransaction[0]->display_name.'</option>';    
                $form.='</select>';
                $form.='</div>';
                $form.='<div class="col-md-2 p-0" style="display:none;">';
                $form.='<p>Email</p>';
                $form.='<input type="text" id="email_edit" value="'.$SalesTransaction[0]->st_email.'" name="email_edit" placeholder="Email (Separate emails with a comma)" class="w-100"><br>';
                    $form.='<div class="float-left">';
                    $form.='<input type="checkbox" name="send_later_edit" value="yes">Send Now';
                    $form.='</div>';
                    $form.='<div class="float-right">';
                    $form.='<p class="text-info" style="margin-bottom:0px;"></p>';
                    $form.='</div>';
                $form.='</div>';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<div class="col-md-2 p-0 pr-3" style="display:none;">';
                }else{
                    $form.='<div class="col-md-2 p-0 pr-3" style="">';
                }
                
                $form.='<p>Cost Center</p>';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<select name="CostCenterSalesReceiptEdit" id="CostCenterSalesReceiptEdit" style="width:90%;" >';
                }else{
                    $form.='<select name="CostCenterSalesReceiptEdit" id="CostCenterSalesReceiptEdit" style="width:90%;" required>';
                }
                
                $form.='<option value="">--Select Cost Center--</option>';
                foreach ($cost_center_list as $list){
                    $form.='<option value="'.$list->cc_no.'">'.$list->cc_name.'</option>';
                }
                $form.='</select>';
                $form.='<script>';
                foreach($JournalEntry as $JE){
                    if($JE->other_no==$ID){
                    $form.='document.getElementById(\'CostCenterSalesReceiptEdit\').value="'.$JE->je_cost_center.'";';
                    }
                }
                $form.='</script>';
                $form.='</div>';
                $form.='<div class="col-md-2 p-0">';
                $form.='<p>Find Invoice No</p>';
                $form.='<input type="text" id="invoiceno_sr" readonly name="invoiceno_sr" placeholder="Find by Invoice No">';
                $form.='</div>';
                $form.='<div class="col-md-4 p-0 d-inline-flex center-content">';
                $form.='<h4 class="mr-2">BALANCE DUE: </h4>';
                $form.='<h3 id="big_sales_receipt_balance">PHP '.number_format($SalesTransaction[0]->opening_balance).'</h3>';
                $form.='</div>';
            $form.='</div>';//first div
            $form.='<div class="col-md-12 p-0 ">';
            $form.='<div class="col-md-4 p-0 pr-3">';
            $form.='<p>Billing Address</p>';
            $form.='<input type="text" name="bill_address_edit" id="bill_address_edit" value="'.$SalesTransaction[0]->st_bill_address.'" class="w-100" required>';
            $form.='</div>';
            $form.='<div class="col-md-2 p-0 pr-3">';
            $form.='<p>TIN No.</p>';
            $form.='<input type="text" name="tin_no_sr" id="tin_no_sr" value="'.$SalesTransaction[0]->tin_no.'" class="w-100" readonly>';
            $form.='</div>';
            $form.='<div class="col-md-2 p-0 pr-3">';
            $form.='<p>Business Style</p>';
            $form.='<input type="text" name="business_style_sr" value="'.$SalesTransaction[0]->business_style.'" id="business_style_sr" class="w-100" readonly>';
            $form.='</div>';

            $form.='</div>';
            
            $form.='<div class="col-md-12 p-0 " style="margin-bottom:20px;">';
            $form.='<div class="col-md-3 p-0 pr-3">';
            $form.='<p>Payment Method</p>';
            $form.='<input class="w-100" list="paymentmethod" value="'.$st_sales_receipts[0]->st_p_method.'" name="payment_method_edit" id="payment_method_edit" required>';
            $form.='<datalist id="paymentmethod">';
            $form.='<option>Cash</option>';
            $form.='<option>Cheque</option>';
            $form.='<option>Debit card</option>';
            $form.='<option>Credit card</option>';
            $form.='</datalist>';
            $form.='</div>';
            $form.='<div class="col-md-3 p-0 pr-3">';
            $form.='<p>Reference no.</p>';
            $form.='<input class="w-100" value="'.$st_sales_receipts[0]->st_p_reference_no.'" name="reference_no_edit" id="reference_no_edit" required>';
            $form.='</div>';
            $form.='<div class="col-md-3 p-0 pr-3">';
            $form.='<p>Deposit to</p>';
            $form.='<input id="sales_receipt_deposit_to_edit" list="deposit_to" type="text" name="deposit_to_edit" value="'.$st_sales_receipts[0]->st_p_deposit_to.'" class="w-100" required>';
            $form.='<datalist id="deposit_to">';
            $form.='<option>Cash and equivalents</option>';
            $form.='<option>Allowance for bad debts</option>';
            $form.='<option>Available for sale assets (short-term)</option>';
            $form.='<option>Inventory</option>';
            $form.='<option>Inventory asset</option>';
            $form.='<option>Prepaid expenses</option>';
            $form.='<option>Uncategorized assets</option>';
            $form.='</datalist>';
            $form.='</div>';
            
            $form.='</div>';

            $form.='<table id="sales_receipt_table_edit" class="table table-bordered table-responsive-md table-striped text-left font14">';
            $form.='<tr>';
            $form.='<th class="text-left">#</th>';
            $form.='<th class="text-left">PRODUCT/SERVICE</th>';
            $form.='<th class="text-left">DESCRIPTION</th>';
            $form.='<th class="text-center">QTY</th>';
            $form.='<th class="text-left">RATE</th>';
            $form.='<th class="text-left">AMOUNT</th>';
            $form.='<th class="text-center"></th>';
            $form.='</tr>';
            $ctrcount=1;
            foreach($st_invoice as $st){
            if($st->st_s_no==$request->id){
            $form.='<tr class="sales_receipt_lines_edit" id="sales_receipt_line_edit'.$ctrcount.'">';
            $form.='<td class="pt-3-half" id="number_tag_edit" contenteditable="false">'.$ctrcount.'</td>';
            $form.='<td class="pt-3-half">';  
            $form.='<select name="sales_receipt_EditProductName'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\'),GetProductRate(\''.$ctrcount.'\')" style="border:0; width:100%;" class="sales_receipt_data_edit product_select" id="select_product_name_edit'.$ctrcount.'">';
            foreach($products_and_services as $prod){
                if($prod->product_id==$st->st_s_product){
                    $form.='<option value="'.$prod->product_id.'">'.$prod->product_name.'</option>';
                }
                
            }
            foreach($products_and_services as $product){
            $form.='<option value="'.$product->product_id.'.">'.$product->product_name.'</option>';
                
            }

            $form.='</select>';
              
            $form.='</td>';
            $form.='<td class="pt-3-half">';  
            $form.='<input type="hidden" name="sales_receipt_EditST_I_id'.$ctrcount.'" class="sales_receipt_data_edit product_description" id="sales_receipt_EditST_I_id'.$ctrcount.'" value="'.$st->st_s_id.'" style="border:0;">';  
            $form.='<input name="sales_receipt_EditProductDesc'.$ctrcount.'" class="sales_receipt_data_edit product_description" id="select_product_description_edit'.$ctrcount.'" value="'.$st->st_s_desc.'" style="border:0;">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='<input type="number" name="sales_receipt_EditProductQty'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\')" class="sales_receipt_data_edit product_qty" onclick="this.select();" value="'.$st->st_s_qty.'" id="product_qty_edit'.$ctrcount.'" style="border:0; text-align:center;" value="1">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='<input name="sales_receipt_EditProductRate'.$ctrcount.'" class="sales_receipt_data_edit product_rate" onchange="GetProductAll(\''.$ctrcount.'\')" id="select_product_rate_edit'.$ctrcount.'" readonly title="'.$st->st_s_rate.'" value="'.number_format($st->st_s_rate,2).'" style="border:0;">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half product_total_edit" id="total_amount_edit'.$ctrcount.'" title="'.$st->st_s_total.'">'.number_format($st->st_s_total,2);
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='';  
            $form.='</td>';
            $form.='</tr>'; 
            $ctrcount++; 
            }
            }
            $form.='</table>';
            $form.='<input type="number" id="columncounteditsales_receipt_" name="columncounteditsales_receipt_" value="'.$ctrcount.'" hidden>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="float-left">';
            $form.='<div class="d-inline-flex">';
            $form.='<button type="button" class="btn btn-outline-dark rounded mr-1 font14" onclick="addlinesales_receipt_edit()" id="add_lines_invoic_edite">Add Lines</button>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="float-right mr-5">';
            $form.='<div class="d-inline-flex mr-4">';
            $form.='<p class="mb-0 pr-4 text-dark font-weight-bold">TOTAL</p>';
            $form.='<p id="sales_receipt_total_edit" class="mb-0 text-dark font-weight-bold">PHP 0.00</p>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="float-right mr-5">';
            $form.='<div class="d-inline-flex mr-4">';
            $form.='<p class="pr-4 text-dark font-weight-bold">BALANCE DUE</p>';
            $form.='<p id="sales_receipt_balance_edit" class="text-dark font-weight-bold">PHP '.number_format($SalesTransaction[0]->opening_balance).'</p>';
            $form.='</div>';
            $form.=' </div>';
            $form.='</div>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="float-right mr-5">';
            $form.='<div class="d-inline-flex mr-4">';
            $form.='<p class="pr-4 text-dark font-weight-bold">Amount Received</p>';
            $form.='<input type="number" name="sales_receipt_amount_received_edit"  id="sales_receipt_amount_received_edit" placeholder="0.00" value="'.$st_sales_receipts[0]->st_p_amount.'" required>';
            $form.='</div>';
            $form.=' </div>';
            $form.='</div>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="col-md-6 pl-0">';
            $form.='<p>Message Displayed on Sales Receipt</p>';
            $form.='<textarea rows="3" class="w-100" name="note_edit" id="note_edit" >'.$SalesTransaction[0]->st_note.'</textarea>';
            $form.='</div>';
            $form.='<div class="col-md-6 pr-0">';
            $form.='<p>Message Displayed on Statement</p>';
            $form.='<textarea rows="3" class="w-100" name="memo_edit" id="memo_edit">'.$SalesTransaction[0]->st_memo.'</textarea>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="col-md-6 m-0 p-0 mt-3" style="display:none;">';
            $form.='<div class="d-inline-flex">';
            $form.='<p class="fa fa-paperclip"></p>';
            $form.='<p class="p-0 ml-1">Maximum Size: 20MB</p>';
            $form.='</div>';
            $form.='<div class="input-group mb-3 p-0">';
            $form.='<div class="custom-file">';
            $form.='<input type="file" name="attachment_edit" class="custom-file-input" id="inputGroupFile01_edit" aria-describedby="inputGroupFileAddon01">';
            $form.='<label class="custom-file-label bg-transparent" for="inputGroupFile01">Choose file</label>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="modal-footer">';
            $form.='<button type="button" class="btn btn-secondary rounded" data-dismiss="modal">Cancel</button>';
            $form.='<button id="sales_receipt_add_edit" class="btn btn-success rounded" type="submit">Save</button>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</form>';
            return $form;

        
        }
        else if($Type=="Credit Note"){
            $SalesTransaction= DB::connection('mysql')->select("SELECT * FROM sales_transaction
            JOIN customers ON sales_transaction.st_customer_id=customers.customer_id WHERE st_no='".$request->id."'");
            //print_r($SalesTransaction);
            $st_credit_notes= DB::connection('mysql')->select("SELECT * FROM st_credit_notes");
            $products_and_services = ProductsAndServices::orderBy('product_name', 'ASC')->get();
            $form="";
            $form.='<form action="update_credit_note_edit" class="form-horizontal" method="POST" id="edit_invoice_form"  autocomplete="off">';
            $form.=csrf_field();
            $form.='<input id="transaction_id_edit" name="transaction_id_edit" value="'.$ID.'" hidden>';
            $form.='<input id="transaction_type_edit" name="transaction_type_edit" value="Credit Note" hidden>';
            $form.='<input id="product_count_edit" name="product_count_edit" value="0" hidden>';
            $form.='<input type="text" id="total_balance_edit" step="0.01" name="total_balance_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_estimate_edit" name="sales_transaction_number_estimate_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_delayed_charge_edit" name="sales_transaction_number_delayed_charge_edit" value="0" hidden>';
            $form.='<input type="number" id="sales_transaction_number_delayed_credit_edit" name="sales_transaction_number_delayed_credit_edit" value="0" hidden>';
            $form.='<div class="modal-dialog modal-full" role="document" style="min-width: 100%; margin: 0;">';
            $form.='<div class="modal-content" style="min-height: 100vh;">';
            $form.='<div class="modal-header">';
            $form.='<h5 class="modal-title">Credit Note</h5>';
            $form.='<button type="button" class="close" data-dismiss="modal" aria-label="Close">';
            $form.='<span aria-hidden="true"></span>';
            $form.='</button>';
            $form.='</div>';
            $form.='<div class="modal-body p-4" id="result_edit">';
            $form.='<div class="col-md-12 p-0 mb-4">';
            $form.='<div class="col-md-12 p-0" style="margin-bottom:20px;">';
                $form.='<div class="col-md-2 p-0 pr-3">';
                $form.='<p>Credit Note No</p>';
                $form.='<input type="text" name="" id="" class="w-100" value="'.$ID.'" readonly>';
                $form.='</div>';
                $form.='<div class="col-md-2 p-0 pr-3">';
                $form.='<p>Credit Note Date</p>';
                $form.='<input id="credit_note_date_edit" '.($userpos!="CEO"? 'readonly' : '').' type="date" name="date_edit" value="'.$SalesTransaction[0]->st_date.'" class="w-100" required>';
                $form.='</div>';
                $form.='<div class="col-md-4 p-0 d-inline-flex center-content">';
                $form.='<h4 class="mr-2">BALANCE DUE: </h4>';
                $form.='<h3 id="big_credit_note_balance">PHP '.number_format($SalesTransaction[0]->opening_balance).'</h3>';
                $form.='</div>';
            $form.='</div>';
            $form.='<div class="my-3 p-0">';
                $form.='<div class="col-md-3 p-0 pr-3">';
                $form.='<p>Customer</p>';
                $form.='<select id="credit_note_customer_edit" type="text" name="customer_edit" class="w-100" required>';
                $form.='<option value="'.$SalesTransaction[0]->customer_id.'">'.$SalesTransaction[0]->display_name.'</option>';    
                $form.='</select>';
                $form.='</div>';
                $form.='<div class="col-md-3 p-0 pr-3" style="display:none;">';
                $form.='<p>Email</p>';
                $form.='<input type="text" id="email_edit" value="'.$SalesTransaction[0]->st_email.'" name="email_edit" placeholder="Email (Separate emails with a comma)" class="w-100"><br>';
                    $form.='<div class="float-left">';
                    $form.='<input type="checkbox" name="send_later_edit" value="yes">Send Now';
                    $form.='</div>';
                    $form.='<div class="float-right">';
                    $form.='<input type="checkbox" name="generate_pdf_edit" >Generate PDF';
                    $form.='</div>';
                $form.='</div>';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<div class="col-md-2 p-0 pr-3" style="display:none;">';
                }else{
                    $form.='<div class="col-md-2 p-0 pr-3" style="">';
                }
                
                $form.='<p>Cost Center</p>';
                if(!empty($numbering) && $numbering->use_cost_center=="Off"){
                    $form.='<select name="CostCenterCreditNoteEdit" id="CostCenterCreditNoteEdit" style="width:90%;" >';
                }else{
                    $form.='<select name="CostCenterCreditNoteEdit" id="CostCenterCreditNoteEdit" style="width:90%;" required>';
                }
                
                $form.='<option value="">--Select Cost Center--</option>';
                foreach ($cost_center_list as $list){
                    $form.='<option value="'.$list->cc_no.'">'.$list->cc_name.'</option>';
                }
                $form.='</select>';
                $form.='<script>';
                foreach($JournalEntry as $JE){
                    if($JE->other_no==$ID){
                    $form.='document.getElementById(\'CostCenterCreditNoteEdit\').value="'.$JE->je_cost_center.'";';
                    }
                }
                $form.='</script>';
                $form.='</div>';
                
            $form.='</div>';//first div
            $form.='<div class="col-md-12 p-0 " style="margin-bottom:20px;">';
            $form.='<div class="col-md-4 p-0 pr-3">';
            $form.='<p>Billing Address</p>';
            $form.='<input type="text" name="bill_address_edit" id="bill_address_edit" value="'.$SalesTransaction[0]->st_bill_address.'" class="w-100" required>';
            $form.='</div>';
            
            

            
            
            $form.='</div>';
            $form.='<table id="credit_note_table_edit" class="table table-bordered table-responsive-md table-striped text-left font14">';
            $form.='<tr>';
            $form.='<th class="text-left">#</th>';
            $form.='<th class="text-left">PRODUCT/SERVICE</th>';
            $form.='<th class="text-left">DESCRIPTION</th>';
            $form.='<th class="text-center">QTY</th>';
            $form.='<th class="text-left">RATE</th>';
            $form.='<th class="text-left">AMOUNT</th>';
            $form.='<th class="text-center"></th>';
            $form.='</tr>';
            $ctrcount=1;
            foreach($st_credit_notes as $st){
            if($st->st_cn_no==$request->id){
            $form.='<tr class="credit_note_lines_edit" id="credit_note_line_edit'.$ctrcount.'">';
            $form.='<td class="pt-3-half" id="number_tag_edit" contenteditable="false">'.$ctrcount.'</td>';
            $form.='<td class="pt-3-half">';  
            $form.='<select name="credit_note_EditProductName'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\'),GetProductRate(\''.$ctrcount.'\')" style="border:0; width:100%;" class="invoice_data_edit product_select" id="select_product_name_edit'.$ctrcount.'">';
            foreach($products_and_services as $prod){
                if($prod->product_id==$st->st_cn_product){
                    $form.='<option value="'.$prod->product_id.'">'.$prod->product_name.'</option>';
                }
                
            }
            foreach($products_and_services as $product){
            $form.='<option value="'.$product->product_id.'.">'.$product->product_name.'</option>';
                
            }

            $form.='</select>';
              
            $form.='</td>';
            $form.='<td class="pt-3-half">';  
            $form.='<input type="hidden" name="credit_note_EditST_I_id'.$ctrcount.'" class="credit_note_data_edit product_description" id="credit_note_EditST_I_id'.$ctrcount.'" value="'.$st->st_cn_id.'" style="border:0;">';  
            $form.='<input name="credit_note_EditProductDesc'.$ctrcount.'" class="credit_note_data_edit product_description" id="select_product_description_edit'.$ctrcount.'" value="'.$st->st_cn_desc.'" style="border:0;">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='<input type="number" name="credit_note_EditProductQty'.$ctrcount.'" onchange="GetProductAll(\''.$ctrcount.'\')" class="credit_note_data_edit product_qty" onclick="this.select();" value="'.$st->st_cn_qty.'" id="product_qty_edit'.$ctrcount.'" style="border:0; text-align:center;" value="1">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='<input name="credit_note_EditProductRate'.$ctrcount.'" class="credit_note_data_edit product_rate" onchange="GetProductAll(\''.$ctrcount.'\')" id="select_product_rate_edit'.$ctrcount.'" readonly title="'.$st->st_cn_rate.'" value="'.number_format($st->st_cn_rate,2).'" style="border:0;">';  
            $form.='</td>';  
            $form.='<td class="pt-3-half product_total_edit" id="total_amount_edit'.$ctrcount.'" title="'.$st->st_cn_total.'">'.number_format($st->st_cn_total,2);
            $form.='</td>';  
            $form.='<td class="pt-3-half">';  
            $form.='';  
            $form.='</td>';
            $form.='</tr>'; 
            $ctrcount++; 
            }
            }
            $form.='</table>';
            $form.='<input type="number" id="columncounteditcredit_note_" name="columncounteditcredit_note_" value="'.$ctrcount.'" hidden>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="float-left">';
            $form.='<div class="d-inline-flex">';
            $form.='<button type="button" class="btn btn-outline-dark rounded mr-1 font14" onclick="addlinecredit_note_edit()" id="add_lines_invoic_edite">Add Lines</button>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="float-right mr-5">';
            $form.='<div class="d-inline-flex mr-4">';
            $form.='<p class="mb-0 pr-4 text-dark font-weight-bold">TOTAL</p>';
            $form.='<p id="credit_note_total_edit" class="mb-0 text-dark font-weight-bold">PHP 0.00</p>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="float-right mr-5">';
            $form.='<div class="d-inline-flex mr-4">';
            $form.='<p class="pr-4 text-dark font-weight-bold">BALANCE DUE</p>';
            $form.='<p id="credit_note_balance_edit" class="text-dark font-weight-bold">PHP '.number_format($SalesTransaction[0]->opening_balance).'</p>';
            $form.='</div>';
            $form.=' </div>';
            $form.='</div>';
            $form.='<div class="col-md-12 p-0">';
            $form.='<div class="col-md-6 pl-0">';
            $form.='<p>Message Displayed on Credit Note</p>';
            $form.='<textarea rows="3" class="w-100" name="note_edit" id="note_edit" >'.$SalesTransaction[0]->st_note.'</textarea>';
            $form.='</div>';
            $form.='<div class="col-md-6 pr-0">';
            $form.='<p>Memo</p>';
            $form.='<textarea rows="3" class="w-100" name="memo_edit" id="memo_edit" >'.$SalesTransaction[0]->st_memo.'</textarea>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="col-md-6 m-0 p-0 mt-3" style="display:none;">';
            $form.='<div class="d-inline-flex">';
            $form.='<p class="fa fa-paperclip"></p>';
            $form.='<p class="p-0 ml-1">Maximum Size: 20MB</p>';
            $form.='</div>';
            $form.='<div class="input-group mb-3 p-0">';
            $form.='<div class="custom-file">';
            $form.='<input type="file" name="attachment_edit" class="custom-file-input" id="inputGroupFile01_edit" aria-describedby="inputGroupFileAddon01">';
            $form.='<label class="custom-file-label bg-transparent" for="inputGroupFile01">Choose file</label>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='<div class="modal-footer">';
            $form.='<button type="button" class="btn btn-secondary rounded" data-dismiss="modal">Cancel</button>';
            $form.='<button id="credit_note_add_edit" class="btn btn-success rounded" type="submit">Save</button>';
            $form.='</div>';
            $form.='</div>';
            $form.='</div>';
            $form.='</form>';
            return $form;

        } 
    }
    public function update_invoice_edit2(Request $request){
        

        $sales_transactionedit =SalesTransactionEdit::where([
            ['st_no','=',$request->id],
            ['st_type','=','Invoice'],
            ['st_location','=',$request->location],
            ['st_invoice_type','=',$request->type]
        ])->first();
        $sales_transaction =SalesTransaction::where([
            ['st_no','=',$request->id],
            ['st_type','=','Invoice'],
            ['st_location','=',$request->location],
            ['st_invoice_type','=',$request->type]
        ])->first();
        //return $sales_transaction;
        $debit_account="";
        $credit_account="";
        if(!empty($sales_transaction)){
            $sales_transaction->st_date = $sales_transactionedit->st_date;
            $sales_transaction->st_type = $sales_transactionedit->st_type;
            $sales_transaction->st_term = $sales_transactionedit->st_term;
            $sales_transaction->st_customer_id = $sales_transactionedit->st_customer_id;
            $sales_transaction->st_due_date = $sales_transactionedit->st_due_date;
            $sales_transaction->st_email = $sales_transactionedit->st_email;
            $sales_transaction->st_send_later = $sales_transactionedit->st_send_later;
            $sales_transaction->st_bill_address = $sales_transactionedit->st_bill_address;
            $sales_transaction->st_note = $sales_transactionedit->st_note;
            $sales_transaction->st_memo = $sales_transactionedit->st_memo;
            $sales_transaction->st_balance = $sales_transactionedit->st_balance;
            $sales_transaction->st_location = $sales_transactionedit->st_location;
            $sales_transaction->st_invoice_type = $sales_transactionedit->st_invoice_type;
            $sales_transaction->st_invoice_job_order = $sales_transactionedit->st_invoice_job_order;
            $sales_transaction->st_invoice_work_no = $sales_transactionedit->st_invoice_work_no;
            $sales_transaction->st_debit_account = $sales_transactionedit->st_debit_account;
            $sales_transaction->st_credit_account = $sales_transactionedit->st_credit_account;
            $sales_transaction->save();
            
            $csasd="";
            $value;
            $customer = Customers::find($sales_transactionedit->st_customer_id);
            $customer_name="";
            if ($customer->display_name!=""){
                $customer_name=$customer->display_name;
            }else{
                if ($customer->company_name!=""){
                    $customer_name=$customer->company_name;
                }else{
                    $customer_name=$customer->f_name." ".$customer->l_name;
                }
            }
            // StInvoice::where([
            //     ['st_i_no','=',$request->id],
            //     ['st_p_location','=',$request->location],
            //     ['st_p_invoice_type','=',$request->type]
            // ])->delete();
            $journalforcostcenter=DB::table('journal_entries')->where('other_no', $request->id)->get();
            
            //$st_invoiceedit =StInvoiceEdit::find($request->id);
            $st_invoiceedit=DB::table('st_invoice_edit')->where([
                ['st_i_no','=',$request->id],
                ['st_p_location','=',$request->location],
                ['st_p_invoice_type','=',$request->type],
                ['edit_status','=','0']
            ])->get();
            $c=0;
            DB::table('journal_entries')->where([
                ['other_no', $request->id],
                ['je_invoice_location_and_type','=',$request->location." ".$request->type]
            ])->update([
                'remark'=>'NULLED'
            ]);
            $je_id_no=0;
            foreach($st_invoiceedit as $st_iss){
                $Costtttsasdasd="";
                $JJJJNNNNOOO="";
                foreach($journalforcostcenter as $sacxzxcasd){
                    $JJJJNNNNOOO=$sacxzxcasd->je_no;
                    $Costtttsasdasd=$sacxzxcasd->je_cost_center;
                }
                $st_invoice =StInvoice::where([
                    ['st_i_no','=',$request->id],
                    ['st_p_location','=',$request->location],
                    ['st_p_invoice_type','=',$request->type],
                    ['st_i_item_no','=',$st_iss->st_i_item_no]
                ])->first();
                if(empty($st_invoice)){
                    $st_invoice = new StInvoice;
                }
                $st_invoice->st_i_no = $request->id;
                $st_invoice->st_i_item_no = $st_iss->st_i_item_no;
                $st_invoice->st_i_product = $st_iss->st_i_product;
                $st_invoice->st_i_desc = $st_iss->st_i_desc;
                $st_invoice->st_i_qty = $st_iss->st_i_qty;
                
                $st_invoice->st_i_rate = $st_iss->st_i_rate;
                $st_invoice->st_i_total = $st_iss->st_i_total;
                $st_invoice->st_p_location = $st_iss->st_p_location;
                $st_invoice->st_p_invoice_type = $st_iss->st_p_invoice_type;
                $st_invoice->st_p_cost_center = $st_iss->st_p_cost_center;
                $st_invoice->st_p_debit=$st_iss->st_p_debit;
                $st_invoice->st_p_credit=$st_iss->st_p_credit;
                $st_invoice->save();


                $product = ProductsAndServices::find($st_iss->st_i_product);
                $email_array = explode(',', $sales_transactionedit->st_email);

                $value[$c-1] = [
                    'type' => 'Invoice',
                    'name' => $customer_name,
                    'email' => $email_array,
                    'title' => 'INVOICE',
                    'note' => '',
                    'memo' => '',
                    'product_name' => !empty($product)? $product->product_name : '',
                    'product_description' => $st_iss->st_i_desc,
                    'product_quantity' => $st_iss->st_i_qty,
                    'product_rate' => $st_iss->st_i_rate,
                    'product_total' => $st_iss->st_i_total,
                    'credit_total' => $st_iss->st_i_total,
                ];
                $jounalcount=$JJJJNNNNOOO;
                $JDate=$sales_transactionedit->st_date;
                $JNo=$jounalcount;
                $JMemo=$sales_transactionedit->st_memo;
                $account=$st_iss->st_p_debit;
                $debit= $st_iss->st_i_total;
                $credit= "";
                $description=$st_iss->st_i_desc;
                $name=$customer_name;
                
                $je_id_no++;
                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id =$je_id_no ;
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Invoice";
                $journal_entries->je_invoice_location_and_type=$request->location." ".$request->type;
                $journal_entries->je_cost_center=$st_iss->st_p_cost_center;
                $journal_entries->other_no=$request->id;
                $journal_entries->save();

                $JDate=$sales_transactionedit->st_date;
                $JNo=$jounalcount;
                $JMemo=$sales_transactionedit->st_memo;
                $account=$st_iss->st_p_credit;
                $debit= "";
                $credit= $st_iss->st_i_total;
                $description=$st_iss->st_i_desc;
                $name=$customer_name;
                
                $je_id_no++;
                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id = $je_id_no;
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Invoice";
                $journal_entries->je_invoice_location_and_type=$request->location." ".$request->type;
                $journal_entries->other_no=$request->id;
                $journal_entries->je_cost_center=$st_iss->st_p_cost_center;
                $journal_entries->save();
                $c++;
            }
            
            $st_invoiceedit=SalesTransactionEdit::where([
                ['st_no','=',$request->id],
                ['st_location','=',$request->location],
                ['st_invoice_type','=',$request->type]
            ])->first();
            $st_invoiceedit->edit_status = "OK";
            $st_invoiceedit->save();
            DB::table('st_invoice_edit')->where([
                ['st_i_no','=',$request->id],
                ['st_p_location','=',$request->location],
                ['st_p_invoice_type','=',$request->type]
            ])->update([
                'edit_status'=>'OK'
            ]);
            //DB::table('st_invoice_edit')->where('st_i_no', $request->id)->delete();
            //DB::table('sales_transaction_edits')->where('st_no', $request->id)->delete();
        }
        

    
    }
    public function delete_invoice_edit(Request $request){
        DB::table('st_invoice_edit')->where([
            ['st_i_no','=',$request->id],
            ['st_p_location','=',$request->location],
            ['st_p_invoice_type','=',$request->type]
        ])->update([
            'edit_status'=>'OK'
        ]);
        $st_invoiceedit=SalesTransactionEdit::where([
            ['st_no','=',$request->id],
            ['st_location','=',$request->location],
            ['st_invoice_type','=',$request->type]
        ])->first();
        $st_invoiceedit->edit_status = "OK";
        $st_invoiceedit->save();
    }
    public function update_invoice_edit(Request $request){
        
        $transaction_id_edit=$request->transaction_id_edit;
        $customer_edit=$request->customer_edit;
        $email_edit=$request->email_edit;
        $send_later_edit=$request->send_later_edit;
        $generate_pdf_edit=$request->generate_pdf_edit;
        $bill_address_edit=$request->bill_address_edit;
        $term_edit=$request->term_edit;
        $date_edit=$request->date_edit;
        $due_date_edit=$request->due_date_edit;
        $note_edit=$request->note_edit;
        $memo_edit=$request->memo_edit;
        $transaction_type_edit=$request->transaction_type_edit;
        $total_balance_edit=$request->total_balance_edit;
        $st_location=$request->invoice_location_top_edit;
        $st_invoice_type=$request->invoice_type_top_edit;
        
        $sales_transaction =SalesTransactionEdit::find($transaction_id_edit);
        if(empty($sales_transaction)){
            $sales_transaction = new SalesTransactionEdit;
        }
        $sales_transaction->st_no = $transaction_id_edit;
        $sales_transaction->st_date = $date_edit;
        $sales_transaction->st_type = $transaction_type_edit;
        $sales_transaction->st_term = $term_edit;
        $sales_transaction->st_customer_id = $customer_edit;
        $sales_transaction->st_due_date = $due_date_edit;
        $sales_transaction->st_email = $email_edit;
        $sales_transaction->st_send_later = $send_later_edit;
        $sales_transaction->st_bill_address = $bill_address_edit;
        $sales_transaction->st_note = $note_edit;
        $sales_transaction->st_memo = $memo_edit;
        $sales_transaction->st_balance = $total_balance_edit;
        $sales_transaction->st_location = $st_location;
        $sales_transaction->st_invoice_type = $st_invoice_type;
        $sales_transaction->st_invoice_job_order = $request->job_order_invoice_edit;
        $sales_transaction->st_invoice_work_no = $request->job_work_no_edit;
        $sales_transaction->st_debit_account = "";
        $sales_transaction->st_credit_account = "";
        $sales_transaction->edit_status = "0";
        $sales_transaction->save();
        DB::table('st_invoice_edit')->where([
            ['st_i_no','=',$request->transaction_id_edit],
            ['st_p_location','=',$request->invoice_location_top_edit],
            ['st_p_invoice_type','=',$request->invoice_type_top_edit]
        ])->update([
            'edit_status'=>'OK'
        ]);
        $csasd="";
        $value;
        $customer = Customers::find($customer_edit);
        for($c=1;$c<$request->columncounteditinvoice;$c++){
            //$csasd.=$request->input('InvoiceEditProductName'.$c)."<br>";
            if($request->input('InvoiceEditST_I_id'.$c)!=""){
                //update existing entry
                
                $st_invoice =StInvoiceEdit::find($request->input('InvoiceEditST_I_id'.$c));
                if(empty($st_invoice)){
                    $st_invoice = new StInvoiceEdit;
                }
                $st_invoice->st_i_id = $request->input('InvoiceEditST_I_id'.$c);
                $st_invoice->st_i_item_no = $c;
                $st_invoice->st_i_no = $transaction_id_edit;
                $st_invoice->st_i_product = $request->input('InvoiceEditProductName'.$c);
                $st_invoice->st_i_desc = $request->input('InvoiceEditProductDesc'.$c);
                $st_invoice->st_i_qty = $request->input('InvoiceEditProductQty'.$c);
                
                $st_invoice->st_i_rate = preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c));
                $st_invoice->st_i_total = $request->input('InvoiceEditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c));

                $st_invoice->st_p_location = $st_location;
                $st_invoice->st_p_invoice_type = $st_invoice_type;
                $wwe=explode(" - ",$request->input('CostCenterInvoiceEdit'.$c));
                $st_invoice->st_p_cost_center=$wwe[0];
                //$st_invoice->st_p_cost_center = $request->input('CostCenterInvoiceEdit'.$c);
                
                $st_invoice->st_p_debit = $request->input('invoice_account_debit_accountedit'.$c);
                $st_invoice->st_p_credit = $request->input('invoice_account_credit_accountedit'.$c);
                $st_invoice->edit_status ="0" ;
                $st_invoice->save();
                $product = ProductsAndServices::find($request->input('InvoiceEditProductName'.$c));
                $email_array = explode(',', $email_edit);

                $value[$c-1] = [
                    'type' => 'Invoice',
                    'name' => $customer->display_name,
                    'email' => $email_array,
                    'title' => 'INVOICE',
                    'note' => '',
                    'memo' => '',
                    'product_name' => !empty($product)? $product->product_name : '',
                    'product_description' => $request->input('InvoiceEditProductDesc'.$c),
                    'product_quantity' => $request->input('InvoiceEditProductQty'.$c),
                    'product_rate' => preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c)),
                    'product_total' => $request->input('InvoiceEditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c)),
                    'credit_total' => $total_balance_edit,
                ];
                
            }else{
                //insert new entry

                    //$csasd.=$request->input('InvoiceEditProductName'.$c)."<br>";
                    $st_invoice =new StInvoiceEdit;
                    $st_invoice->st_i_no = $transaction_id_edit;
                    $st_invoice->st_i_item_no = $c;
                    $st_invoice->st_i_product = $request->input('InvoiceEditProductName'.$c);
                    $st_invoice->st_i_desc = $request->input('InvoiceEditProductDesc'.$c);
                    $st_invoice->st_i_qty = $request->input('InvoiceEditProductQty'.$c);
                    $st_invoice->st_i_rate = preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c));
                    $st_invoice->st_i_total = $request->input('InvoiceEditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c));
                    $st_invoice->st_p_location = $st_location;
                    $st_invoice->st_p_invoice_type = $st_invoice_type;
                    $wwe=explode(" - ",$request->input('CostCenterInvoiceEdit'.$c));
                    $st_invoice->st_p_cost_center=$wwe[0];
                    $st_invoice->st_p_debit = $request->input('invoice_account_debit_accountedit'.$c);
                    $st_invoice->st_p_credit = $request->input('invoice_account_credit_accountedit'.$c);
                    $st_invoice->edit_status ="0" ;
                    $st_invoice->save();
                    $product = ProductsAndServices::find($request->input('InvoiceEditProductName'.$c));
                    $email_array = explode(',', $email_edit);

                    $value[$c-1] = [
                        'type' => 'Invoice',
                        'name' => $customer->display_name,
                        'email' => $email_array,
                        'title' => 'INVOICE',
                        'note' => '',
                        'memo' => '',
                        'product_name' => !empty($product)? $product->product_name : '',
                        'product_description' => $request->input('InvoiceEditProductDesc'.$c),
                        'product_quantity' => $request->input('InvoiceEditProductQty'.$c),
                        'product_rate' => preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c)),
                        'product_total' => $request->input('InvoiceEditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('InvoiceEditProductRate'.$c)),
                        'credit_total' => $total_balance_edit,
                    ];
               
                
            }
            
        }

        // if($send_later_edit=="yes"){
        //     Mail::send(['text'=>'mail'], $value, function($message) use ($value)
        //     {
        //         $company = Company::first();
        //         $sales = Sales::first();
        //         $expenses = Expenses::first();
        //         $advance = Advance::first();
                
        //         $pdf = PDF::loadView('credit_note_pdf',compact('value', 'company', 'sales','expenses','advance'));
        //         $attachment = $pdf->stream('credit_notice.pdf');
        //         $message->attachData($attachment, 'credit_note.pdf');
    
        //         $message->to($value[0]['email'],'Hello Mr/Mrs '.$value[0]['name'])->subject('This is a Invoice for '.$value[0]['name']);
        //         $message->from('floydignified@gmail.com','Floyd Matabilas');
        //     });
        // }
        // if($generate_pdf_edit=="on"){
        //     set_time_limit(0);
        //     $company = Company::first();
        //     $sales = Sales::first();
        //     $expenses = Expenses::first();
        //     $advance = Advance::first();
        //     $pdf = PDF::loadView('credit_note_pdf',compact('value', 'company', 'sales','expenses','advance'));
        //     return $pdf->download('Invoice.pdf');
        // }
        
            return redirect('Journal_Summary');
    
    }
    public function update_credit_note_edit2(Request $request){
        $sales_transactionedit =SalesTransactionEdit::find($request->id);
        $sales_transaction =SalesTransaction::find($request->id);
        if(!empty($sales_transaction)){
            $sales_transaction->st_date = $sales_transactionedit->st_date;
            $sales_transaction->st_type = $sales_transactionedit->st_type;
            //$sales_transaction->st_term = $sales_transactionedit->st_term;
            $sales_transaction->st_customer_id = $sales_transactionedit->st_customer_id;
            //$sales_transaction->st_due_date = $sales_transactionedit->st_due_date;
            $sales_transaction->st_email = $sales_transactionedit->st_email;
            $sales_transaction->st_send_later = $sales_transactionedit->st_send_later;
            $sales_transaction->st_bill_address = $sales_transactionedit->st_bill_address;
            $sales_transaction->st_note = $sales_transactionedit->st_note;
            $sales_transaction->st_memo = $sales_transactionedit->st_memo;
            $sales_transaction->st_amount_paid = $sales_transactionedit->st_amount_paid;
            $sales_transaction->save();

            
            
            $csasd="";
            $value;
            $customer = Customers::find($sales_transactionedit->st_customer_id);
            DB::table('st_credit_notes')->where('st_cn_no', $request->id)->delete();
            $journalforcostcenter=DB::table('journal_entries')->where('other_no', $request->id)->get();
            $Costtttsasdasd="";
            $JJJJNNNNOOO="";
            foreach($journalforcostcenter as $sacxzxcasd){
                $JJJJNNNNOOO=$sacxzxcasd->je_no;
                $Costtttsasdasd=$sacxzxcasd->je_cost_center;
            }
            
            DB::table('journal_entries')->where('other_no', $request->id)->delete();
            //$st_invoiceedit =StInvoiceEdit::find($request->id);
            $st_invoiceedit=DB::table('st_credit_notes_edits')->where('st_cn_no', $request->id)->get();
            $c=0;

            

            foreach($st_invoiceedit as $st_iss){
                $st_credit_note = new StCreditNote;
                
                $st_credit_note->st_cn_no = $request->id;
                $st_credit_note->st_cn_product = $st_iss->st_cn_product;
                $st_credit_note->st_cn_desc = $st_iss->st_cn_desc;
                $st_credit_note->st_cn_qty = $st_iss->st_cn_qty;
                
                $st_credit_note->st_cn_rate = $st_iss->st_cn_rate;
                $st_credit_note->st_cn_total = $st_iss->st_cn_total;
                $st_credit_note->save();
                $product = ProductsAndServices::find($st_iss->st_cn_product);
                $email_array = explode(',', $sales_transactionedit->st_email);

                $value[$c-1] = [
                    'type' => 'Credit Note',
                    'name' => $customer->display_name,
                    'email' => $email_array,
                    'title' => 'CREDIT NOTE',
                    'note' => '',
                    'memo' => '',
                    'product_name' =>!empty($product)? $product->product_name : '',
                    'product_description' => $st_iss->st_cn_desc,
                    'product_quantity' => $st_iss->st_cn_qty,
                    'product_rate' => $st_iss->st_cn_rate,
                    'product_total' => $st_iss->st_cn_total,
                    'credit_total' => $st_iss->st_cn_total,
                ];
                
                $jounalcount=$JJJJNNNNOOO;
                $JDate=$sales_transactionedit->st_date;
                $JNo=$jounalcount;
                $JMemo=$sales_transactionedit->st_memo;
                $account="2";
                $debit= $st_iss->st_cn_total;
                $credit= "";
                $description=$st_iss->st_cn_desc;
                $name=$customer->display_name;
                
                
                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id = "1";
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Credit Note";
                $journal_entries->je_cost_center=$Costtttsasdasd;
                $journal_entries->other_no=$request->id;
                $journal_entries->save();

                $JDate=$sales_transactionedit->st_date;
                $JNo=$jounalcount;
                $JMemo=$sales_transactionedit->st_memo;
                $account="4";
                $debit= "";
                $credit= $st_iss->st_cn_total;
                $description=$st_iss->st_cn_desc;
                $name=$customer->display_name;
                

                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id = "2";
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Credit Note";
                $journal_entries->other_no=$request->id;
                $journal_entries->je_cost_center=$Costtttsasdasd;
                $journal_entries->save();
                $c++;
            }
            if($sales_transactionedit->st_send_later=="yes"){
                Mail::send(['text'=>'mail'], $value, function($message) use ($value)
                {
                    $company = Company::first();
                    $sales = Sales::first();
                    $expenses = Expenses::first();
                    $advance = Advance::first();
                    
                    $pdf = PDF::loadView('credit_note_pdf',compact('value', 'company', 'sales','expenses','advance'));
                    $attachment = $pdf->stream('credit_notice.pdf');
                    $message->attachData($attachment, 'credit_note.pdf');
        
                    $message->to($value[0]['email'],'Hello Mr/Mrs '.$value[0]['name'])->subject('This is a Invoice for '.$value[0]['name']);
                    $message->from('floydignified@gmail.com','Floyd Matabilas');
                });
            }
            
            DB::table('st_credit_notes_edits')->where('st_cn_no', $request->id)->delete();
            DB::table('sales_transaction_edits')->where('st_no', $request->id)->delete();
        }
    }
    public function delete_credit_note_edit(Request $request){
        DB::table('st_credit_notes_edits')->where('st_cn_no', $request->id)->delete();
        DB::table('sales_transaction_edits')->where('st_no', $request->id)->delete();
    }
    public function update_credit_note_edit(Request $request){
        $transaction_id_edit=$request->transaction_id_edit;
        $customer_edit=$request->customer_edit;
        $email_edit=$request->email_edit;
        $send_later_edit=$request->send_later_edit;
        $bill_address_edit=$request->bill_address_edit;
        //$term_edit=$request->term_edit;
        $date_edit=$request->date_edit;
        //$due_date_edit=$request->due_date_edit;
        $note_edit=$request->note_edit;
        $memo_edit=$request->memo_edit;
        $transaction_type_edit=$request->transaction_type_edit;
        $total_balance_edit=$request->total_balance_edit;

        $sales_transaction =SalesTransactionEdit::find($transaction_id_edit);
        if(empty($sales_transaction)){
            $sales_transaction = new SalesTransactionEdit;
        }
        $sales_transaction->st_no = $transaction_id_edit;
        $sales_transaction->st_date = $date_edit;
        $sales_transaction->st_type = $transaction_type_edit;
        //$sales_transaction->st_term = $term_edit;
        $sales_transaction->st_customer_id = $customer_edit;
        //$sales_transaction->st_due_date = $due_date_edit;
        $sales_transaction->st_email = $email_edit;
        $sales_transaction->st_send_later = $send_later_edit;
        $sales_transaction->st_bill_address = $bill_address_edit;
        $sales_transaction->st_note = $note_edit;
        $sales_transaction->st_memo = $memo_edit;
        $sales_transaction->st_amount_paid = -$total_balance_edit;
        $sales_transaction->save();
        $customer = new Customers;
        $customer = Customers::find($customer_edit);
        $csasd="";
        $value;
        
        for($c=1;$c<=$request->columncounteditcredit_note_;$c++){
            if($request->input('credit_note_EditST_I_id'.$c)!=""){
                //update existing entry
                if($request->input('credit_note_EditProductName'.$c)!=""){
                    $st_credit_note =StCreditNoteEdit::find($request->input('credit_note_EditST_I_id'.$c));
                    if(empty($st_credit_note)){
                        $st_credit_note = new StCreditNoteEdit;
                    }
                    $st_credit_note->st_cn_no = $request->input('credit_note_EditST_I_id'.$c);
                    $st_credit_note->st_cn_product = $request->input('credit_note_EditProductName'.$c);
                    $st_credit_note->st_cn_desc = $request->input('credit_note_EditProductDesc'.$c);
                    $st_credit_note->st_cn_qty = $request->input('credit_note_EditProductQty'.$c);
                    
                    $st_credit_note->st_cn_rate = preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c));
                    $st_credit_note->st_cn_total = $request->input('credit_note_EditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c));
                    $st_credit_note->save();
                    $product = ProductsAndServices::find($request->input('credit_note_EditProductName'.$c));
                    $email_array = explode(',', $email_edit);

                    $value[$c-1] = [
                        'type' => 'Credit Note',
                        'name' => $customer->display_name,
                        'email' => $email_array,
                        'title' => 'CREDIT NOTE',
                        'note' => '',
                        'memo' => '',
                        'product_name' =>!empty($product)? $product->product_name : '',
                        'product_description' => $request->input('credit_note_EditProductDesc'.$c),
                        'product_quantity' => $request->input('credit_note_EditProductQty'.$c),
                        'product_rate' => preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c)),
                        'product_total' => $request->input('credit_note_EditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c)),
                        'credit_total' => -$total_balance_edit,
                    ];
                }
            }else{
                if($request->input('credit_note_EditProductName'.$c)!=""){
                    $st_credit_note =new StCreditNoteEdit;
                    $st_credit_note->st_cn_no = $transaction_id_edit;
                    $st_credit_note->st_cn_product = $request->input('credit_note_EditProductName'.$c);
                    $st_credit_note->st_cn_desc = $request->input('credit_note_EditProductDesc'.$c);
                    $st_credit_note->st_cn_qty = $request->input('credit_note_EditProductQty'.$c);
                    $st_credit_note->st_cn_rate = preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c));
                    $st_credit_note->st_cn_total = $request->input('credit_note_EditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c));
                    $st_credit_note->save();
                    $product = ProductsAndServices::find($request->input('credit_note_EditProductName'.$c));
                    $email_array = explode(',', $email_edit);

                    $value[$c-1] = [
                        'type' => 'Credit Note',
                        'name' => $customer->display_name,
                        'email' => $email_array,
                        'title' => 'CREDIT NOTE',
                        'note' => '',
                        'memo' => '',
                        'product_name' => !empty($product)? $product->product_name : '',
                        'product_description' => $request->input('credit_note_EditProductDesc'.$c),
                        'product_quantity' => $request->input('credit_note_EditProductQty'.$c),
                        'product_rate' => preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c)),
                        'product_total' => $request->input('credit_note_EditProductQty'.$c) * preg_replace("/[^0-9\.]/", "", $request->input('credit_note_EditProductRate'.$c)),
                        'credit_total' => -$total_balance_edit,
                    ];
                }

            }
            


        }
        if($send_later_edit=="yes"){
            Mail::send(['text'=>'mail'], $value, function($message) use ($value)
            {
                $company = Company::first();
                $sales = Sales::first();
                $expenses = Expenses::first();
                $advance = Advance::first();
                
                $pdf = PDF::loadView('credit_note_pdf',compact('value', 'company', 'sales','expenses','advance'));
                $attachment = $pdf->stream('credit_notice.pdf');
                $message->attachData($attachment, 'credit_note.pdf');
    
                $message->to($value[0]['email'],'Hello Mr/Mrs '.$value[0]['name'])->subject('This is a credit note for '.$value[0]['name']);
                $message->from('floydignified@gmail.com','Floyd Matabilas');
            });
        } 
        
        return redirect('Journal_Summary');
    }

    public function update_sales_receipt_edit(Request $request){
        
        $transaction_id_edit=$request->transaction_id_edit;
        $customer_edit=$request->customer_edit;
        $email_edit=$request->email_edit;
        $send_later_edit=$request->send_later_edit;
        $bill_address_edit=$request->bill_address_edit;
        //$term_edit=$request->term_edit;
        $date_edit=$request->date_edit;
        //$due_date_edit=$request->due_date_edit;
        $payment_method_edit=$request->payment_method_edit;
        $reference_no_edit=$request->reference_no_edit;
        $deposit_to_edit=$request->deposit_to_edit;
        $note_edit=$request->note_edit;
        $memo_edit=$request->memo_edit;
        $transaction_type_edit=$request->transaction_type_edit;
        $total_balance_edit=$request->total_balance_edit;
        $sales_receipt_amount_received_edit=$request->sales_receipt_amount_received_edit;
        
        $sales_transaction =SalesTransaction::find($transaction_id_edit);
        $sales_transaction->st_date = $date_edit;
        $sales_transaction->st_type = $transaction_type_edit;
        $sales_transaction->st_customer_id = $customer_edit;
        $sales_transaction->st_email = $email_edit;
        $sales_transaction->st_send_later = $send_later_edit;
        $sales_transaction->st_bill_address = $bill_address_edit;
        $sales_transaction->st_note = $note_edit;
        $sales_transaction->st_memo = $memo_edit;
        $sales_transaction->save();
        
        $customer = new Customers;
        $customer = Customers::find($customer_edit);
        $AuditLog= new AuditLog;
        $AuditLogcount=AuditLog::count()+1;
        $userid = Auth::user()->id;
        $username = Auth::user()->name;
        $eventlog="Edited Sales Receipt No.".$transaction_id_edit;
        $AuditLog->log_id=$AuditLogcount;
        $AuditLog->log_user_id=$username;
        $AuditLog->log_event=$eventlog;
        $AuditLog->log_name=$customer->f_name." ".$customer->l_name;
        $AuditLog->log_transaction_date=$date_edit;
        $AuditLog->log_amount=$sales_receipt_amount_received_edit;
        $AuditLog->save();
        $csasd="";
        $value;
        for($c=1;$c<=$request->columncounteditsales_receipt_;$c++){
            if($request->input('sales_receipt_EditST_I_id'.$c)!=""){
                if($request->input('sales_receipt_EditProductName'.$c)!=""){
                    $st_sales_receipt =StSalesReceipt::find($request->input('sales_receipt_EditST_I_id'.$c));
                    //$st_sales_receipt->st_s_no = $transaction_id_edit;
                    $st_sales_receipt->st_s_product = $request->input('sales_receipt_EditProductName'.$c);
                    $st_sales_receipt->st_s_desc = $request->input('sales_receipt_EditProductDesc'.$c);
                    $st_sales_receipt->st_s_qty = $request->input('sales_receipt_EditProductQty'.$c);
                   
                    $st_sales_receipt->st_s_rate =  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                    $st_sales_receipt->st_s_total = $request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                    $st_sales_receipt->st_p_method = $payment_method_edit;
                    $st_sales_receipt->st_p_reference_no = $reference_no_edit;
                    $st_sales_receipt->st_p_deposit_to = $deposit_to_edit;
                    $st_sales_receipt->st_p_amount = $sales_receipt_amount_received_edit;
                    $st_sales_receipt->save();
                    $product = ProductsAndServices::find($request->input('sales_receipt_EditProductName'.$c));
                    $email_array = explode(',', $email_edit);
        
                    $value[$c-1] = [
                        'type' => 'Sales Receipt',
                        'name' => $customer->display_name,
                        'email' => $email_array,
                        'title' => 'SALES RECEIPT',
                        'note' => '',
                        'memo' => '',
                        'product_name' =>!empty($product)? $product->product_name : '',
                        'product_description' => $request->input('sales_receipt_EditProductDesc'.$c),
                        'product_quantity' => $request->input('sales_receipt_EditProductQty'.$c),
                        'product_rate' =>  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c)),
                        'product_total' => $request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c)),
                        'credit_total' => $sales_receipt_amount_received_edit,
                    ];
                }
            }
            else{
                if($request->input('sales_receipt_EditProductName'.$c)!=""){
                    $st_sales_receipt =new  StSalesReceipt;
                    $st_sales_receipt->st_s_no = $transaction_id_edit;
                    $st_sales_receipt->st_s_product = $request->input('sales_receipt_EditProductName'.$c);
                    $st_sales_receipt->st_s_desc = $request->input('sales_receipt_EditProductDesc'.$c);
                    $st_sales_receipt->st_s_qty = $request->input('sales_receipt_EditProductQty'.$c);
                    $st_sales_receipt->st_s_rate =  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                    $st_sales_receipt->st_s_total = $request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                    $st_sales_receipt->st_p_method = $payment_method_edit;
                    $st_sales_receipt->st_p_reference_no = $reference_no_edit;
                    $st_sales_receipt->st_p_deposit_to = $deposit_to_edit;
                    $st_sales_receipt->st_p_amount = $sales_receipt_amount_received_edit;
                    $st_sales_receipt->save();
                    $product = ProductsAndServices::find($request->input('sales_receipt_EditProductName'.$c));
                    $email_array = explode(',', $email_edit);
        
                    $value[$c-1] = [
                        'type' => 'Sales Receipt',
                        'name' => $customer->display_name,
                        'email' => $email_array,
                        'title' => 'SALES RECEIPT',
                        'note' => '',
                        'memo' => '',
                        'product_name' => !empty($product)? $product->product_name : '',
                        'product_description' => $request->input('sales_receipt_EditProductDesc'.$c),
                        'product_quantity' => $request->input('sales_receipt_EditProductQty'.$c),
                        'product_rate' =>  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c)),
                        'product_total' => $request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c)),
                        'credit_total' => $sales_receipt_amount_received_edit,
                    ];
                }
            
            }

           

        }
        
        if($send_later_edit=="yes"){
            Mail::send(['text'=>'mail'], $value, function($message) use ($value)
            {
                $company = Company::first();
                $sales = Sales::first();
                $expenses = Expenses::first();
                $advance = Advance::first();
                
                $pdf = PDF::loadView('credit_note_pdf',compact('value', 'company', 'sales','expenses','advance'));
                $attachment = $pdf->stream('credit_notice.pdf');
                $message->attachData($attachment, 'credit_note.pdf');
    
                $message->to($value[0]['email'],'Hello Mr/Mrs '.$value[0]['name'])->subject('This is a Sales Receipt for '.$value[0]['name']);
                $message->from('floydignified@gmail.com','Floyd Matabilas');
            });
        } 
        for($c=1;$c<=$request->columncounteditsales_receipt_;$c++){
            if($request->input('sales_receipt_EditProductName'.$c)!=""){
                DB::table('journal_entries')->where('je_no', $transaction_id_edit)->delete();
                $c=$request->columncounteditsales_receipt_+1;
            }

        }
        for($c=1;$c<=$request->columncounteditsales_receipt_;$c++){
            if($request->input('sales_receipt_EditProductName'.$c)!=""){
                $JDate=$date_edit;
                $JNo=$transaction_id_edit;
                $JMemo=$memo_edit;
                $account="Cash and cash equivalents";
                $debit= $request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                $credit= "";
                $description=$request->input('sales_receipt_EditProductDesc'.$c);
                $name= $customer->f_name." ".$customer->l_name;
                

                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id = "1";
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Sales Receipt";
                $journal_entries->je_cost_center=$request->CostCenterSalesReceiptEdit;
                $journal_entries->save();

                $JDate=$date_edit;
                $JNo=$transaction_id_edit;
                $JMemo=$memo_edit;
                $account="Sales";
                $debit= "";
                $credit=$request->input('sales_receipt_EditProductQty'.$c) *  preg_replace("/[^0-9\.]/", "", $request->input('sales_receipt_EditProductRate'.$c));
                $description=$request->input('sales_receipt_EditProductDesc'.$c);
                $name= $customer->f_name." ".$customer->l_name;
                

                $journal_entries = new  JournalEntry;
                $journal_entries_count=JournalEntry::count()+1;
                $journal_entries->je_id = "2";
                $journal_entries->je_no=$JNo;
                $journal_entries->je_account=$account;
                $journal_entries->je_debit=$debit;
                $journal_entries->je_credit=$credit;
                $journal_entries->je_desc=$description;
                $journal_entries->je_name=$name;
                $journal_entries->je_memo=$JMemo;
                $journal_entries->created_at=$JDate;
                $journal_entries->created_at=$JDate;
                $journal_entries->je_transaction_type="Sales Receipt";
                $journal_entries->je_cost_center=$request->CostCenterSalesReceiptEdit;
                $journal_entries->save();
            }

        }
        
        return redirect('Journal_Summary');
    }
}
